## Проверка окружения разработки

### При начале работы в чате

**ОБЯЗАТЕЛЬНО** выполнить проверку окружения в следующем порядке:

#### 1. Определение текущей машины

1. Прочитать `docs/project/project-docs.json` → секцию `development.environments`
2. Получить информацию о текущей машине:
   - `hostname` (через команду `hostname`)
   - `os` (через команду `uname -a` или `cat /etc/os-release`)
3. Сопоставить с машинами из `machines` по:
   - `hostname_pattern` (regex)
   - `os_pattern` (regex)
   - Дополнительные проверки (контейнер, служба)
4. Если машина найдена - использовать её конфигурацию
5. Если не найдена - запросить у пользователя выбор машины или создать новую

#### 2. Проверка DBHub (локально в проекте)

**DBHub специфичен для проекта и должен быть установлен локально:**

1. Проверить наличие `.cursor/dbhub/package.json`
2. Если файл отсутствует:
   - Создать директорию: `mkdir -p .cursor/dbhub`
   - Инициализировать npm: `npm init -y` в `.cursor/dbhub`
   - Установить DBHub: `npm install @bytebase/dbhub --prefix .cursor/dbhub`
3. Проверить наличие файла:
   - `.cursor/dbhub/node_modules/@bytebase/dbhub/dist/index.js`
4. Если файл отсутствует - выполнить установку

#### 3. Проверка SQL Server

**В зависимости от типа БД из конфигурации машины:**

**Для Docker (`database.type === "docker"`):**
1. Проверить статус контейнера: `docker ps --filter name={container_name}`
2. Если контейнер не запущен - запустить: `docker start {container_name}`
3. Проверить доступность порта: `timeout 2 bash -c 'cat < /dev/null > /dev/tcp/{host}/{port}'`

**Для службы (`database.type === "local_service"`):**
1. Проверить статус службы (Windows): `powershell.exe -Command "Get-Service -Name {service_name}"`
2. Если служба остановлена - запустить: `powershell.exe -Command "Start-Service {service_name}"`
3. Проверить доступность порта

**Для удаленного сервера:**
1. Проверить доступность хоста и порта
2. Проверить подключение с учетными данными

#### 4. Обновление `.cursor/mcp.json`

**ВАЖНО: Обновлять ТОЛЬКО секцию `dbhub`, остальные MCP серверы НЕ трогать!**

1. Прочитать текущий `.cursor/mcp.json`
2. Обновить секцию `dbhub`:
   ```json
   {
     "dbhub": {
       "command": "node",
       "args": [
         "${workspaceFolder}/.cursor/dbhub/node_modules/@bytebase/dbhub/dist/index.js"
       ],
       "env": {
         "NODE_ENV": "production",
         "DSN": "{database.connection_string из конфигурации машины}",
         "TRANSPORT": "stdio"
       }
     }
   }
   ```
3. Сохранить файл
4. **НЕ изменять** секции `desktop-commander`, `fedoc` и другие

#### 5. Сообщение пользователю

После проверки сообщить:
- ✅ Какая машина определена
- ✅ Статус DBHub (установлен/установлен заново)
- ✅ Статус SQL Server (запущен/запущен/ошибка)
- ✅ Обновлен ли `.cursor/mcp.json`
- ⚠️ Обнаруженные проблемы и рекомендации

### Шаблон выполнения проверки

```markdown
## Проверка окружения

1. [ ] Читаю project-docs.json
2. [ ] Определяю текущую машину
3. [ ] Проверяю DBHub в .cursor/dbhub/
4. [ ] Проверяю SQL Server
5. [ ] Обновляю .cursor/mcp.json (только dbhub)
6. [ ] Сообщаю результаты
```

### Исключения

- Если пользователь явно просит не выполнять проверку - пропустить
- Если проект только что клонирован - выполнить полную проверку и установку
- Если машина не определена - запросить у пользователя
