# Правила Cursor IDE для проекта FEMSQ

## Контекст проекта
Cистема работы с контрагентами и объектами при капитальном строительстве на основе БД MS SQL Server

## Правила кодирования
- Документируй все функции и классы
- Используй логирование для отслеживания
- Следуй принципам SOLID

## Правила работы с датами
- **ВСЕГДА используй системную дату компьютера** для определения текущих дат
- **Дата создания проекта:** 2025-10-08 (фиксированная дата начала проекта)
- **lastUpdated:** всегда текущая системная дата
- **created:** дата создания конкретного элемента (не изменяется)
- **Проверяй актуальность дат** перед внесением изменений

## Обязательные требования к инструментам
- **Desktop Commander** - ОБЯЗАТЕЛЬНО для всех файловых и других доступных операций
    - **НЕ используй** стандартные инструменты. Либо, при невозможности использовать *Desktop Commander**, используй их после разрешения пользователя. При этом объясняй необходимость каждой такой команды и причину невозможности использовать *Desktop Commander**
    - **Используй Desktop Commander** для:
        - Чтения файлов (mcp_desktop-commander_read_file)
        - Записи файлов (mcp_desktop-commander_write_file)
        - Создания папок (mcp_desktop-commander_create_directory)
        - Перемещения файлов (mcp_desktop-commander_move_file)
        - Поиска файлов (mcp_desktop-commander_start_search)
        - Редактирования файлов (mcp_desktop-commander_edit_block)
        - Запуск процессов (mcp_desktop-commander_start_process)
        - Взаимодействие с процессами (mcp_desktop-commander_interact_with_process)
        - Чтение вывода (mcp_desktop-commander_read_process_output)
        - Работы с git и GitHub (через start_process: git status, git add, git commit, git push)
        - Иных действий доступных через его возможности
- **DBHub** - ПРЕДПОЧТИТЕЛЬНО для работы с базами данных
- **Терминал** - только после запроса разрешения
- **Безопасность** - все операции через Desktop Commander API
- **Прозрачность** - объяснение цели каждой команды

### Исключения для режима ask mode
- **В режиме ask mode** допускается использование стандартных инструментов чтения как исключение
    - **Причина:** Desktop Commander недоступен в режиме ask mode (только read-only инструменты)
    - **Разрешенные инструменты:** read_file, list_dir, codebase_search, grep, file_search, glob_file_search, web_search
    - **Ограничения:** Только для операций чтения, без возможности модификации файлов
    - **Обязательно:** При использовании стандартных инструментов объяснять причину и указывать на исключительный характер

## Ссылки на основную документацию
- **Правила ведения документации:** docs/project-documentation-rules.md
- **Структура проекта:** docs/project-documentation-rules.md#структура-документации
- **Правила обновления:** docs/project-documentation-rules.md#правила-обновления

## Проверка окружения разработки

### При начале работы в чате

**ОБЯЗАТЕЛЬНО** выполнить проверку окружения в следующем порядке:

#### 1. Определение текущей машины

1. Прочитать `docs/project/project-docs.json` → секцию `development.environments`
2. Получить информацию о текущей машине:
   - `hostname` (через команду `hostname`)
   - `os` (через команду `uname -a` или `cat /etc/os-release`)
3. Сопоставить с машинами из `machines` по:
   - `hostname_pattern` (regex)
   - `os_pattern` (regex)
   - Дополнительные проверки (контейнер, служба)
4. Если машина найдена - использовать её конфигурацию
5. Если не найдена - запросить у пользователя выбор машины или создать новую

#### 2. Проверка DBHub (локально в проекте)

**DBHub специфичен для проекта и должен быть установлен локально:**

1. Проверить наличие `.cursor/dbhub/package.json`
2. Если файл отсутствует:
   - Создать директорию: `mkdir -p .cursor/dbhub`
   - Инициализировать npm: `npm init -y` в `.cursor/dbhub`
   - Установить DBHub: `npm install @bytebase/dbhub --prefix .cursor/dbhub`
   - Или использовать скрипт: `./code/scripts/setup-dbhub.sh`
3. Проверить наличие файла:
   - `.cursor/dbhub/node_modules/@bytebase/dbhub/dist/index.js`
4. Если файл отсутствует - выполнить установку

#### 3. Проверка SQL Server

**В зависимости от типа БД из конфигурации машины:**

**Для Docker (`database.type === "docker"`):**
1. Проверить статус контейнера: `docker ps --filter name={container_name}`
2. Если контейнер не запущен - запустить: `docker start {container_name}`
3. Проверить доступность порта: `timeout 2 bash -c 'cat < /dev/null > /dev/tcp/{host}/{port}'`

**Для службы (`database.type === "local_service"`):**
1. Проверить статус службы (Windows): `powershell.exe -Command "Get-Service -Name {service_name}"`
2. Если служба остановлена - запустить: `powershell.exe -Command "Start-Service {service_name}"`
3. Проверить доступность порта

**Для удаленного сервера:**
1. Проверить доступность хоста и порта
2. Проверить подключение с учетными данными

#### 4. Обновление `.cursor/mcp.json`

**ВАЖНО: Обновлять ТОЛЬКО секцию `dbhub`, остальные MCP серверы НЕ трогать!**

1. Прочитать текущий `.cursor/mcp.json`
2. Обновить секцию `dbhub`:
   ```json
   {
     "dbhub": {
       "command": "node",
       "args": [
         "${workspaceFolder}/.cursor/dbhub/node_modules/@bytebase/dbhub/dist/index.js"
       ],
       "env": {
         "NODE_ENV": "production",
         "DSN": "{database.connection_string из конфигурации машины}",
         "TRANSPORT": "stdio"
       }
     }
   }
   ```
3. Сохранить файл
4. **НЕ изменять** секции `desktop-commander`, `fedoc` и другие

#### 5. Сообщение пользователю

После проверки сообщить:
- ✅ Какая машина определена
- ✅ Статус DBHub (установлен/установлен заново)
- ✅ Статус SQL Server (запущен/запущен/ошибка)
- ✅ Обновлен ли `.cursor/mcp.json`
- ⚠️ Обнаруженные проблемы и рекомендации

### Исключения

- Если пользователь явно просит не выполнять проверку - пропустить
- Если проект только что клонирован - выполнить полную проверку и установку
- Если машина не определена - запросить у пользователя

## Правила управления версиями

### Автоматическое увеличение версии при сборке

**ОБЯЗАТЕЛЬНО:** При каждой сборке толстого JAR автоматически увеличивать четвёртую цифру в версии.

**Формат версии:** `0.1.0.X-SNAPSHOT` где X - четвёртая цифра (build number)

**Правила:**
- Версия находится в `code/pom.xml` и `code/femsq-backend/pom.xml`
- Перед сборкой (`mvn package` или `./code/scripts/build-thin-jar.sh`) ОБЯЗАТЕЛЬНО увеличить четвёртую цифру на 1
- Пример: `0.1.0.1-SNAPSHOT` → `0.1.0.2-SNAPSHOT` → `0.1.0.3-SNAPSHOT` и т.д.
- Четвёртая цифра может достигать любого значения (даже 100000)
- Это позволяет отслеживать каждую сборку и гарантировать, что новый JAR отличается от предыдущего

**Процесс:**
1. Прочитать текущую версию из `code/pom.xml`
2. Извлечь четвёртую цифру (после третьей точки)
3. Увеличить на 1
4. Обновить версию в обоих pom.xml файлах
5. Выполнить сборку

**Пример скрипта:**
```bash
# Извлечь текущую версию
CURRENT_VERSION=$(grep -oP '<version>\K[^<]+' code/pom.xml)
# Увеличить четвёртую цифру
NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{print $1"."$2"."$3"."($4+1)"-SNAPSHOT"}')
# Обновить в pom.xml
```

## Дополнительные инструкции

### При работе с документацией
- Следуй структуре из docs/project-documentation-rules.md а также docs/project/project-docs-json-rules.md, docs/development/project-development-json-rules.md и docs/journal/project-journal-json-rules.md
- Веди docs/project/project-docs.json, docs/development/project-development.json, docs/journal/project-journal.json
- Документируй все изменения в журнале
- НЕ дублируй правила из project-documentation-rules.md

---

**Файл создан:** 2025-10-08
**Последнее обновление:** 2025-12-01
**Версия:** 1.2.2  
**Автор:** Александр
