# Стратегия развёртывания отчётов FEMSQ

**Дата:** 2025-11-28  
**Версия:** 1.0  
**Статус:** Утверждено

## Обзор

Данный документ описывает стратегию развёртывания и обновления отчётов в приложении FEMSQ.

## Принципы

### 1. Двойное хранение в JAR

В стандартной поставке приложения (fat JAR) включаются **оба типа файлов**:

- **`.jasper`** - скомпилированные отчёты для работы приложения
- **`.jrxml`** - исходные файлы для справки и доработки

**Преимущества:**
- `.jasper` файлы обеспечивают работу приложения без компиляции
- `.jrxml` файлы всегда под рукой для доработки
- Размер файлов небольшой (4-12 KB для `.jrxml`, 16-20 KB для `.jasper`)
- Не требует дополнительной инфраструктуры

### 2. Приоритет загрузки

Приложение загружает отчёты в следующем порядке:

1. **Внешняя директория** (если настроена) - для пользовательских отчётов
2. **`.jasper` файлы** из JAR (предкомпилированные)
3. **`.jrxml` файлы** из JAR (fallback, если `.jasper` не найден)

Это обеспечивает:
- Работу приложения из коробки (`.jasper` в JAR)
- Возможность обновления отчётов без пересборки (внешняя директория)
- Гибкость при разработке (`.jrxml` как fallback)

## Структура файлов

### В JAR (стандартная поставка)

```
BOOT-INF/classes/reports/embedded/
├── my-new-report.jasper          # Скомпилированный отчёт (для работы)
├── my-new-report.jrxml           # Исходный файл (для справки)
├── my-new-report.json            # Метаданные отчёта
├── my-new-report-sr-ag.jasper    # Скомпилированный подотчёт
├── my-new-report-sr-ag.jrxml     # Исходный файл подотчёта
└── metadata.json                 # Общий каталог отчётов
```

### Внешняя директория (для пользовательских отчётов)

```
<external-reports-dir>/
├── custom-report.jasper          # Пользовательский отчёт
└── custom-report.json             # Метаданные (опционально)
```

## Процесс добавления/обновления отчёта

### Вариант 1: Разработка нового отчёта

1. **Разработка в Jaspersoft Studio 7.0.3**
   - Создать новый отчёт или открыть существующий `.jrxml` из JAR
   - Разработать/доработать отчёт
   - Протестировать в Preview

2. **Компиляция**
   - В Jaspersoft Studio: `Project → Compile Report` или `Ctrl+Shift+C`
   - Получить `.jasper` файл

3. **Размещение**
   - **Для стандартной поставки:** добавить `.jasper` и `.jrxml` в `src/main/resources/reports/embedded/`
   - **Для пользовательского отчёта:** скопировать `.jasper` в внешнюю директорию приложения

4. **Метаданные**
   - Обновить `metadata.json` (для встроенных отчётов)
   - Или создать отдельный `.json` файл (для внешних отчётов)

### Вариант 2: Обновление существующего отчёта

1. **Извлечение исходника**
   - Извлечь `.jrxml` из JAR (если нужно)
   - Или взять из репозитория проекта

2. **Доработка**
   - Открыть в Jaspersoft Studio 7.0.3
   - Внести изменения
   - Протестировать

3. **Компиляция и размещение**
   - Скомпилировать в Studio
   - Разместить `.jasper` во внешней директории (приоритет над JAR)
   - Или обновить в репозитории и пересобрать JAR

## Конфигурация

### Встроенные отчёты

```yaml
femsq:
  reports:
    embedded:
      path: "classpath:reports/embedded"
```

### Внешние отчёты

```yaml
femsq:
  reports:
    external:
      enabled: true
      path: "./reports/external"  # Относительно рабочей директории
```

## Размеры файлов

Типичные размеры отчётов:

- **`.jrxml`**: 4-12 KB (исходный XML)
- **`.jasper`**: 16-20 KB (скомпилированный байт-код)
- **`.json`**: 0.5-1 KB (метаданные)

**Итого для одного отчёта:** ~25-35 KB

Для стандартной поставки с одним отчётом (`my-new-report` + `my-new-report-sr-ag`):
- **`.jasper`**: ~36 KB
- **`.jrxml`**: ~12 KB
- **`.json`**: ~1 KB
- **Итого:** ~49 KB

## Преимущества подхода

### ✅ Для разработки

- Исходники всегда доступны в JAR
- Не нужно искать `.jrxml` в отдельном репозитории
- Легко извлечь и доработать отчёт

### ✅ Для эксплуатации

- Приложение работает из коробки (`.jasper` в JAR)
- Можно обновлять отчёты без пересборки (внешняя директория)
- Пользователь может доработать отчёт на основе исходника из JAR

### ✅ Для поддержки

- Все версии отчётов в одном месте (JAR)
- Легко отследить изменения через git
- Можно восстановить любой отчёт из истории

## Ограничения

1. **Ручная компиляция**
   - Отчёты компилируются вручную в Jaspersoft Studio
   - Нет автоматической компиляции при сборке

2. **Версионность**
   - Нужно следить за соответствием `.jasper` и `.jrxml`
   - Рекомендуется коммитить оба файла вместе

3. **Зависимость от Studio**
   - Для компиляции нужна Jaspersoft Studio 7.0.3
   - Нельзя скомпилировать через командную строку без настройки

## Рекомендации

### Для разработчиков

1. **Всегда коммитить оба файла** (`.jasper` + `.jrxml`)
2. **Обновлять `metadata.json`** при добавлении новых отчётов
3. **Тестировать отчёты** в Jaspersoft Studio перед коммитом

### Для пользователей

1. **Использовать внешнюю директорию** для пользовательских отчётов
2. **Сохранять исходники** (`.jrxml`) отдельно для доработки
3. **Документировать изменения** в пользовательских отчётах

### Для администраторов

1. **Резервное копирование** внешней директории с отчётами
2. **Версионирование** пользовательских отчётов
3. **Мониторинг** размера директории с отчётами

## Миграция существующих отчётов

Если в проекте есть только `.jrxml` файлы:

1. Открыть каждый `.jrxml` в Jaspersoft Studio 7.0.3
2. Скомпилировать (`Project → Compile Report`)
3. Сохранить `.jasper` рядом с `.jrxml`
4. Добавить оба файла в репозиторий

## См. также

- [Jaspersoft Studio Guide](../development/jaspersoft-studio-guide.md) - руководство по работе с Studio
- [JAR Lifecycle](./jar-lifecycle.md) - жизненный цикл JAR файлов
- [Runtime Compilation Analysis](../notes/runtime-compilation-analysis.md) - анализ проблемы компиляции


