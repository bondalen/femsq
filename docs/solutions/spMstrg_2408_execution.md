# Решение проблемы таймаута выполнения процедуры spMstrg_2408

**Дата создания:** 2025-12-04  
**Автор:** AI Assistant  
**Статус:** Реализовано и протестировано

## Проблема

Хранимая процедура `ags.spMstrg_2408` возвращает 6 рекордсетов с результатами анализа инвестиционных программ. Время выполнения процедуры превышает 15 секунд, что является ограничением DBHub (@bytebase/dbhub) для выполнения SQL-запросов через MCP-сервер.

## Анализ возможностей DBHub

### Ограничения DBHub
- **Фиксированный таймаут:** 15 секунд на выполнение запроса
- **Невозможно изменить:** Таймаут захардкожен в коде DBHub и не настраивается
- **Ограничение MCP:** Все MCP-серверы имеют схожие ограничения по времени выполнения

## Предложенное решение: Модифицированная процедура + sqlcmd

**Преимущества:**
- ✅ Настраиваемый таймаут (установлен на 10 минут / 600 секунд)
- ✅ Сохранение всех результатов в таблицы для последующего анализа
- ✅ Возможность выполнения на любой машине с MS SQL Server Tools
- ✅ Логирование процесса выполнения и времени каждого шага

## Использование

### Запуск процедуры

```bash
cd /home/alex/projects/java/spring/vue/femsq/code/scripts
./execute_spMstrg_2408.sh
```

Скрипт автоматически:
- Создаст процедуру `ags.spMstrg_2408_SaveToTables`
- Выполнит её с параметрами `@ipgCh=15, @MounthEndDate='2025-07-31'`
- Проверит результаты

### Проверка результатов через DBHub

```sql
SELECT 
    'ResultSet1' AS TableName,
    COUNT(*) AS RecordCount,
    MIN(dateRslt) AS MinDate,
    MAX(dateRslt) AS MaxDate
FROM ags.spMstrg_2408_ResultSet1;
```

## Реализация

### Созданные таблицы

Процедура `ags.spMstrg_2408_SaveToTables` заполняет 6 таблиц:

1. **`ags.spMstrg_2408_ResultSet1`** (179 столбцов)
   - Полный набор данных из функции `fnIpgChRsltCstUtlPercentBrn_2408`
   - Все схемы реализации: агентская, инвестиционная, неизвестная, неплан, прочие
   - **Количество записей:** 12693

2. **`ags.spMstrg_2408_ResultSet2`** (179 столбцов)
   - Переупорядоченные столбцы: сначала ag_, затем iv_, ia_
   - Те же данные, что в ResultSet1, но с другим порядком столбцов
   - **Количество записей:** 12693

3. **`ags.spMstrg_2408_ResultSet3`** (220 столбцов)
   - Столбцы без префиксов ag_, iv_, ia_: np_, uk_, oh_ и общие
   - Данные для неплановых, неизвестных и прочих затрат
   - **Количество записей:** 12693

4. **`ags.spMstrg_2408_ResultSet4`** (44 столбца)
   - Данные с JOIN для трёх месяцев: текущий, предыдущий, предпредыдущий
   - Фильтрация по `dateRslt = @MounthEndDate`
   - Используется табличная переменная `@TableFnIpgChRsltCstUtlPercentBrnRep01_2408`
   - **Количество записей:** 744 (зависит от даты)

5. **`ags.spMstrg_2408_ResultSet5`** (44 столбца)
   - Данные из ResultSet4 с фильтрацией `WHERE cstAgPnCode = 'всего'`
   - UNION с разделительной строкой ('агентская_', 'Заказчики')
   - Сортировка: `ORDER BY ipgSh, limSort DESC, lim DESC`
   - **Количество записей:** 32 (31 + 1 разделительная строка)

6. **`ags.spMstrg_2408_ResultSet6`** (51 столбец)
   - Данные с источниками освоения (ag_accepted, ag_agFeeAccepted, np_accepted и т.д.)
   - Фильтрация по `dateRslt = @MounthEndDate` и `cstAgPnCode = 'всего'`
   - Используется табличная переменная `@TableFnIpgChRsltCstUtlPercentBrnRepSrc01_2408`
   - UNION с разделительной строкой
   - Сортировка: `ORDER BY ipgSh, limSort DESC, lim DESC`
   - **Количество записей:** 32 (31 + 1 разделительная строка)

## Результаты тестирования

**Время выполнения:** 126 секунд (2 минуты 6 секунд)

**Время выполнения шагов:**
- Очистка таблиц: 710 мс
- Заполнение временной таблицы: 106140 мс (106 секунд)
- ResultSet1: 2845 мс (2.8 секунды)
- ResultSet2: 2043 мс (2.0 секунды)
- ResultSet3: 2220 мс (2.2 секунды)
- ResultSet4: 11827 мс (11.8 секунд)
- ResultSet5: 41 мс (0.04 секунды)
- ResultSet6: 163 мс (0.16 секунды)

**Результаты:**
- ✅ Все 6 таблиц заполнены данными
- ✅ Целостность данных подтверждена (суммы совпадают между рекордсетами)
- ✅ Фильтрация работает корректно
- ✅ Сортировка работает правильно
- ✅ Процедура работает в пределах таймаута sqlcmd (10 минут)

### Проверка результатов

```sql
-- Проверка количества записей во всех таблицах
SELECT 
    'ResultSet1' AS TableName, COUNT(*) AS RecordCount FROM ags.spMstrg_2408_ResultSet1
UNION ALL SELECT 'ResultSet2', COUNT(*) FROM ags.spMstrg_2408_ResultSet2
UNION ALL SELECT 'ResultSet3', COUNT(*) FROM ags.spMstrg_2408_ResultSet3
UNION ALL SELECT 'ResultSet4', COUNT(*) FROM ags.spMstrg_2408_ResultSet4
UNION ALL SELECT 'ResultSet5', COUNT(*) FROM ags.spMstrg_2408_ResultSet5
UNION ALL SELECT 'ResultSet6', COUNT(*) FROM ags.spMstrg_2408_ResultSet6;
```

---

**Дата последнего обновления:** 2025-12-04
