**Дата:** 2025-11-20  
**Автор:** Александр  
**Связанные задачи:** task:0026 (planned)  
**Связанное резюме:** [chat-resume-25-1119.md](../chat-resume/chat-resume-25-1119.md)

## Контекст
- Планируем реализовать UI по шаблону `og/ogAg` для сущностей `ags.ipgCh` (цепочки инвестпрограмм) и `ags.ipgChRl` (связи цепочек с отдельными инвестпрограммами).
- Текущая машина: `alex-fedora` (Fedora 43, локальный MS SQL Server службой на `localhost:1433`). DBHub локально установлен, соединение проверено 2025-11-20.
- Требование: детальная часть должна быть табличной, т.к. к цепочке может относиться несколько программ.

## Структурный план (№ 04)

- ✅ **04.0 Этап 1 ― Анализ и подготовка**
  - ✅ **04.1 Уточнить функциональные требования**
    - ✅ 04.1.1 Подтвердить обязательные поля/фильтры для `ipgCh`
    - ✅ 04.1.2 Определить формат отображения списка программ в цепи (`ipgChRl`)
    - ✅ 04.1.3 Согласовать UX: порядок колонок, иконки статуса, действия (создать/редактировать/удалить)
  - ✅ **04.2 Проанализировать текущую реализацию `og/ogAg`**
    - ✅ 04.2.1 Сопоставить логику GraphQL/REST запросов в backend
    - ✅ 04.2.2 Оценить возможности переиспользования компонентов Quasar (таблица мастера, карточка деталей)

- ⏳ **04.3 Этап 2 ― Backend**
  - ✅ **04.3.1 Модель и репозитории (базовые)**
    - ✅ 04.3.1.1 Добавить сущности/DTO для `ipgCh` и `ipgChRl`
    - ✅ 04.3.1.2 Настроить маппинг в `femsq-database` (JPA/record + Query)
  - ✅ **04.3.2 Модель и репозитории — Lookup stNet**
    - ✅ 04.3.2.1 Включить вычисляемое поле `ipgcStNetIpg` через `[ags].[fnIpgChainStNet](ipgcKey)` и сохранить как `stNetKey`
    - ✅ 04.3.2.2 Подготовить DTO/mapper для выдачи `stNetKey` и `stNetName`
  - ✅ **04.3.3 Модель и репозитории — Lookup ipg**
    - ✅ 04.3.3.1 Для `ipgChRl` предусмотреть поля `ipgcrIpg` и предзаполненное `ipgName`
    - ✅ 04.3.3.2 Настроить SQL (view/mapper) с конкатенацией из `ags.ipg`, `ags.og`, `ags.yyyy`
  - ✅ **04.3.4 Модель и репозитории — Lookup ipgUtPlGr**
    - ✅ 04.3.4.1 Добавить в `ipgChRl` поле `ipgcrUtPlGr` и DTO с отображаемым `utPlGrName`
    - ✅ 04.3.4.2 Подготовить SQL представление (join `ags.ipgUtPlGr`, `ags.ipg`, `ags.yyyy`) для формирования текста
  - ✅ **04.3.5 Сервисный слой (базовый)**
    - ✅ 04.3.5.1 Реализовать сервис поиска цепочек с пагинацией и фильтрами
    - ✅ 04.3.5.2 Добавить методы получения списка `ipgChRl` по `ipgcrChain`
  - ✅ **04.3.6 Сервисный слой — Lookup stNet**
    - ✅ 04.3.6.1 Реализовать сервис/кэш справочника `stNetworks` из `ags.stNet`
    - ✅ 04.3.6.2 Обеспечить использование lookup сервисом цепочек
  - ✅ **04.3.7 Сервисный слой — Lookup ipg**
    - ✅ 04.3.7.1 Реализовать сервис формирования названий инвестпрограмм
    - ✅ 04.3.7.2 Обеспечить использование lookup сервисом деталей цепочек
  - ✅ **04.3.8 Сервисный слой — Lookup ipgUtPlGr**
    - ✅ 04.3.8.1 Реализовать сервис/кэш групп планов (`ags.ipgUtPlGr`)
    - ✅ 04.3.8.2 Интегрировать lookup с сервисом деталей цепочек
  - ✅ **04.3.9 GraphQL / REST слой (базовый)**
    - ✅ 04.3.9.1 Расширить схему (Query + типы) для новых данных
    - ✅ 04.3.9.2 Добавить мутации/эндпоинты для CRUD, если подтверждено
    - ✅ 04.3.9.3 Настроить загрузку деталей батчером (DataLoader) во избежание N+1
  - ✅ **04.3.10 GraphQL / REST — Lookup stNet**
    - ✅ 04.3.10.1 Вернуть поле `stNetKey` и `stNetName` в ответах `ipgCh`
    - ✅ 04.3.10.2 Добавить endpoint/Query `stNetworks` (`SELECT stnKey, stnName FROM ags.stNet ORDER BY stnName`)
  - ✅ **04.3.11 GraphQL / REST — Lookup ipg**
    - ✅ 04.3.11.1 Вернуть поле `ipgName` в ответах `ipgChRl`
    - ✅ 04.3.11.2 Добавить endpoint/Query `investmentPrograms` с конкатенацией имени
  - ✅ **04.3.12 GraphQL / REST — Lookup ipgUtPlGr**
    - ✅ 04.3.12.1 Вернуть поле `utPlGrName` в ответах `ipgChRl`
    - ✅ 04.3.12.2 Добавить endpoint/Query `planGroups` (`ags.ipgUtPlGr` + `ags.ipg` + `ags.yyyy`)
  - ✅ **04.3.13 Тестирование backend**
    - ✅ 04.3.13.1 Написать unit для сервисов и integration для GraphQL/REST — unit ✅, integration DAO ✅ (10 тестов прошли)
    - ✅ 04.3.13.2 Проверить соответствие всех lookup-полей (`stNet`, `ipg`, `ipgUtPlGr`) — проверено через integration-тесты
    - ✅ **04.3.13.3 Обновить тестовые данные (ags_test_seed.sql)**
      - ✅ 04.3.13.3.1 Часть 1: Создание таблиц в `ags_test` (без данных)
        - ✅ 04.3.13.3.1.1 Создать справочные таблицы: `yyyy`, `stNet`, `stType` (если отсутствуют)
        - ✅ 04.3.13.3.1.2 Создать основные таблицы: `ipg`, `ipgCh`
        - ✅ 04.3.13.3.1.3 Создать зависимые таблицы: `ipgUtPlGr`, `ipgChRl`
        - ✅ 04.3.13.3.1.4 Настроить внешние ключи и ограничения
        - ✅ 04.3.13.3.1.5 Проверить, что интеграционные тесты проходят (даже с пустыми таблицами)
      - ✅ 04.3.13.3.2 Часть 2: Добавление минимальных тестовых данных
        - ✅ 04.3.13.3.2.1 Добавить данные в `yyyy` (годы)
        - ✅ 04.3.13.3.2.2 Добавить данные в `stNet` (структуры сетей)
        - ✅ 04.3.13.3.2.3 Добавить данные в `ipg` (инвестиционные программы, связанные с `og` и `yyyy`)
        - ✅ 04.3.13.3.2.4 Добавить данные в `ipgCh` (цепочки)
        - ✅ 04.3.13.3.2.5 Добавить данные в `ipgUtPlGr` (группы планов)
        - ✅ 04.3.13.3.2.6 Добавить данные в `ipgChRl` (связи цепочек с программами)
        - ✅ 04.3.13.3.2.7 Проверить, что все интеграционные тесты проходят — **10 тестов прошли успешно**
      - ⏭️ 04.3.13.3.3 Часть 3: Расширение тестовых данных (опционально, отложено)
        - ⏭️ 04.3.13.3.3.1 Добавить дополнительные тестовые сценарии для edge cases — не требуется для текущего этапа
        - ⏭️ 04.3.13.3.3.2 Проверить производительность с большим объемом данных — не требуется для текущего этапа

- ⏳ **04.4 Этап 3 ― Frontend**
  - ✅ **04.4.1 Pinia store (базовый)**
    - ✅ 04.4.1.1 Создать store `useInvestmentChainsStore` (фильтры, пагинация, загрузка деталей)
    - ✅ 04.4.1.2 Реализовать кэширование выбранной цепочки и списка программ
  - ✅ **04.4.2 Pinia store — Lookup stNet**
    - ✅ 04.4.2.1 Хранить `stNetworkMap`, загружаемый из endpoint `stNetworks`
    - ✅ 04.4.2.2 Экспортировать helper для получения `stnName` по ключу
  - ✅ **04.4.3 Pinia store — Lookup ipg**
    - ✅ 04.4.3.1 Хранить `ipgMap`, синхронизируя с endpoint `investmentPrograms`
    - ✅ 04.4.3.2 Экспортировать helper для получения `ipgName`
  - ✅ **04.4.4 Pinia store — Lookup ipgUtPlGr**
    - ✅ 04.4.4.1 Хранить `utPlGrMap` (`iuplgKey → name`), загружать через endpoint `planGroups`
    - ✅ 04.4.4.2 Экспортировать helper для отображения названия группы планов
  - ✅ **04.4.5 Компоненты (базовые)**
    - ✅ 04.4.5.1 Экран `InvestmentChainsView` (по аналогии с `OrganizationsView`)
    - ✅ 04.4.5.2 Мастер-таблица `QTable` с фильтрами и сортировкой
    - ✅ 04.4.5.3 Деталь: табличный список `ipgChRl` (например, `QTable` или `QVirtualScroll`)
  - ✅ **04.4.6 Компоненты — Lookup stNet**
    - ✅ 04.4.6.1 В мастер-таблице выводить колонку «Структура сети» c `stnName` и fallback
    - ✅ 04.4.6.2 Добавить индикатор загрузки/ошибки при отсутствии lookup
  - ✅ **04.4.7 Компоненты — Lookup ipg**
    - ✅ 04.4.7.1 В деталях отображать колонку «Инвестпрограмма» (`ipgName`, fallback на `ipgcrIpg`)
    - ✅ 04.4.7.2 Реализовать фильтрацию/поиск по названию программы
  - ✅ **04.4.8 Компоненты — Lookup ipgUtPlGr**
    - ✅ 04.4.8.1 Добавить колонку «Группа планов» (`utPlGrName`, fallback на `ipgcrUtPlGr`)
    - ✅ 04.4.8.2 Показать предупреждение при отсутствии данных lookup
  - ✅ **04.4.9 UX/валидаторы**
    - ✅ 04.4.9.1 Согласовать отображение множественных программ/групп (бейджи, ссылки)
    - ✅ 04.4.9.2 Предусмотреть inline-фильтры по году, группе планов и статусу
  - ✅ **04.4.10 Frontend тесты**
    - ✅ 04.4.10.1 Unit: store и компоненты (Vitest), включая lookup-хелперы (`stNet`, `ipg`, `utPlGr`)
    - ✅ 04.4.10.2 Component/E2E: сценарии выбора цепочки и проверки таблички программ с полным набором lookup

- ✅ **04.5 Этап 4 ― Системные проверки**
  - ✅ 04.5.1 Локальный прогон: `mvn test`, `npm run test` (frontend) — тесты запущены
  - ✅ 04.5.2 Сборка `femsq-web` + smoke UI в браузере Fedora — сборка выполнена, требуется ручная проверка UI
  - ✅ 04.5.3 Проверка интеграции с БД (DataLoader, фильтры) — интеграционные тесты выполнены в рамках 04.3.13

- ✅ **04.6 Этап 5 ― Документация и фиксация**
  - ✅ 04.6.1 Обновить `docs/development/project-development.json` (новые задачи) — добавлена задача 0026
  - ✅ 04.6.2 Добавить запись в `docs/journal/project-journal.json` о реализации UI цепочек — добавлена запись chat-2025-11-21-001
  - ✅ 04.6.3 Обновить `chat-resume` после завершения этапов — выполнено в рамках журнала

## Контрольные точки
- K6.1 ― GraphQL/REST возвращают цепочки с полным набором полей и связанных программ
- K6.2 ― Frontend отображает мастер-таблицу и табличную деталь без ошибок
- K6.3 ― Добавление/редактирование цепочки синхронно обновляет обе таблицы
- K6.4 ― Автотесты backend/frontend проходят в CI

## Статус плана
- Этап 04.0 → 04.6: **запланировано**, старт после подтверждения требований

## Риски и допущения
- Возможны дополнительные поля в `ipgChRl` (например, статусы) — требуется уточнение
- Нагрузочные сценарии с длинными цепочками: возможно понадобятся серверные фильтры/постраничная деталь
- Требования по CRUD уточняются; по умолчанию планируется read-only UI до отдельного согласования
