# Продолжение анализа: Цветовая схема, формулы и layout

## 4. Цветовая схема отчёта

### 4.1 Цвета текста (ForeColor)

#### Основные цвета для данных:
| Цвет | RGB | HEX | Назначение |
|------|-----|-----|------------|
| Тёмно-серый | RGB(64, 64, 64) | #404040 | Основные данные агентской схемы |
| Серый | RGB(127, 127, 127) | #7F7F7F | Заголовки столбцов |
| Синий | RGB(47, 54, 153) | #2F3699 | Данные инвестиционной схемы |
| Красный | RGB(192, 80, 77) | #C0504D | Данные укупорки, ИТОГО |
| Оранжевый | RGB(228, 108, 10) | #E46C0A | Данные предыдущего месяца |
| Зелёный | RGB(79, 98, 40) | #4F6228 | Данные предпредыдущего месяца |
| Чёрный | RGB(0, 0, 0) | #000000 | Месяцы текущего периода |
| Ярко-красный | RGB(255, 0, 0) | #FF0000 | Важные примечания |

#### Цвета по типам данных:

**Агентская схема (префикс `ag_`):**
- Цвет: RGB(64, 64, 64) - тёмно-серый
- Контролы: #29-#34, #37-#41, #44-#46

**Инвестиционная схема (префикс `iv_`):**
- Цвет: RGB(47, 54, 153) - синий
- Контрол: #35 (iv_lim)
- Заголовок: Control #18 ("ИНВЕСТИЦИОННАЯ")

**Укупорка (префикс `uk_`):**
- Цвет: RGB(192, 80, 77) - красный
- Контрол: #36 (uk_lim)
- Заголовок: Control #17 ("ИТОГО")
- Контрол #65 (ag_acceptedNot) - скрытый

**Данные предыдущего месяца (префикс `PrM_`):**
- Цвет: RGB(228, 108, 10) - оранжевый
- Контролы: #43, #47-#54

**Данные предпредыдущего месяца (префикс `PrM_...2`):**
- Цвет: RGB(79, 98, 40) - зелёный
- Контролы: #55-#63

**Название филиала для предыдущего месяца:**
- Цвет: RGB(228, 108, 10) - оранжевый
- Контрол: #64 (branchName)

### 4.2 Цвета фона (BackColor)

#### Фоны заголовков:
| Цвет | RGB | HEX | Назначение |
|------|-----|-----|------------|
| Белый | RGB(255, 255, 255) | #FFFFFF | Основной фон |
| Светло-оранжевый | RGB(253, 234, 218) | #FDEADA | "В разрезе видов контрагентов" (Control #11, #3) |
| Оранжевый | RGB(252, 213, 181) | #FCD5B5 | Раздел с процентами (Control #16) |
| Светло-фиолетовый | RGB(243, 240, 246) | #F3F0F6 | "В том числе за счёт" (Control #21) |
| Светло-голубой | RGB(198, 217, 241) | #C6D9F1 | Линии разделители (Control #28) |

#### Фоны строк данных (VBA):
| Условие | BackColor | RGB | Назначение |
|---------|-----------|-----|------------|
| ogNm = "ИТОГО" | 14020607 | RGB(255, 214, 214) | Светло-розовый для итоговых строк |
| ogNm = "Заказчики" | 14020607 | RGB(255, 214, 214) | Светло-розовый для заказчиков |
| Остальные (чётные) | vbWhite | RGB(255, 255, 255) | Белый |
| Остальные (нечётные) | RGB(242, 242, 242) | #F2F2F2 | Светло-серый для чередования |

**Примечание:** BackColor=14020607 преобразуется в RGB(255, 214, 214)

---

## 5. Вычисляемые поля (с формулами)

### 5.1 Control #38: ag_PlFulfillmentCn
- **ControlSource:** `=IIf([ag_PlFulfillment]<0,Null,[ag_PlFulfillment])`
- **Назначение:** Исполнение плана, но скрывает отрицательные значения (заменяет на NULL)
- **JasperReports эквивалент:**
  ```java
  $F{ag_PlFulfillment} != null && $F{ag_PlFulfillment}.compareTo(BigDecimal.ZERO) < 0 
      ? null 
      : $F{ag_PlFulfillment}
  ```

### 5.2 Control #42: mnCn (Месяц)
- **ControlSource:** `=IIf(IsNull([ag_lim]),Null,[mn])`
- **Назначение:** Месяц, но отображается только если ag_lim не NULL
- **JasperReports эквивалент:**
  ```java
  $F{ag_lim} == null ? null : $F{mn}
  ```
- **Свойства:** CanGrow=True, CanShrink=True (может изменять размер)

### 5.3 Control #43: PrM_mnPreviousCn (Месяц предыдущего периода)
- **ControlSource:** `=IIf(IsNull([ag_lim]),Null,[PrM_mnPrevious])`
- **Назначение:** Месяц предыдущего периода, но только если ag_lim не NULL
- **Цвет:** RGB(228, 108, 10) - оранжевый
- **JasperReports эквивалент:**
  ```java
  $F{ag_lim} == null ? null : $F{PrM_mnPrevious}
  ```
- **Свойства:** CanGrow=True, CanShrink=True

### 5.4 Control #55: Поле440 (Месяц предпредыдущего периода)
- **ControlSource:** `=IIf(IsNull([ag_lim]),Null,[PrM_mnPrevious2])`
- **Назначение:** Месяц предпредыдущего периода, но только если ag_lim не NULL
- **Цвет:** RGB(79, 98, 40) - зелёный
- **JasperReports эквивалент:**
  ```java
  $F{ag_lim} == null ? null : $F{PrM_mnPrevious2}
  ```

---

## 6. Форматирование чисел

### 6.1 Процентные поля (Format = Percent)

| Control | ControlSource | Назначение | DecimalPlaces |
|---------|---------------|------------|---------------|
| #33 | ag_LimPc | % Исполнения сметного лимита | 255 (авто) |
| #39 | ag_PlPz | Исполнение, в % | 255 (авто) |
| #41 | ag_PlPercent | Исполнение в разрезе видов контрагентов, в % | 255 (авто) |
| #46 | ag_PlPz_M | Исполнение (месячное), в % | 255 (авто) |
| #47 | PrM_ag_PlPz_M | Исполнение предыдущего месяца, в % | 255 (авто) |
| #50 | PrM_ag_PlPercent | Исполнение предыдущего периода, в % | 255 (авто) |
| #52 | PrM_ag_PlPz | Исполнение предыдущего, в % | 255 (авто) |
| #58 | Поле448 (PrM_ag_PlPz2) | Исполнение предпредыдущего, в % | 255 (авто) |
| #60 | Поле452 (PrM_ag_PlPercent2) | Исполнение предпредыдущего периода, в % | 255 (авто) |
| #63 | Поле458 (PrM_ag_PlPz_M2) | Исполнение предпредыдущего месяца, в % | 255 (авто) |

**Формат JasperReports:** `##0.0%` или `##0.00%` (1 или 2 знака после запятой)

### 6.2 Числовые поля (без специального формата)

Все остальные поля данных:
- **DecimalPlaces:** 255 (автоматически)
- **Format:** Нет (пустое)
- **JasperReports формат:** `#,##0` (для целых) или `#,##0.00` (для дробных)

**Примеры:**
- ag_lim, iv_lim, uk_lim - лимиты (большие числа)
- ag_PlAccum - план накопленный
- ag_PlFulfillment - исполнение плана
- ag_PlOverFulfillment - перевыполнение плана

---

## 7. Схема Layout отчёта (структура столбцов)

### 7.1 Ширина отчёта
- **Общая ширина:** 23244 twips (410 mm) = **1162 points**
- **Формат:** A3 Landscape
- **A3 Landscape размер:**
  - Ширина: 420 mm = 1191 points
  - Высота: 297 mm = 842 points
- **JasperReports параметры:**
  - pageWidth="1191" (420 mm)
  - pageHeight="842" (297 mm)
  - orientation="Landscape"

**ВАЖНО:** Access отчёт (1162 points) ИДЕАЛЬНО вписывается в A3 Landscape (1191 points)!
- Разница: 1191 - 1162 = **29 points** = **10 mm**
- Поля: **5 mm слева + 5 mm справа**
- Для JasperReports: leftMargin="14" (5 mm), rightMargin="14" (5 mm)
- 14 points ≈ 5 mm (14 × 0.3528 = 4.94 mm)

### 7.2 Высота секций
| Секция | Twips | MM | Points |
|--------|-------|----|----|
| Report Header | 540 | 9.52 | 27 |
| Page Header | 855 | 15.08 | 43 |
| Group Header | 15 | 0.26 | 1 |
| Detail | 1095 | 19.31 | 55 |
| Report Footer | 0 | 0 | 0 |
| **Итого (минимум):** | 2505 | 44.17 | 126 |

**Примечание:** Это минимальная высота для одной строки данных. Реальная высота зависит от количества строк (32 записи).

### 7.3 Структура столбцов (горизонтальный layout)

#### Группа 1: Идентификация (Столбцы 1-2)
| # | Название | x (pt) | width (pt) | Выравнивание | ControlSource |
|---|----------|--------|------------|--------------|---------------|
| 1 | Филиал | 0 | 99 | Left | ogNm |
| 2 | Номер филиала | 99 | 80 | Center | lim |

**Общая ширина группы 1:** 179 points

#### Группа 2: Лимит (Столбец 3, многоуровневый)
| # | Название | x (pt) | width (pt) | Высота (pt) | ControlSource |
|---|----------|--------|------------|-------------|---------------|
| 3a | ЛИМИТ (заголовок) | 178 | 85 | 13 | - |
| 3b | на 2024 г. программ | 178 | 85 | 19 | - |
| 3c | ИНВЕСТИЦИОННАЯ | 178 | 85 | 11 | - |
| 3d | ИТОГО | 178 | 85 | 11 | - |
| 3-data-1 | ag_lim (данные) | 178 | 85 | 9 | ag_lim |
| 3-data-2 | iv_lim (данные) | 178 | 85 | 9 | iv_lim |
| 3-data-3 | uk_lim (данные) | 178 | 85 | 9 | uk_lim |

**Примечание:** Этот столбец имеет три строки данных (ag_, iv_, uk_) в одной ячейке Detail

#### Группа 3: Исполнение сметного лимита (Столбцы 4-6)
| # | Название | x (pt) | width (pt) | Выравнивание | ControlSource |
|---|----------|--------|------------|--------------|---------------|
| 4 | Исполнение сметного лимита | 263 | 77 | Center | ag_Ful_OverFul |
| 5 | % Исполнения сметного лимита | 340 | 46 | Center | ag_LimPc |
| 6 | Превышен лимит бизнес сметного плана | 386 | 74 | Center | ag_PlOverLimit_ |

**Общая ширина группы 3:** 197 points (от 263 до 460)

#### Группа 4: Месяц (Столбец 7)
| # | Название | x (pt) | width (pt) | Выравнивание | ControlSource |
|---|----------|--------|------------|--------------|---------------|
| 7 | Месяц | 460 | 52 | Center | mnCn (вычисляемое) |

#### Группа 5: В разрезе видов контрагентов (Столбцы 8-13)
**Заголовок раздела:**
- x: 512 pt
- width: 436 pt
- BackColor: RGB(253, 234, 218) - светло-оранжевый

| # | Название | x (pt) | width (pt) | Выравнивание | ControlSource | Format |
|---|----------|--------|------------|--------------|---------------|--------|
| 8 | План, в тыс | 512 | 87 | Center | ag_PlAccum | - |
| 9 | Исполнение, в тыс | 599 | 80 | Center | ag_PlFulfillmentCn | - |
| 10 | Исполнение, в % | 680 | 49 | Center | ag_PlPz | Percent |
| 11 | Перевыполнение плана,  в тыс | 728 | 71 | Center | ag_PlOverFulfillment | - |
| 12 | Исполнение в разрезе видов контрагентов,  в тыс | 800 | 80 | Center | ag_PlPercent | Percent |
| 13 | Исполнение в разрезе видов контрагентов,  в % | 880 | 69 | Center | ag_PlPercent | Percent |

**Общая ширина группы 5:** 437 points (от 512 до 949)

#### Группа 6: В том числе за счёт (Столбцы 14-16)
**Заголовок раздела:**
- x: 949 pt
- width: 211 pt
- BackColor: RGB(243, 240, 246) - светло-фиолетовый

| # | Название | x (pt) | width (pt) | Выравнивание | ControlSource | Format |
|---|----------|--------|------------|--------------|---------------|--------|
| 14 | План, в тыс | 949 | 77 | Center | ag_Pl_M | - |
| 15 | Исполнение, в тыс | 1026 | 85 | Center | ag_acceptedTtl_M | - |
| 16 | Исполнение, в % | 1111 | 49 | Center | ag_PlPz_M | Percent |

**Общая ширина группы 6:** 211 points (от 949 до 1160)

**Общая ширина всех групп:** 1160 points (почти совпадает с 1162 points отчёта)

---

## 8. Особенности и рекомендации для реализации

### 8.1 Многоуровневые заголовки
Page Header содержит сложную структуру заголовков с тремя уровнями:
1. **Уровень 1 (верхний):** Разделы "В разрезе видов контрагентов", "В том числе за счёт"
2. **Уровень 2 (средний):** Подзаголовки "ЛИМИТ", "на 2024 г. программ"
3. **Уровень 3 (нижний):** Названия столбцов "ИТОГО", "ИНВЕСТИЦИОННАЯ", "План, в тыс" и т.д.

**Реализация в JasperReports:**
- Использовать несколько `<band>` внутри `pageHeader`
- Или использовать вложенные `<frame>` элементы
- Или использовать `<columnHeader>` для заголовков столбцов

### 8.2 Многострочные ячейки в Detail
Столбец "Лимит" (x=178) содержит три значения в одной строке Detail:
- ag_lim (y=0, черный цвет)
- iv_lim (y=9, синий цвет)
- uk_lim (y=18, красный цвет)

**Реализация в JasperReports:**
- Расположить три `<textField>` друг под другом с разными y-координатами
- Применить разные стили для каждого поля (DataStyle, InvestmentStyle, UkuporkaStyle)

### 8.3 Условное форматирование фона
VBA код изменяет BackColor секции Detail в зависимости от значения ogNm:
- "ИТОГО" или "Заказчики" → светло-розовый фон
- Остальные → чередование белого и светло-серого

**Реализация в JasperReports:**
- Использовать `<printWhenExpression>` для условного отображения
- Или использовать стили с условиями (Conditional Style)
- Или использовать `<style>` с `<conditionalStyle>`:
  ```xml
  <style name="DetailRowStyle">
    <conditionalStyle>
      <conditionExpression><![CDATA[$F{ogNm}.equals("ИТОГО") || $F{ogNm}.equals("Заказчики")]]></conditionExpression>
      <style backcolor="#FFD6D6"/>
    </conditionalStyle>
    <conditionalStyle>
      <conditionExpression><![CDATA[$V{REPORT_COUNT} % 2 == 0]]></conditionExpression>
      <style backcolor="#F2F2F2"/>
    </conditionalStyle>
  </style>
  ```

### 8.4 Вычисляемые поля
Три поля используют IIf формулы для условного отображения:
- ag_PlFulfillmentCn: скрывает отрицательные значения
- mnCn: отображает месяц только если ag_lim не NULL
- PrM_mnPreviousCn: отображает предыдущий месяц только если ag_lim не NULL

**Реализация в JasperReports:**
- Использовать `<textFieldExpression>` с тернарным оператором Java
- Или создать переменные (variable) с вычислением

### 8.5 Цветовая кодировка по периодам
Данные разных периодов имеют разные цвета:
- Текущий период: черный
- Предыдущий месяц: оранжевый
- Предпредыдущий месяц: зеленый

**Реализация:** Создать три стиля (CurrentPeriodStyle, PreviousPeriodStyle, PreviousPeriod2Style)

### 8.6 Форматирование процентов
10 полей имеют Format=Percent с DecimalPlaces=255 (авто)

**Реализация в JasperReports:**
- pattern="##0.0%" (один знак после запятой)
- или pattern="##0.00%" (два знака после запятой)
- проверить в Access, сколько знаков отображается

### 8.7 Ширина отчёта
Ширина отчёта (1162 points) превышает стандартный A3 Landscape (842 points).

**Варианты решения:**
1. Масштабировать отчёт при экспорте в PDF (scale="FitPage")
2. Уменьшить ширину столбцов пропорционально
3. Использовать A3+ или custom page size
4. Проверить реальную ширину в Access (возможно ошибка в извлечении)

---

## 9. Сводная статистика

### Количество контролов по типам:
- **Label:** 24 (заголовки столбцов)
- **TextBox:** 41 (поля данных)
- **Unknown_101 (линия):** 2 (разделители)
- **Unknown_127:** 1 (неизвестный элемент)
- **Rectangle:** 1 (нижняя граница)
- **Итого:** 70 контролов

### Количество контролов по секциям:
- **Report Header:** 1
- **Page Header:** 27
- **Group Header:** 0
- **Detail:** 42
- **Report Footer:** 1

### Цветовая палитра (уникальные цвета):
- **ForeColor:** 11 уникальных цветов
- **BackColor:** 8 уникальных цветов

### Количество столбцов:
- **Основных столбцов:** ~20
- **С учетом подстолбцов:** ~25-30

### Вычисляемые поля:
- **С формулами IIf:** 3
- **С форматом Percent:** 10

---

## 10. Следующие шаги

### Этап 08.1 - ЗАВЕРШЁН ✅
- ✅ Прочитан файл структуры (3768 строк)
- ✅ Проанализированы все 5 секций отчёта
- ✅ Составлен список всех 70 контролов с ключевыми свойствами
- ✅ Определена цветовая схема (11 цветов текста, 8 цветов фона)
- ✅ Определена группировка (1 уровень по ipgSh)
- ✅ Составлена схема layout'а (6 групп столбцов, 1160 points)

### Этап 08.2 - Следующий
Анализ источника данных ResultSet5:
- Выполнить SELECT из `ags.spMstrg_2408_ResultSet5`
- Определить типы данных всех 44 столбцов
- Проверить соответствие полей из Access и столбцов в ResultSet5
- Определить вычисляемые поля
- Изучить примеры данных

---

**Файл создан:** 2025-12-05  
**Автор:** Александр  
**Статус:** Этап 08.1 завершён ✅