**Дата:** 2025-11-12  
**Автор:** Александр  
**Этап:** 02.1.4

### UX-сценарии «подключение → просмотр организаций» (Quasar UI)
**Цели:** описать поток действий пользователя от запуска приложения до просмотра деталей организаций, учитывая состояния Quasar-компонентов, Pinia-сторы и возможные ошибки.

#### Сценарий A. Первое подключение и успешный просмотр
1. Пользователь открывает приложение. Верхняя панель (`TopBar`) и строка состояния (`StatusBar`) отображают режим `idle` («Ожидает подключения»), кнопка «Организации» неактивна.
2. Нажимает «Подключение к БД» → открывается `ConnectionModal` со значениями из `connection.getSavedForm()`, поля «Пароль» и «Токен» очищены.
3. Пользователь заполняет форму (host, port, database, authMode=SQL, username, password). Валидация поля отображается inline (`QInput`/`rules`).
4. Нажимает «Подключить» → модалка переходит в `validating`, затем в `connecting`. `TopBar` показывает чип со статусом «Подключение…», строка состояния — «Подключение…».
5. Store `connection` получает успешный ответ (в демо — имитация): `status` → `connected`, `schema` и `user` обновлены, модалка показывает `success`, закрывается автоматически, `simulateErrorToggle` переключается в true.
6. Пользователь остается на домашнем экране; появляется toast «Вы можете открыть "Организации" из верхнего меню» (реализация — `useQuasar().notify`).
7. Пользователь нажимает кнопку «Организации» в `TopBar` → `connection.navigate('organizations')`.
8. `AppLayout` отображает компонент `OrganizationsView`. Статус `organizations`-store: `loading = true`, таблица `QTable` мутная, строка состояния «Загрузка организаций…».
9. После загрузки данных таблица отображает список организаций; карточка справа пуста до выбора (в таблице автоматически выделяется первая запись — `store.selectOrganization`).
10. Пользователь кликает по другой организации → карточка обновляется, список контактов (`QList`) подгружается из mock-данных. Строка состояния показывает «Подключено к schemaX • N организаций • Пользователь userY».

#### Сценарий B. Ошибка подключения и повторная попытка
1. Шаги 1–4 аналогичны сценарию A.
2. При имитации ошибки (`simulateErrorToggle === true`) модалка переходит в `error`, под полями отображаются сообщения (например, «Неверные учетные данные»), строка состояния — «Ошибка подключения».
3. Пользователь исправляет пароль и повторно нажимает «Подключить» → последовательность `validating → connecting → success`.
4. Успешное подключение переключает `TopBar` и `StatusBar` в режим `connected`, кнопка «Организации» становится доступной. `simulateErrorToggle` сбрасывается в false, чтобы следующая попытка прошла успешно.
5. Пользователь переходит на `OrganizationsView`, как в сценарии A.

#### Сценарий C. Смена подключения и сброс состояния
1. Пользователь находится на `OrganizationsView`, просмотрел выбранную организацию.
2. Нажимает иконку «Отключиться» в `StatusBar` → store `connection` переходит в `disconnecting`, всё UI сереет, кнопка «Организации» отключена.
3. После завершения отключения статус `idle`. Строка состояния возвращается к «Ожидает подключения».
4. Пользователь вновь открывает `ConnectionModal`, использует кнопку «Сбросить» (значения восстанавливаются из savedForm, `password`/`token` очищены).
5. Подключение проходит успешно; `connection.navigate('organizations')` вызывается автоматически, `OrganizationsView` загружается заново, выбранная организация сбрасывается. Появляется уведомление «Данные обновлены после нового подключения».

#### Сценарий D. Отказ от подключения
1. Пользователь открывает `ConnectionModal`, вводит неполные/неверные данные.
2. При попытке закрыть (`X` или `Esc`) вызывается `requestClose()` → если форма dirty, появляется диалог `window.confirm` («Есть несохранённые изменения. Закрыть окно?»).
3. Пользователь выбирает «Отмена» → остаётся в модалке; либо «OK» → модалка закрывается, статус `connection` остаётся `idle`, строка состояния сообщает «Подключение требуется для просмотра данных».
4. При нажатии «Отмена» в кнопках модалки происходит аналогичная проверка dirty-состояния.

#### Состояния и события интеграции
- `connection.status` (`idle`, `connecting`, `connected`, `connectionError`, `disconnecting`) синхронизирован с `TopBar`, `StatusBar` и `AppLayout`.
- События:
  - `open-connection` → `ConnectionModal` открывается с актуальными сохранёнными значениями.
  - `submit` → запускает последовательность в `App.vue` (`validating → connecting → connected/error`).
  - `navigate('organizations')` → отображает `OrganizationsView`, инициирует `fetchOrganizations()`.
  - `disconnect` → переводит состояние `connection` в `disconnecting`, затем `idle`.
- `OrganizationsView`: `store.fetchOrganizations()` активируется при переходе или кнопке «Обновить», обновляет `loading`, `error`, `organizations`, `agents`.

#### UX подсказки и проверки
- После успешного подключения отображается toast «Подключено. Таблица организаций доступна». (Примечание: добавить `Notify.create()` в `handleSubmit` при `success`).
- При ошибке подключения — toast `negative`, модалка остаётся открытой.
- В нижнем статус-баре: «Подключено к schemaX • 3 организации • Пользователь userY» (обновляется из store).
- `OrganizationsView` отображает счётчик и дату последнего обновления, пригоден для smoke-теста.
- Проверить мобильное отображение: `TopBar` переключается на burger-меню, таблица прокручивается горизонтально.

#### Checklist для тестирования
1. Успешный сценарий A: заполнение формы, переход на `OrganizationsView`, выбор записи.
2. Сценарий B: искусственно вызвать ошибку (toggle), повторить попытку, убедиться в уведомлениях.
3. Сценарий C: «Отключиться», повторное подключение, проверка сброса выбранной организации.
4. Сценарий D: попытка закрыть модалку с незаполненными полями, подтверждение отмены.
5. Проверка строки состояния: корректные тексты и цвета для каждого статуса.
6. Проверка адаптивности: `TopBar` и `ConnectionModal` на экранах XS/S, присутствие скрытого меню с теми же опциями.
