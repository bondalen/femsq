**Дата:** 2025-11-10  
**Автор:** Александр  
**Связанные задачи:** task:0003, task:0011, task:0012, task:0013, task:0014

## Цели
- Подготовить переход от DAO-слоя к сервисам и будущим API-контроллерам.
- Определить DTO для чтения/записи организаций (`OgDto`, `OgCreateRequest`, `OgUpdateRequest`) и агентских организаций (`OgAgDto`, `OgAgCreateRequest`, `OgAgUpdateRequest`).
- Задать правила маппинга между DTO и доменными моделями (`Og`, `OgAg`), включая валидацию полей и управление идентификаторами.
- Зафиксировать формат ошибок и сообщений для сервисного слоя.

## Маппинг DTO ↔ Модели
| DTO | Назначение | Правила валидации | Преобразование в модель |
| --- | --- | --- | --- |
| `OgDto` | Ответ API для списка/просмотра | Все строки trim(), `registrationTaxType` в нижнем регистре | Использует данные `Og`, `null` допускается для необязательных полей |
| `OgCreateRequest` | Запрос создания организации | `name`, `officialName`, `registrationTaxType` обязательны, длина ≤255 | Сервис преобразует в `Og` с `ogKey = null` |
| `OgUpdateRequest` | Запрос обновления | Включает `id`, остальные поля как в create | Сервис проверяет существование id, обновляет `Og` |
| `OgAgDto` | Ответ с информацией об агенте | `legacyOid` транслируется как строка UUID | Использует данные `OgAg` |
| `OgAgCreateRequest` | Создание агента | `code` и `organizationId` обязательны | Преобразуется в `OgAg` с `ogAgKey = null` |
| `OgAgUpdateRequest` | Обновление агента | Требует `id`, остальное как create | Преобразуется в `OgAg` с заполненным `ogAgKey` |

## Правила валидации
- `OgCreateRequest` и `OgUpdateRequest`: 
  - `name` и `officialName` → `@NotBlank`, длина ≤255.
  - `registrationTaxType` → перечисление (`og`, `sd`, `ie`).
  - Финансовые показатели (`inn`, `kpp`, `ogrn`, `okpo`) — optional, валидируются на диапазоны в сервисе.
- `OgAgCreateRequest` / `OgAgUpdateRequest`:
  - `code` → `@Pattern("^[0-9]{3}$")` (по аналогии с seed-данными).
  - `organizationId` → проверка существования через `OgService`.
  - `legacyOid` → optional, парсинг через `UUID.fromString`.

## Исключения и ошибки
- Сервисный слой бросает `IllegalArgumentException` для нарушений бизнес-правил (сообщения локализуются на уровне API).
- DAO-слой пробрасывает `DaoException`; сервисы конвертируют в `ServiceLayerException` (планируется отдельный класс) для API.
- DTO-валидаторы (Bean Validation) применяются в контроллерах, но правила дублируются в сервисах как защита от прямого вызова.

## Следующие шаги
1. Создать пакет `com.femsq.database.api.dto` с перечисленными DTO.
2. Добавить мапперы (ручные или MapStruct) для преобразования `Og`/`OgAg` ↔ DTO.
3. Описать контракт API (GraphQL/REST) на базе DTO и сервисов.
4. Подготовить юнит-тесты мапперов на корректность преобразований и валидацию.
