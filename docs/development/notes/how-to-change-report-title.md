# Как изменить заголовок пользовательского отчёта

## Варианты изменения заголовка

### Вариант 1: Изменить заголовок в существующем отчёте (РЕКОМЕНДУЕТСЯ)

**Если вы хотите изменить заголовок в том же отчёте:**

1. **Измените JSON метаданные** (для названия в UI):
   ```json
   {
     "id": "mstrgAg_23_Branch_q2m_2408_25_26_0113",
     "name": "Новый заголовок отчёта",  ← измените здесь
     "description": "...",
     ...
   }
   ```

2. **Измените JRXML** (для заголовка внутри PDF):
   - Откройте `reports/custom/mstrgAg_23_Branch_q2m_2408_25-26-0113.jrxml`
   - Найдите секцию `<title>` или `<pageHeader>` с заголовком
   - Измените текст заголовка

3. **Автоматическая перекомпиляция:**
   - Приложение **автоматически обнаружит изменения** в JRXML (по timestamp)
   - При следующей генерации отчёта JRXML будет **автоматически перекомпилирован**
   - Старый .jasper файл в `reports/cache/` будет заменён новым
   - **Никаких дополнительных действий не требуется!**

**Как это работает:**
- По умолчанию `recompile-on-change: true` в `application.yml`
- Приложение сравнивает timestamp JRXML и .jasper файлов
- Если JRXML новее → автоматическая перекомпиляция

**Время обнаружения изменений:**
- При следующей генерации отчёта (мгновенно)
- Или через 5 минут (автоматическое сканирование)

### Вариант 2: Создать копию отчёта с новым именем

**Если вы хотите создать новый отчёт на основе существующего:**

1. **Скопируйте файлы:**
   ```bash
   cd reports/custom/
   cp mstrgAg_23_Branch_q2m_2408_25-26-0113.jrxml новый-отчёт.jrxml
   cp mstrgAg_23_Branch_q2m_2408_25-26-0113.json новый-отчёт.json
   ```

2. **Измените JSON метаданные:**
   ```json
   {
     "id": "новый-отчёт",  ← измените ID
     "name": "Новый заголовок",  ← измените название
     "files": {
       "template": "новый-отчёт.jrxml"  ← измените имя файла
     },
     ...
   }
   ```

3. **Измените JRXML:**
   - Откройте `новый-отчёт.jrxml`
   - Измените заголовок в секции `<title>` или `<pageHeader>`
   - (Опционально) Измените атрибут `name` в корневом элементе `<jasperReport>`

4. **Приложение обнаружит новый отчёт:**
   - При следующем сканировании (до 5 минут)
   - Или при следующей генерации отчёта

## Рекомендации

### ✅ Рекомендуется (Вариант 1):
- Изменить существующий отчёт, если нужно просто обновить заголовок
- Автоматическая перекомпиляция работает без дополнительных действий
- Не нужно создавать дубликаты файлов

### ⚠️ Используйте Вариант 2, если:
- Нужно сохранить старую версию отчёта
- Нужен отдельный отчёт с другим ID для фильтрации/поиска
- Нужны разные параметры или настройки

## Технические детали

### Механизм перекомпиляции

1. **Проверка изменений:**
   ```java
   // JasperReportsEngine.needsRecompilation()
   FileTime jrxmlLastModified = Files.getLastModifiedTime(jrxmlPath);
   FileTime jasperLastModified = Files.getLastModifiedTime(jasperPath);
   return jrxmlLastModified.toMillis() > jasperLastModified.toMillis();
   ```

2. **Автоматическая перекомпиляция:**
   - При вызове `compileReport()` проверяется timestamp
   - Если JRXML новее → компиляция из JRXML
   - Если .jasper новее → загрузка из кэша

3. **Кэширование:**
   - Скомпилированные .jasper файлы сохраняются в `./reports/cache/`
   - Кэш в памяти обновляется автоматически
   - Старые .jasper файлы заменяются новыми

### Где хранятся файлы

```
reports/
├── custom/
│   ├── mstrgAg_23_Branch_q2m_2408_25-26-0113.jrxml  ← исходный JRXML
│   └── mstrgAg_23_Branch_q2m_2408_25-26-0113.json   ← метаданные (название в UI)
└── cache/
    └── mstrgAg_23_Branch_q2m_2408_25-26-0113.jasper ← скомпилированный (автоматически)
```

### Что влияет на название в UI

1. **Приоритет 1:** Поле `name` в JSON метаданных (`reports/custom/*.json`)
2. **Приоритет 2:** Атрибут `name` в JRXML (`<jasperReport name="...">`)
3. **Fallback:** Имя файла без расширения

### Что влияет на заголовок в PDF

- Содержимое секции `<title>` в JRXML
- Содержимое секции `<pageHeader>` в JRXML
- Любые текстовые элементы в этих секциях

## Примеры

### Пример 1: Изменить только название в UI

**Файл:** `reports/custom/mstrgAg_23_Branch_q2m_2408_25-26-0113.json`
```json
{
  "id": "mstrgAg_23_Branch_q2m_2408_25_26_0113",
  "name": "Исполнение плана (обновлённый)",  ← изменили здесь
  "description": "...",
  ...
}
```

**Результат:**
- ✅ Название в UI изменится сразу (при следующем сканировании)
- ✅ Заголовок в PDF останется прежним
- ✅ Перекомпиляция не требуется

### Пример 2: Изменить заголовок в PDF

**Файл:** `reports/custom/mstrgAg_23_Branch_q2m_2408_25-26-0113.jrxml`
```xml
<jasperReport ...>
  <title>
    <band height="50">
      <staticText>
        <text><![CDATA[Новый заголовок в PDF]]></text>  ← изменили здесь
      </staticText>
    </band>
  </title>
  ...
</jasperReport>
```

**Результат:**
- ✅ При следующей генерации отчёта JRXML будет автоматически перекомпилирован
- ✅ Новый .jasper файл будет сохранён в `reports/cache/`
- ✅ Заголовок в PDF изменится

### Пример 3: Изменить и название в UI, и заголовок в PDF

**Шаги:**
1. Измените `name` в JSON (для UI)
2. Измените текст в `<title>` в JRXML (для PDF)
3. Сохраните оба файла

**Результат:**
- ✅ Название в UI изменится
- ✅ Заголовок в PDF изменится
- ✅ Автоматическая перекомпиляция при следующей генерации

## Часто задаваемые вопросы

**Q: Нужно ли удалять старый .jasper файл вручную?**  
A: Нет, приложение автоматически заменит его при перекомпиляции.

**Q: Как быстро изменения вступят в силу?**  
A: При следующей генерации отчёта (мгновенно) или через 5 минут (автосканирование).

**Q: Можно ли отключить автоматическую перекомпиляцию?**  
A: Да, установите `recompile-on-change: false` в `application.yml`, но это не рекомендуется.

**Q: Что если я изменю только JSON, а не JRXML?**  
A: Перекомпиляция не требуется, изменения вступят в силу при следующем сканировании.

**Q: Что если я изменю только JRXML, а не JSON?**  
A: Заголовок в PDF изменится, но название в UI останется прежним (из JSON).
