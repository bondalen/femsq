# Анализ проблемы компиляции во время выполнения

**Дата:** 2025-11-28  
**Версия:** 1.0  
**Статус:** Анализ завершён

## Суть проблемы

JasperReports компилирует Java-выражения из JRXML файлов во время выполнения приложения. В Spring Boot fat JAR классы находятся в `BOOT-INF/lib/`, и компилятор не может найти классы JasperReports для компиляции выражений.

## Специфичность проблемы

### Библиотеки, которые компилируют код во время выполнения:

1. **JasperReports** ✅ (используется в проекте)
   - Компилирует Java-выражения из JRXML
   - Проблема: компилятор не находит классы в nested JAR

2. **Groovy** ❌ (не используется)
   - Компилирует Groovy скрипты
   - Имеет встроенные механизмы работы с classpath

3. **JavaScript движки** ❌ (не используется)
   - Nashorn, GraalVM JS
   - Обычно не требуют компиляции Java-кода

4. **JSP/JSPX** ❌ (не используется)
   - Компилирует JSP в сервлеты
   - Не актуально для Spring Boot (используется Thymeleaf/Vue.js)

5. **Liquibase** ✅ (используется)
   - НЕ компилирует код, только выполняет SQL
   - Проблемы с nested JAR решены через Spring Boot

6. **GraphQL** ✅ (используется)
   - НЕ компилирует код, только парсит схемы
   - Работает через reflection

### Вывод: Проблема специфична для JasperReports

## Анализ целесообразности решения

### Аргументы ПРОТИВ решения сейчас:

1. **Нужен только один отчёт**
   - `my-new-report` + `my-new-report-sr-ag`
   - Оба отчёта корректно работают в Jaspersoft Studio 7.0.3
   - Можно хранить предкомпилированные `.jasper` файлы

2. **Простое решение существует**
   - Компилировать отчёты в Jaspersoft Studio
   - Хранить `.jasper` файлы в репозитории
   - Приложение уже поддерживает загрузку `.jasper` файлов

3. **Сложность решения**
   - Требует настройки classpath для компилятора
   - Может потребовать распаковки nested JAR
   - Увеличивает сложность сборки

4. **Редкость проблемы**
   - Только JasperReports имеет эту проблему
   - Другие библиотеки не компилируют код во время выполнения

### Аргументы ЗА решение:

1. **Автоматизация**
   - Не нужно вручную компилировать отчёты
   - Изменения в JRXML автоматически компилируются

2. **Масштабируемость**
   - Если отчётов станет много (10+), ручная компиляция станет проблемой
   - CI/CD может автоматически проверять компиляцию

3. **Консистентность**
   - Все отчёты компилируются одинаково
   - Нет риска забыть скомпилировать отчёт

## Рекомендация

### Для текущей ситуации (1 отчёт):

**НЕ решать проблему сейчас.** Использовать простое решение:
- Хранить `.jasper` файлы в репозитории
- Компилировать отчёты в Jaspersoft Studio при изменении
- Приложение уже поддерживает загрузку `.jasper` файлов

**Преимущества:**
- Работает сразу, без дополнительной настройки
- Не увеличивает сложность сборки
- Не требует изменений в коде

### Когда стоит решить проблему:

1. **Если отчётов станет 5+**
   - Ручная компиляция станет обременительной
   - Автоматизация окупится

2. **Если отчёты часто изменяются**
   - Автоматическая компиляция ускорит разработку

3. **Если нужна валидация в CI/CD**
   - Автоматическая проверка компиляции отчётов

## Альтернативные решения (если понадобится)

### Вариант 1: Предкомпиляция на этапе сборки (текущая попытка)
- ✅ Автоматическая компиляция
- ❌ Требует решения проблемы с classpath
- ❌ Увеличивает время сборки

### Вариант 2: Хранение .jasper файлов (рекомендуется сейчас)
- ✅ Работает сразу
- ✅ Не требует дополнительной настройки
- ❌ Нужно вручную компилировать при изменении

### Вариант 3: Использование exploded JAR
- ✅ Решает проблему с nested JAR
- ❌ Усложняет деплоймент
- ❌ Требует изменений в процессе развёртывания

### Вариант 4: Отдельный сервис компиляции
- ✅ Изолирует проблему
- ❌ Увеличивает сложность архитектуры
- ❌ Требует дополнительной инфраструктуры

## Заключение

**Проблема специфична для JasperReports** и не затронет другие библиотеки проекта. 

**Для текущей ситуации (1 отчёт) решение нецелесообразно** - проще хранить предкомпилированные `.jasper` файлы.

**Решение стоит реализовать**, если:
- Отчётов станет 5+
- Отчёты часто изменяются
- Нужна автоматическая валидация в CI/CD


