# Отчёт: Исполнение плана капитального строительства

**ID отчёта:** `mstrgAg_23_Branch_q2m_2408_25`  
**Версия:** 1.0.0  
**Статус:** Completed (В эксплуатации)  
**Дата создания:** 2025-12-05  
**Последнее обновление:** 2025-12-16  
**Автор:** Александр  
**Связанные задачи:** task:0038  

---

## 1. Описание отчёта

### Назначение

Отчёт предназначен для мониторинга и контроля исполнения планов капитального строительства по отдельным инвестиционным программам и подразделениям организации. Отображает информацию о лимитах, плановых и фактических показателях, процентах исполнения по различным схемам финансирования (агентская, инвестиционная, укупорка).

### Бизнес-контекст

Отчёт позволяет:
- Отслеживать выполнение планов капитального строительства
- Контролировать расходование лимитов по программам
- Анализировать динамику исполнения за текущий и предыдущие периоды
- Выявлять отклонения от плана (сверх плана / недовыполнение)
- Сравнивать показатели по разным схемам финансирования

### Пользователи

- Руководители департаментов капитального строительства
- Финансовые аналитики
- Менеджеры инвестиционных программ
- Контролёры бюджета

### Частота использования

Регулярно, обычно ежемесячно по окончании отчётного периода.

---

## 2. Источник данных

### Основная таблица

**Таблица:** `ags.spMstrg_2408_ResultSet5`  
**Процедура:** `ags.spMstrg_2408` (заполняет ResultSet5)  
**Количество записей:** Обычно 32 записи (31 запись данных + 1 разделительная строка)  
**Количество столбцов:** 44  

### Структура данных

#### Группы полей:

1. **Идентификационные поля:**
   - `ipgSh` (nvarchar) - схема реализации (группировка)
   - `ogNm` (nvarchar) - наименование организации
   - `branchName` (nvarchar) - наименование филиала
   - `cstAgPnCode` (nvarchar) - код агента подряда

2. **Лимиты и планы:**
   - `lim`, `ag_lim`, `iv_lim`, `uk_lim` (money) - лимиты по схемам
   - `ag_PlAccum`, `ag_PlFulfillment` (money) - план накопительно, исполнение
   - `mn`, `PrM_mnPrevious`, `PrM_mnPrevious2` (money) - данные по месяцам

3. **Процентные показатели:**
   - `ag_LimPc`, `ag_PlPz` (float) - проценты от лимита и плана
   - 10 других процентных полей для разных периодов

4. **Специальные поля:**
   - `limSort` (nvarchar) - для сортировки
   - `ag_PlFulfillment`, `ag_PlOverFulfillment` (money) - исполнение и сверх плана

### Фильтрация данных

Данные фильтруются в SQL запросе:
- По инвестиционной программе (`ipgCh`)
- По дате окончания периода (`MounthEndDate`)
- Только итоговые данные по организациям (`cstAgPnCode = 'всего'`)

### Сортировка

```sql
ORDER BY ipgSh, limSort DESC, lim DESC
```

---

## 3. Параметры отчёта

| Параметр | Тип | Обязательный | По умолчанию | Описание |
|----------|-----|--------------|--------------|----------|
| `ipgCh` | integer | Да | - | Код инвестиционной программы для фильтрации данных |
| `MounthEndDate` | date | Да | - | Дата окончания отчётного периода (формат: yyyy-MM-dd) |
| `SCHEMA_NAME` | string | Нет | "ags" | Имя схемы базы данных |

### Примеры значений параметров

```json
{
  "ipgCh": "15",
  "MounthEndDate": "2025-07-31",
  "SCHEMA_NAME": "ags"
}
```

---

## 4. Технические характеристики

### Формат страницы

- **Размер:** A3 Landscape (420mm × 297mm)
- **Ориентация:** Альбомная (Landscape)
- **Размеры в points:** 1191pt × 842pt
- **Поля:** 14pt со всех сторон (~5mm)
- **Рабочая область:** 1163pt × 814pt

### Форматы вывода

- **PDF** (основной) - полностью протестирован и работает
- **XLSX** (Excel) - требует дополнительного тестирования
- **HTML** - требует дополнительного тестирования

### Технологии

- **JasperReports:** версия 7.0.3
- **Java:** выражения для вычисляемых полей
- **SQL Server:** источник данных (JDBC)

### Структура отчёта

- **Группировка:** По полю `ipgSh` (схема реализации)
- **Секции:**
  - Title (Заголовок отчёта) - 43pt
  - Page Header (Заголовки столбцов) - трёхуровневые, через jr:table
  - Group Header (Заголовок группы) - строки данных, 27pt на строку
  - Detail - не используется (height=0)
  - Page Footer (Нижний колонтитул) - нумерация страниц, дата

### Производительность

- **Время генерации:** ~2-4 секунды (для 32 записей)
- **Размер PDF:** ~100-200 KB

---

## 5. Особенности реализации

### Условное форматирование

Реализовано через фоновые прямоугольники в `groupHeader` band:

#### Чётные строки (серый фон)
- **Цвет:** `#E0E0E0` (светло-серый)
- **Условие:** `$V{REPORT_COUNT} % 2 == 0`
- **Применяется к:** всем строкам данных

#### Строки итогов (оранжевый фон)
- **Цвет:** `#FCD5B5` (персиковый/оранжевый)
- **Условие:** `$F{ogNm}.equals("итого") || $F{ogNm}.equals("Заказчики")`
- **Применяется к:** строкам с подведением итогов

**Важно:** Ячейки таблицы должны быть прозрачными (`mode="Transparent"`), чтобы фоновые прямоугольники были видны.

### Трёхуровневые заголовки

Реализованы через компонент `jr:table` с subdataset `HeaderTableDataset`:
- **Уровень 1:** Общие блоки (например, "в разрезе видов контрагентов финансирования")
- **Уровень 2:** Подблоки (например, "план", "исполнение", "сверх плана")
- **Уровень 3:** Конкретные показатели с единицами измерения

### Цветовое кодирование данных

Разные типы данных отображаются разными цветами:

| Тип данных | Цвет | Hex | Применение |
|------------|------|-----|------------|
| Агентская схема | Чёрный | `#404040` | Основные данные |
| Инвестиционная схема | Синий | `#2F3699` | Поле `iv_lim` |
| Укупорка | Красный | `#C0504D` | Поле `uk_lim` |
| Заголовки основные | Серый | `#7F7F7F` | Page Header |
| Заголовки синие | Синий | `#2F3699` | Некоторые заголовки |
| Заголовки красные | Красный | `#FF0000` | Control #27 |

### Вычисляемые поля

Некоторые поля вычисляются динамически (конвертация из Access VBA IIf формул):

#### ag_PlFulfillmentCn
```java
$F{ag_PlFulfillment} != null && $F{ag_PlFulfillment}.doubleValue() >= 0 
  ? $F{ag_PlFulfillment} 
  : null
```
Скрывает отрицательные значения исполнения плана.

#### mnCn
```java
$F{ag_lim} != null ? $F{mn} : null
```
Отображается только если есть агентский лимит.

#### PrM_mnPreviousCn, PrM_mnPrevious2Cn
Аналогично для предыдущих периодов.

---

## 6. Миграция из MS Access

### Исходный отчёт

- **Имя:** `mstrgAg_23_Branch_q2m_2408_25`
- **Источник:** MS Access база данных `24-1125_ra.accdb`
- **Версия Access:** 15.0
- **Формат:** A3 Landscape
- **Количество контролов:** 70 (24 Label + 42 TextBox + 4 других)

### Процесс миграции

#### 1. Экспорт структуры из Access
- Использован VBA скрипт `ExportAccessReportStructure_FIXED.vba`
- Создан файл `mstrgAg_23_Branch_q2m_2408_25_structure.txt` (3768 строк)
- Кодировка: cp1251 (русский текст)

#### 2. Анализ структуры
- Проанализировано 70 контролов с координатами, размерами, цветами
- Определено 11 цветов текста и 8 цветов фона
- Составлена схема layout из 6 групп столбцов

#### 3. Преобразование координат
- **twips → points:** 1 twip = 1/1440 inch ≈ 0.05 points
- Формула: `points = twips / 20`
- Погрешность: ±1-2 пикселя (допустимо)

#### 4. Преобразование VBA кода
- VBA условное форматирование → фоновые rectangles
- VBA IIf формулы → Java expressions
- VBA функции → JasperReports встроенные функции

### Проблемы и решения

#### Проблема 1: Условное форматирование
**Описание:** VBA код в секции `Detail_Format` не имеет прямого аналога в JasperReports.

**VBA код:**
```vba
If [ogNm] = "итого" Or [ogNm] = "Заказчики" Then
    Me.Section(0).BackColor = RGB(215, 214, 214)
Else
    If Me.CurrentRecord Mod 2 = 0 Then
        Me.Section(0).BackColor = RGB(242, 242, 242)
    Else
        Me.Section(0).BackColor = RGB(255, 255, 255)
    End If
End If
```

**Решение:** 
- Использованы два фоновых прямоугольника в `groupHeader`
- Первый: серый для чётных строк (`$V{REPORT_COUNT} % 2 == 0`)
- Второй: оранжевый для итогов (поверх серого)
- Ячейки таблицы сделаны прозрачными (`mode="Transparent"`)

#### Проблема 2: Многоуровневые заголовки
**Описание:** Access использует многоуровневые Label с объединением ячеек.

**Решение:**
- Использован компонент `jr:table` с subdataset
- Данные для заголовков генерируются через `JRMapCollectionDataSource`
- 3 уровня заголовков реализованы как 3 строки в таблице

#### Проблема 3: Вычисляемые поля с IIf
**Описание:** Access использует IIf для условной логики в `ControlSource`.

**Пример Access:**
```vba
=IIf([ag_PlFulfillment]<0,Null,[ag_PlFulfillment])
```

**Решение JasperReports:**
```xml
<expression><![CDATA[
  $F{ag_PlFulfillment} != null && $F{ag_PlFulfillment}.doubleValue() >= 0 
    ? $F{ag_PlFulfillment} 
    : null
]]></expression>
```

---

## 7. Примеры использования

### Через REST API (curl)

#### Генерация PDF
```bash
curl -X POST http://localhost:8080/api/v1/reports/mstrgAg_23_Branch_q2m_2408_25/generate \
  -H "Content-Type: application/json" \
  -d '{
    "parameters": {
      "ipgCh": "15",
      "MounthEndDate": "2025-07-31"
    },
    "format": "pdf"
  }' \
  --output report.pdf
```

#### Получение списка отчётов
```bash
curl -X GET http://localhost:8080/api/v1/reports
```

#### Получение метаданных отчёта
```bash
curl -X GET http://localhost:8080/api/v1/reports/mstrgAg_23_Branch_q2m_2408_25
```

### Через Frontend (Vue.js)

#### Шаги для пользователя:

1. **Открыть приложение:** `http://localhost:8080`

2. **Перейти в раздел отчётов:**
   - Главное меню → "Отчёты"
   - Или напрямую: `http://localhost:8080/reports`

3. **Найти отчёт:**
   - Категория: "Капитальное строительство" (mstrg)
   - Название: "Исполнение плана капитального строительства"

4. **Заполнить параметры:**
   - **Код инвестиционной программы:** 15 (или другой)
   - **Дата окончания периода:** 2025-07-31 (формат yyyy-MM-dd)

5. **Выбрать формат:**
   - PDF (рекомендуется)
   - XLSX (требует тестирования)
   - HTML (требует тестирования)

6. **Сгенерировать:**
   - Нажать кнопку "Сгенерировать PDF"
   - Отчёт откроется в новой вкладке браузера

### Через Desktop ярлыки (Linux)

#### Запуск приложения:
- Двойной клик на ярлык "FEMSQ Start (Background)" на рабочем столе
- Или через меню приложений: Development → FEMSQ Start

#### Проверка статуса:
- Ярлык "FEMSQ Status" показывает статус приложения

#### Остановка:
- Ярлык "FEMSQ Stop" останавливает приложение

---

## 8. Известные ограничения

### Детализация отчёта

- **Реализовано:** ~40% полей из исходного Access отчёта
- **Причина:** Базовая версия содержит основные поля, достаточные для функционирования
- **Недостающие поля:**
  - Предыдущий месяц (PrM_*, оранжевый цвет) - 10 полей
  - Предпредыдущий месяц (PrM_*2, зелёный цвет) - 10 полей
  - Дополнительные вычисляемые поля - 5-7 полей
- **Планы:** Доработка может быть выполнена позже при необходимости

### Форматы вывода

- **PDF:** Полностью протестирован и работает корректно ✅
- **XLSX:** Требует дополнительного тестирования ⚠️
  - Условное форматирование может не работать
  - Многоуровневые заголовки могут экспортироваться некорректно
- **HTML:** Требует дополнительного тестирования ⚠️
  - Форматирование может отличаться от PDF

### Производительность

- **Текущие данные:** Тестировалось только на ~32 записях
- **Большие объёмы:** Не тестировалось на объёмах 100+ записей
- **Рекомендация:** Провести нагрузочное тестирование при необходимости

### Технические требования

- **Шрифты:** Требуется Times New Roman на сервере
  - Без шрифта отчёт будет использовать fallback (например, Liberation Serif)
  - Внешний вид может незначительно отличаться
- **SQL Server:** Требуется доступ к БД FishEye с процедурой `spMstrg_2408`
- **Java:** Требуется Java 17+ для работы Spring Boot 3.x

---

## 9. История изменений

### v1.0.0 (2025-12-16) - Production Release
- ✅ Backend интеграция завершена
- ✅ Frontend интеграция протестирована
- ✅ Логирование настроено с временными метками
- ✅ Desktop инструменты управления созданы
- ✅ Тестирование на тестовой машине пройдено
- ✅ Документация создана

### v0.9.0 (2025-12-15) - Условное форматирование
- ✅ Реализовано условное форматирование через фоновые прямоугольники
- ✅ Чётные строки: светло-серый (#E0E0E0)
- ✅ Строки "итого"/"Заказчики": персиковый (#FCD5B5)
- ✅ Прозрачные ячейки таблицы для видимости фона

### v0.5.0 (2025-12-10) - Трёхуровневые заголовки
- ✅ Реализована таблица заголовков через jr:table
- ✅ 3 уровня заголовков (16 колонок)
- ✅ Цвета фонов: #FDEADA, #FCD5B5, #F3F0F6

### v0.1.0 (2025-12-05) - Базовый JRXML
- ✅ Создан базовый JRXML шаблон
- ✅ 44 field definitions из ResultSet5
- ✅ SQL запрос с параметрами
- ✅ Группировка по ipgSh
- ✅ Основные секции: Title, Page Header, Group Header, Page Footer

---

## 10. Ссылки и файлы

### Основные файлы проекта

- **JRXML шаблон:**  
  `code/femsq-backend/femsq-reports/src/main/resources/reports/embedded/mstrgAg_23_Branch_q2m_2408_25.jrxml`

- **JSON metadata:**  
  `code/femsq-backend/femsq-reports/src/main/resources/reports/embedded/mstrgAg_23_Branch_q2m_2408_25.json`

- **Документация:**  
  `docs/development/technical/reports/mstrgAg_23_Branch_q2m_2408_25.md` (этот файл)

### Документы анализа

- **Анализ структуры Access отчёта (часть 1):**  
  `docs/development/notes/analysis/access-report-mstrgAg-23-analysis.md` (468 строк)

- **Анализ структуры Access отчёта (часть 2):**  
  `docs/development/notes/analysis/access-report-mstrgAg-23-analysis-part2.md` (380 строк)

- **Краткая сводка анализа:**  
  `docs/development/notes/analysis/access-report-mstrgAg-23-summary.md` (173 строки)

- **Анализ данных ResultSet5:**  
  `docs/development/notes/analysis/resultset5-data-analysis.md` (557 строк)

### План разработки

- **План работы чата:**  
  `docs/development/notes/chats/chat-plan/chat-plan-25-1205-jasper-report-mstrg.md` (838 строк)

### Исходные файлы из Access

- **Экспорт структуры Access отчёта:**  
  `/home/alex/Загрузки/mstrgAg_23_Branch_q2m_2408_25_structure.txt` (3768 строк, кодировка cp1251)

- **VBA скрипт экспорта:**  
  `/home/alex/femsq-test/access-jr-report/ExportAccessReportStructure_FIXED.vba`

### Backend код

- **ReportDiscoveryService:**  
  `code/femsq-backend/femsq-reports/src/main/java/com/femsq/reports/core/ReportDiscoveryService.java`

- **ReportGenerationService:**  
  `code/femsq-backend/femsq-reports/src/main/java/com/femsq/reports/core/ReportGenerationService.java`

- **ReportController:**  
  `code/femsq-backend/femsq-reports/src/main/java/com/femsq/reports/api/ReportController.java`

### Frontend код

- **ReportsCatalog.vue:**  
  `code/femsq-frontend/src/components/reports/ReportsCatalog.vue`

### Desktop инструменты

- **Скрипты управления:**
  - `/home/alex/femsq-test/test-25-1215/start-femsq-background.sh`
  - `/home/alex/femsq-test/test-25-1215/stop-femsq.sh`
  - `/home/alex/femsq-test/test-25-1215/status-femsq.sh`
  - `/home/alex/femsq-test/test-25-1215/run-with-external-libs.sh`

- **Desktop ярлыки:**
  - `~/.local/share/applications/femsq-launcher-background.desktop`
  - `~/.local/share/applications/femsq-stop.desktop`
  - `~/.local/share/applications/femsq-status.desktop`

---

## 11. Контакты и поддержка

**Разработчик:** Александр  
**Дата создания документа:** 2025-12-16  
**Версия документа:** 1.0.0  

Для вопросов и предложений по улучшению отчёта, пожалуйста, создавайте задачи в системе управления проектом или обращайтесь к разработчику.

---

**Примечание:** Этот документ является частью технической документации проекта FEMSQ и подлежит обновлению при внесении изменений в отчёт.

