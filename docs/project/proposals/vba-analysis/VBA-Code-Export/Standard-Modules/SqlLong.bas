Attribute VB_Name = "SqlLong"
Option Compare Database


'****************************************************************************************************************************************************
' клеем длинный SQL дл€ процедуры *ќтображаем новые счета-фактуры дл€ существующих договоров* *******************************************************
' заполн€ющий табличку новых счЄтов-фактур **********************************************************************************************************
Public Function SqlCnCtptExistInvNot() As String

    Dim strSql As String

    strSql = ""
    
    ' заполн€ем табличку новых счЄтов-фактур
'    strSQL = strSQL & "insert into CnInvDbtUplTblCnInv "
'    strSQL = strSQL & "    (cidutciCntrPrtNum, cidutciCntrPrtName, cidutciCnName, cidutciCnDate, cidutciCn_key, cidutciCn_s_org_key, cidutciCnInv, cidutciCiKey) "
'    strSQL = strSQL & "select "
'    strSQL = strSQL & " f.cidutCntrPrtNum , f.cidutCntrPrtName, "
'    strSQL = strSQL & " iif(f.cidutCnName = ""Null»лиѕусто"", null, f.cidutCnName) as cidutCnName, "
'    strSQL = strSQL & " f.cidutCnDate, f.cn_key, f.cn_s_org_key, "
'    strSQL = strSQL & " iif(f.cidutCnInv = ""Null»лиѕусто"", null, f.cidutCnInv) as cidutCnInv, "
'    strSQL = strSQL & " f.ciKey "
'    strSQL = strSQL & "from "
'    strSQL = strSQL & " ciduCnCtptExistInvNot As f "
'    strSQL = strSQL & " where f.ciKey Is Null"
    
    strSql = strSql & "INSERT INTO CnInvDbtUplTblCnInv ( cidutciCn_key, cidutciCnName, cidutciCnInv, inNumCount ) "
    strSql = strSql & "SELECT cn_key, cidutCnNameNull, cidutCnInvNull, inNumCount "
    strSql = strSql & "FROM ciduCnExistInvNot "
    strSql = strSql & "WHERE ciKey Is Null "
    strSql = strSql & "GROUP BY cn_key, cidutCnNameNull, cidutCnInvNull, inNumCount; "

    
    ' заполн€ем табличку новых счЄтов-фактур
'    strSQL = strSQL & "insert into CnInvDbtUplTblCnInv "
'    strSQL = strSQL & "    (cidutciCntrPrtNum, cidutciCntrPrtName, cidutciCnName, cidutciCnDate, cidutciCn_key, cidutciCn_s_org_key, cidutciCnInv, cidutciCiKey) "
'    strSQL = strSQL & "select "
'    strSQL = strSQL & "    f.cidutCntrPrtNum , f.cidutCntrPrtName, "
'    strSQL = strSQL & "    iif(f.cidutCnName = ""Null»лиѕусто"", null, f.cidutCnName) as cidutCnName, "
'    strSQL = strSQL & "    f.cidutCnDate, f.cn_key, f.cn_s_org_key, "
'    strSQL = strSQL & "    iif(f.cidutCnInv = ""Null»лиѕусто"", null, f.cidutCnInv) as cidutCnInv, "
'    strSQL = strSQL & "    g.ciKey "
'    strSQL = strSQL & "from "
'    strSQL = strSQL & "    ( "
'    strSQL = strSQL & "        select "
'    strSQL = strSQL & "            h.cidutCntrPrtNum, h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, h.cn_s_org_key, "
'    strSQL = strSQL & "            iif(isnull(h.cidutCnInv), ""Null»лиѕусто"", iif(h.cidutCnInv = '', ""Null»лиѕусто"", trim(h.cidutCnInv))) as cidutCnInv "
'    strSQL = strSQL & "        from "
'    strSQL = strSQL & "            ( "
'    strSQL = strSQL & "                select u.cidutCntrPrtNum, u.cidutCntrPrtName, u.cidutCntrPrtITN, u.cidutCnName, u.cidutCnDate, u.cn_key, u.cn_s_org_key, t.cidutCnInv, t.cidutAccount "
'    strSQL = strSQL & "                from "
'    strSQL = strSQL & "                    ( "
'    strSQL = strSQL & "                        SELECT "
'    strSQL = strSQL & "                            k.cidutCntrPrtNum , k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key, l.cn_s_org_key "
'    strSQL = strSQL & "                        from "
'    strSQL = strSQL & "                            ( "
'    strSQL = strSQL & "                                SELECT "
'    strSQL = strSQL & "                                    a.cidutAccount, a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCntrPrtITN, a.cidutCnDate, "
'    strSQL = strSQL & "                                    iif(isnull(a.cidutCnName), ""Null»лиѕусто"", iif(a.cidutCnName = '', ""Null»лиѕусто"", TRIM(a.cidutCnName))) AS cidutCnName, "
'    strSQL = strSQL & "                                    a.cidutCnInv, a.cidutFormtnDate, a.cidutMatrtyDate, a.cidutDebt, a.cidutDebtOverdue, a.cidutDoc, "
'    strSQL = strSQL & "                                    a.cidutLink , a.cidutSheet, a.cidutSheetNum, a.cidutUnloadKey "
'    strSQL = strSQL & "                                from "
'    strSQL = strSQL & "                                    CnInvDbtUplTbl As a "
'    strSQL = strSQL & "                                    Left Join "
'    strSQL = strSQL & "                                        ( "
'    strSQL = strSQL & "                                            SELECT "
'    strSQL = strSQL & "                                                Z.cidutCntrPrtNum , Z.cidutCntrPrtName, Z.cidutCntrPrtITN, x.org_id_value_l, x.org, x.org_id_key "
'    strSQL = strSQL & "                                            from "
'    strSQL = strSQL & "                                                ( "
'    strSQL = strSQL & "                                                    SELECT cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
'    strSQL = strSQL & "                                                    from CnInvDbtUplTbl "
'    strSQL = strSQL & "                                                    GROUP BY cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
'    strSQL = strSQL & "                                                ) AS z "
'    strSQL = strSQL & "                                                Left Join "
'    strSQL = strSQL & "                                                    ( "
'    strSQL = strSQL & "                                                        SELECT org_id_value_l, org, org_id_type, org_id_key "
'    strSQL = strSQL & "                                                        from ags_org_id "
'    strSQL = strSQL & "                                                        where org_id_type = 1 "
'    strSQL = strSQL & "                                                    ) AS x ON z.cidutCntrPrtNum = x.org_id_value_l "
'    strSQL = strSQL & "                                            where (((x.org_id_key) Is Null)) "
'    strSQL = strSQL & "                                        ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum "
'    strSQL = strSQL & "                                where b.cidutCntrPrtName Is Null "
'    strSQL = strSQL & "                            ) as k "
'    strSQL = strSQL & "                            Left Join "
'    strSQL = strSQL & "                                ( "
'    strSQL = strSQL & "                                    SELECT "
'    strSQL = strSQL & "                                        c.cn_key, "
'    strSQL = strSQL & "                                        iif(isnull(c.cn_number), ""Null»лиѕусто"", iif(c.cn_number = '', ""Null»лиѕусто"", TRIM(c.cn_number))) AS cn_number, "
'    strSQL = strSQL & "                                        s.cn_s_key, s.cn_s_type, o.cn_s_org_key, o.org_id, c.cn_date, o.date_beg, o.date_end, "
'    strSQL = strSQL & "                                        o.csoCnDate , i.org_id_value_l, g.ogNm "
'    strSQL = strSQL & "                                    from "
'    strSQL = strSQL & "                                        ( "
'    strSQL = strSQL & "                                            ( "
'    strSQL = strSQL & "                                                ( "
'    strSQL = strSQL & "                                                    ags_cn As c "
'    strSQL = strSQL & "                                                    INNER Join "
'    strSQL = strSQL & "                                                        ags_cn_s AS s ON c.cn_key = s.cn_key "
'    strSQL = strSQL & "                                                ) "
'    strSQL = strSQL & "                                                INNER Join "
'    strSQL = strSQL & "                                                    ags_cn_s_org AS o ON s.cn_s_key = o.cn_s_key "
'    strSQL = strSQL & "                                            ) "
'    strSQL = strSQL & "                                            INNER Join "
'    strSQL = strSQL & "                                                ags_org_id AS i ON o.org_id = i.org_id_key "
'    strSQL = strSQL & "                                        ) "
'    strSQL = strSQL & "                                        INNER JOIN ags_og AS g ON i.org = g.ogKey "
'    strSQL = strSQL & "                                    where (((s.cn_s_type) = 2)) "
'    strSQL = strSQL & "                                ) as l ON (k.cidutCntrPrtNum = l.org_id_value_l) AND (k.cidutCnName = l.cn_number)  AND ((k.cidutCnDate = l.csoCnDate) or (isnull(k.cidutCnDate) and isnull(l.csoCnDate))) "
'    strSQL = strSQL & "                        where (((l.cn_key) Is Not Null)) "
'    strSQL = strSQL & "                        GROUP BY k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key, l.cn_s_org_key "
'    strSQL = strSQL & "                    ) as u "
'    strSQL = strSQL & "                Left Join "
'    strSQL = strSQL & "                    CnInvDbtUplTbl As t "
'    strSQL = strSQL & "                    on u.cidutCntrPrtNum = t.cidutCntrPrtNum and u.cidutCnName = t.cidutCnName and (u.cidutCnDate = t.cidutCnDate or (isnull(u.cidutCnDate) and isnull(t.cidutCnDate))) "
'    strSQL = strSQL & "            ) as h "
'    strSQL = strSQL & "        Group by "
'    strSQL = strSQL & "            h.cidutCntrPrtNum , h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, h.cn_s_org_key, h.cidutCnInv "
'    strSQL = strSQL & "    ) as f "
'    strSQL = strSQL & "    Left Join "
'    strSQL = strSQL & "        ( "
'    strSQL = strSQL & "            select "
'    strSQL = strSQL & "                i.ciKey, i.ciCn, iif(isnull(i.ciNum), ""Null»лиѕусто"", iif(i.ciNum = '', ""Null»лиѕусто"", trim(i.ciNum))) as ciNum "
'    strSQL = strSQL & "            from "
'    strSQL = strSQL & "                ags_cnInv i "
'    strSQL = strSQL & "        ) as g on f.cn_key = g.ciCn and f.cidutCnInv = g.ciNum "
'    strSQL = strSQL & "where g.ciKey Is Null"
    
    SqlCnCtptExistInvNot = strSql

End Function
' клеем длинный SQL дл€ процедуры *ќтображаем новые счета-фактуры дл€ существующих договоров* *******************************************************
' заполн€ющий табличку новых счЄтов-фактур, окончание ***********************************************************************************************
'****************************************************************************************************************************************************

'****************************************************************************************************************************************************
' клеем длинный SQL дл€ процедуры *ќтображаем новые счета-фактуры дл€ существующих договоров* *******************************************************
' отображающий договора, имеющие новые счета-фактуры ************************************************************************************************
Public Function SqlCnCtptExistInvNotRead() As String

    Dim strSql As String

    strSql = ""

    ' отображаем договора, имеющие новые счета-фактуры
    strSql = ""
    
'    strSQL = strSQL & "SELECT "
'    strSQL = strSQL & "   cidutciCntrPrtNum, cidutciCntrPrtName, cidutciCnName, cidutciCnDate, cidutciCn_key, cidutciCnInvCount, "
'    strSQL = strSQL & "   ConcatRelated(""cidutciCnInv"", ""CnInvDbtUplTblCnInv"", ""cidutciCn_key = "" & [cidutciCn_key]) As CnInvList "
'    strSQL = strSQL & "FROM "
'    strSQL = strSQL & "   ( "
'    strSQL = strSQL & "      SELECT "
'    strSQL = strSQL & "         cidutciCntrPrtNum, cidutciCntrPrtName, cidutciCnName, cidutciCnDate, cidutciCn_key, "
'    strSQL = strSQL & "         count(cidutciCnInv) As cidutciCnInvCount "
'    strSQL = strSQL & "      FROM "
'    strSQL = strSQL & "         CnInvDbtUplTblCnInv "
'    strSQL = strSQL & "      Group BY "
'    strSQL = strSQL & "         cidutciCntrPrtNum , cidutciCntrPrtName, cidutciCnName, cidutciCnDate, cidutciCn_key "
'    strSQL = strSQL & "   ) as a"
    
    
    strSql = strSql & "select "
    strSql = strSql & " a.cidutciCnName, a.cidutciCn_key, a.cidutciCnInvCount, "
    strSql = strSql & " ConcatRelated(""cidutciCnInv"", ""CnInvDbtUplTblCnInv"", ""cidutciCn_key = "" & a.cidutciCn_key)  As CnInvList "
    strSql = strSql & "FROM "
    strSql = strSql & " ("
    strSql = strSql & "     SELECT i.cidutciCnName, i.cidutciCn_key, Count(i.cidutciCnInv) AS cidutciCnInvCount "
    strSql = strSql & "     FROM CnInvDbtUplTblCnInv AS i "
    strSql = strSql & "     GROUP BY i.cidutciCnName, i.cidutciCn_key "
    strSql = strSql & " ) as a"

    
    SqlCnCtptExistInvNotRead = strSql

End Function
' клеем длинный SQL дл€ процедуры *ќтображаем новые счета-фактуры дл€ существующих договоров* *******************************************************
' отображающий договора, имеющие новые счета-фактуры, окончание *************************************************************************************
'****************************************************************************************************************************************************


'****************************************************************************************************************************************************
' клеем длинный SQL дл€ процедуры *ќтображаем новые счета-фактуры дл€ существующих договоров либо добавл€ем их в Ѕƒ* ********************************
Public Function SqlCnCtptExistInvNotLoad() As String

    Dim strSql As String

    strSql = ""
    
    strSql = strSql & "INSERT INTO ags_cnInv (ciCn, ciNum, ciCounterParty, ciMark, ciNote) "
    strSql = strSql & "SELECT z.cidutciCn_key, z.cidutciCnInv, z.cidutciCn_s_org_key, " _
        & strMark(Now()) & " AS mark, ""«агружено "" & Date() & "" в "" & Time() AS [note] "
    strSql = strSql & "FROM (SELECT cidutciCn_key, cidutciCnInv, cidutciCn_s_org_key "
    strSql = strSql & "FROM CnInvDbtUplTblCnInv "
    strSql = strSql & "GROUP BY cidutciCn_key, cidutciCnInv, cidutciCn_s_org_key "
    strSql = strSql & ")  AS z; "

    SqlCnCtptExistInvNotLoad = strSql

End Function
' клеем длинный SQL дл€ процедуры *ќтображаем новые счета-фактуры дл€ существующих договоров либо добавл€ем их в Ѕƒ*, окончание *********************
'****************************************************************************************************************************************************


'****************************************************************************************************************************************************
' клеем длинный SQL дл€ процедуры *ќтображаем договора, в которых отсутствует обнаруженный в Ѕƒ исполнитель либо добавл€ем их* 22.11.2021 10:17 *****
Public Function SqlCnExistCtptNotLoad() As String

    Dim strSql As String

    strSql = ""

    strSql = strSql & "Select "
    strSql = strSql & "z.cidutCntrPrtNum, z.cidutCntrPrtName, z.cidutCntrPrtITN, z.cidutCnName, z.cidutCnDate, count(y.cn_key) as cnCount "
    strSql = strSql & "from "
    strSql = strSql & "    ( "
    strSql = strSql & "        SELECT "
    strSql = strSql & "            k.cidutCntrPrtNum , k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate "
    strSql = strSql & "        from "
    strSql = strSql & "            ( "
    strSql = strSql & "                SELECT "
    strSql = strSql & "                    a.cidutAccount, a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCntrPrtITN, "
    strSql = strSql & "                    iif(isnull(a.cidutCnName), ""Null»лиѕусто"", iif(a.cidutCnName = '', ""Null»лиѕусто"", TRIM(a.cidutCnName))) AS cidutCnName, "
    strSql = strSql & "                    a.cidutCnDate, "
    strSql = strSql & "                    a.cidutCnInv, a.cidutFormtnDate, a.cidutMatrtyDate, a.cidutDebt, a.cidutDebtOverdue, a.cidutDoc, "
    strSql = strSql & "                    a.cidutLink , a.cidutSheet, a.cidutSheetNum, a.cidutUnloadKey "
    strSql = strSql & "                from "
    strSql = strSql & "                    CnInvDbtUplTbl As a "
    strSql = strSql & "                    Left Join "
    strSql = strSql & "                        ( "
    strSql = strSql & "                            SELECT "
    strSql = strSql & "                                Z.cidutCntrPrtNum , Z.cidutCntrPrtName, Z.cidutCntrPrtITN, x.org_id_value_l, x.org, x.org_id_key "
    strSql = strSql & "                            from "
    strSql = strSql & "                                ( "
    strSql = strSql & "                                    SELECT cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
    strSql = strSql & "                                    from CnInvDbtUplTbl "
    strSql = strSql & "                                    GROUP BY cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
    strSql = strSql & "                                ) AS z "
    strSql = strSql & "                                Left Join "
    strSql = strSql & "                                    ( "
    strSql = strSql & "                                        SELECT org_id_value_l, org, org_id_type, org_id_key "
    strSql = strSql & "                                        from ags_org_id "
    strSql = strSql & "                                        WHERE org_id_type = 1 "
    strSql = strSql & "                                    ) AS x ON z.cidutCntrPrtNum = x.org_id_value_l "
    strSql = strSql & "                            WHERE (((x.org_id_key) Is Null)) "
    strSql = strSql & "                        ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum "
    strSql = strSql & "                WHERE b.cidutCntrPrtName Is Null "
    strSql = strSql & "            ) as k "
    strSql = strSql & "            Left Join "
    strSql = strSql & "                ( "
    strSql = strSql & "                    SELECT "
    strSql = strSql & "                        c.cn_key, "
    strSql = strSql & "                        iif(isnull(c.cn_number), ""Null»лиѕусто"", iif(c.cn_number = '', ""Null»лиѕусто"", TRIM(c.cn_number))) AS cn_number, "
    strSql = strSql & "                        s.cn_s_key, s.cn_s_type, o.cn_s_org_key, o.org_id, c.cn_date, o.date_beg, o.date_end, "
    strSql = strSql & "                        o.csoCnDate , i.org_id_value_l, g.ogNm "
    strSql = strSql & "                    from "
    strSql = strSql & "                        ( "
    strSql = strSql & "                            ( "
    strSql = strSql & "                                ( "
    strSql = strSql & "                                    ags_cn As c "
    strSql = strSql & "                                    INNER Join "
    strSql = strSql & "                                        ags_cn_s AS s ON c.cn_key = s.cn_key "
    strSql = strSql & "                                ) "
    strSql = strSql & "                                INNER Join "
    strSql = strSql & "                                    ags_cn_s_org AS o ON s.cn_s_key = o.cn_s_key "
    strSql = strSql & "                            ) "
    strSql = strSql & "                            INNER Join "
    strSql = strSql & "                                ags_org_id AS i ON o.org_id = i.org_id_key "
    strSql = strSql & "                        ) "
    strSql = strSql & "                        INNER JOIN ags_og AS g ON i.org = g.ogKey "
    strSql = strSql & "                    WHERE (((s.cn_s_type) = 2)) "
    strSql = strSql & "                ) as l ON (k.cidutCntrPrtNum = l.org_id_value_l) AND (k.cidutCnName = l.cn_number)  AND ((k.cidutCnDate = l.csoCnDate) or (isnull(k.cidutCnDate) and isnull(l.csoCnDate))) "
    strSql = strSql & "        WHERE (((l.cn_key) Is Null)) "
    strSql = strSql & "        GROUP BY k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate "
    strSql = strSql & "    ) as z "
    strSql = strSql & "    Left Join "
    strSql = strSql & "        ( "
    strSql = strSql & "            select iif(isnull(o.cn_number), ""Null»лиѕусто"", iif(o.cn_number = '', ""Null»лиѕусто"", TRIM(o.cn_number))) AS cn_number, o.cn_key "
    strSql = strSql & "            from ags_cn as o "
    strSql = strSql & "        )as y on z.cidutCnName = y.cn_number "
    strSql = strSql & "GROUP BY z.cidutCntrPrtNum, z.cidutCntrPrtName, z.cidutCntrPrtITN, z.cidutCnName, z.cidutCnDate "
    strSql = strSql & "HAVING (((Count(y.cn_key)) > 0))"

    SqlCnExistCtptNotLoad = strSql

End Function
' клеем длинный SQL дл€ процедуры *ќтображаем договора, в которых отсутствует обнаруженный в Ѕƒ исполнитель либо добавл€ем их*, окончание ***********
'****************************************************************************************************************************************************


'****************************************************************************************************************************************************
' клеем длинный SQL дл€ процедуры *ќтображаем отсутствующие в Ѕƒ договоры с исполнител€ми либо добавл€ем их* 19.11.2021 12:38 ***********************
Public Function SqlCnNotLoad() As String

    Dim strSql As String

    strSql = ""

    strSql = strSql & "select "
    strSql = strSql & "    d.cidutCntrPrtNum , x.org_id_key, d.cidutCntrPrtName, d.cidutCntrPrtITN, d.cidutCnName, d.cidutCnDate "
    strSql = strSql & "    , d.cnCount "
    strSql = strSql & "    , e.countCnName "
    strSql = strSql & "FROM "
    strSql = strSql & "    ( "
    strSql = strSql & "        ( "
    strSql = strSql & "            ( "
    strSql = strSql & "                Select "
    strSql = strSql & "                    z.cidutCntrPrtNum, z.cidutCntrPrtName, z.cidutCntrPrtITN, z.cidutCnName, z.cidutCnDate, count(y.cn_key) as cnCount "
    strSql = strSql & "                FROM "
    strSql = strSql & "                    ( "
    strSql = strSql & "                        SELECT "
    strSql = strSql & "                            k.cidutCntrPrtNum , k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate "
    strSql = strSql & "                        FROM "
    strSql = strSql & "                            ( "
    strSql = strSql & "                                SELECT "
    strSql = strSql & "                                    a.cidutAccount, a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCntrPrtITN, "
    strSql = strSql & "                                    iif(isnull(a.cidutCnName), ""Null»лиѕусто"", iif(a.cidutCnName = '', ""Null»лиѕусто"", TRIM(a.cidutCnName))) AS cidutCnName, "
    strSql = strSql & "                                    a.cidutCnDate, "
    strSql = strSql & "                                    a.cidutCnInv, a.cidutFormtnDate, a.cidutMatrtyDate, a.cidutDebt, a.cidutDebtOverdue, a.cidutDoc, "
    strSql = strSql & "                                    a.cidutLink , a.cidutSheet, a.cidutSheetNum, a.cidutUnloadKey "
    strSql = strSql & "                                FROM "
    strSql = strSql & "                                    CnInvDbtUplTbl As a "
    strSql = strSql & "                                    Left Join "
    strSql = strSql & "                                        ( "
    strSql = strSql & "                                            SELECT "
    strSql = strSql & "                                                Z.cidutCntrPrtNum , Z.cidutCntrPrtName, Z.cidutCntrPrtITN, x.org_id_value_l, x.org, x.org_id_key "
    strSql = strSql & "                                            FROM "
    strSql = strSql & "                                                ( "
    strSql = strSql & "                                                    SELECT cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
    strSql = strSql & "                                                    FROM CnInvDbtUplTbl "
    strSql = strSql & "                                                    GROUP BY cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
    strSql = strSql & "                                                ) AS z "
    strSql = strSql & "                                                Left Join "
    strSql = strSql & "                                                    ( "
    strSql = strSql & "                                                        SELECT org_id_value_l, org, org_id_type, org_id_key "
    strSql = strSql & "                                                        FROM ags_org_id "
    strSql = strSql & "                                                        WHERE org_id_type = 1 "
    strSql = strSql & "                                                    ) AS x ON z.cidutCntrPrtNum = x.org_id_value_l "
    strSql = strSql & "                                            WHERE (((x.org_id_key) Is Null)) "
    strSql = strSql & "                                        ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum "
    strSql = strSql & "                                WHERE b.cidutCntrPrtName Is Null "
    strSql = strSql & "                            ) as k "
    strSql = strSql & "                            Left Join "
    strSql = strSql & "                                ( "
    strSql = strSql & "                                    SELECT "
    strSql = strSql & "                                        c.cn_key, "
    strSql = strSql & "                                        iif(isnull(c.cn_number), ""Null»лиѕусто"", iif(c.cn_number = '', ""Null»лиѕусто"", TRIM(c.cn_number))) AS cn_number, "
    strSql = strSql & "                                        s.cn_s_key, s.cn_s_type, o.cn_s_org_key, o.org_id, c.cn_date, o.date_beg, o.date_end, "
    strSql = strSql & "                                        o.csoCnDate , i.org_id_value_l, g.ogNm "
    strSql = strSql & "                                    FROM "
    strSql = strSql & "                                        ( "
    strSql = strSql & "                                            ( "
    strSql = strSql & "                                                ( "
    strSql = strSql & "                                                ags_cn As c "
    strSql = strSql & "                                                INNER Join "
    strSql = strSql & "                                                    ags_cn_s AS s ON c.cn_key = s.cn_key "
    strSql = strSql & "                                            ) "
    strSql = strSql & "                                            INNER Join "
    strSql = strSql & "                                                ags_cn_s_org AS o ON s.cn_s_key = o.cn_s_key "
    strSql = strSql & "                                        ) "
    strSql = strSql & "                                        INNER Join "
    strSql = strSql & "                                            ags_org_id AS i ON o.org_id = i.org_id_key "
    strSql = strSql & "                                    ) "
    strSql = strSql & "                                    INNER JOIN ags_og AS g ON i.org = g.ogKey "
    strSql = strSql & "                                WHERE (((s.cn_s_type) = 2)) "
    strSql = strSql & "                            ) as l ON (k.cidutCntrPrtNum = l.org_id_value_l) AND (k.cidutCnName = l.cn_number)  AND ((k.cidutCnDate = l.csoCnDate) or (isnull(k.cidutCnDate) and isnull(l.csoCnDate))) "
    strSql = strSql & "                    WHERE (((l.cn_key) Is Null)) "
    strSql = strSql & "                    GROUP BY k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate "
    strSql = strSql & "                ) as z "
    strSql = strSql & "                Left Join "
    strSql = strSql & "                    ( "
    strSql = strSql & "                        select iif(isnull(o.cn_number), ""Null»лиѕусто"", iif(o.cn_number = '', ""Null»лиѕусто"", TRIM(o.cn_number))) AS cn_number, o.cn_key "
    strSql = strSql & "                        from ags_cn as o "
    strSql = strSql & "                    )as y on z.cidutCnName = y.cn_number "
    strSql = strSql & "            GROUP BY z.cidutCntrPrtNum, z.cidutCntrPrtName, z.cidutCntrPrtITN, z.cidutCnName, z.cidutCnDate "
    strSql = strSql & "            HAVING (((Count(y.cn_key)) = 0)) "
    strSql = strSql & "        ) as d "
    strSql = strSql & "        Left Join "
    strSql = strSql & "            ( "
    strSql = strSql & "                Select a.cidutCnName, count(a.cidutCnName) as countCnName "
    strSql = strSql & "                FROM "
    strSql = strSql & "                    ( "
    strSql = strSql & "                        Select "
    strSql = strSql & "                            z.cidutCntrPrtNum, z.cidutCntrPrtName, z.cidutCntrPrtITN, z.cidutCnName, z.cidutCnDate, count(y.cn_key) as cnCount "
    strSql = strSql & "                        FROM "
    strSql = strSql & "                            ( "
    strSql = strSql & "                                SELECT "
    strSql = strSql & "                                    k.cidutCntrPrtNum , k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate "
    strSql = strSql & "                                FROM "
    strSql = strSql & "                                    ( "
    strSql = strSql & "                                        SELECT "
    strSql = strSql & "                                            a.cidutAccount, a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCntrPrtITN, "
    strSql = strSql & "                                            iif(isnull(a.cidutCnName), ""Null»лиѕусто"", iif(a.cidutCnName = '', ""Null»лиѕусто"", TRIM(a.cidutCnName))) AS cidutCnName, "
    strSql = strSql & "                                            a.cidutCnDate, "
    strSql = strSql & "                                            a.cidutCnInv, a.cidutFormtnDate, a.cidutMatrtyDate, a.cidutDebt, a.cidutDebtOverdue, a.cidutDoc, "
    strSql = strSql & "                                            a.cidutLink , a.cidutSheet, a.cidutSheetNum, a.cidutUnloadKey "
    strSql = strSql & "                                        FROM "
    strSql = strSql & "                                            CnInvDbtUplTbl As a "
    strSql = strSql & "                                            Left Join "
    strSql = strSql & "                                                ( "
    strSql = strSql & "                                                    SELECT "
    strSql = strSql & "                                                        Z.cidutCntrPrtNum , Z.cidutCntrPrtName, Z.cidutCntrPrtITN, x.org_id_value_l, x.org, x.org_id_key "
    strSql = strSql & "                                                    FROM "
    strSql = strSql & "                                                        ( "
    strSql = strSql & "                                                            SELECT cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
    strSql = strSql & "                                                            FROM CnInvDbtUplTbl "
    strSql = strSql & "                                                            GROUP BY cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
    strSql = strSql & "                                                        ) AS z "
    strSql = strSql & "                                                        Left Join "
    strSql = strSql & "                                                            ( "
    strSql = strSql & "                                                                SELECT org_id_value_l, org, org_id_type, org_id_key "
    strSql = strSql & "                                                                FROM ags_org_id "
    strSql = strSql & "                                                                WHERE org_id_type = 1 "
    strSql = strSql & "                                                            ) AS x ON z.cidutCntrPrtNum = x.org_id_value_l "
    strSql = strSql & "                                                    WHERE (((x.org_id_key) Is Null)) "
    strSql = strSql & "                                                ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum "
    strSql = strSql & "                                        WHERE b.cidutCntrPrtName Is Null "
    strSql = strSql & "                                    ) as k "
    strSql = strSql & "                                    Left Join "
    strSql = strSql & "                                        ( "
    strSql = strSql & "                                            SELECT "
    strSql = strSql & "                                                c.cn_key, "
    strSql = strSql & "                                                iif(isnull(c.cn_number), ""Null»лиѕусто"", iif(c.cn_number = '', ""Null»лиѕусто"", TRIM(c.cn_number))) AS cn_number, "
    strSql = strSql & "                                                s.cn_s_key, s.cn_s_type, o.cn_s_org_key, o.org_id, c.cn_date, o.date_beg, o.date_end, "
    strSql = strSql & "                                                o.csoCnDate , i.org_id_value_l, g.ogNm "
    strSql = strSql & "                                            FROM "
    strSql = strSql & "                                                ( "
    strSql = strSql & "                                                    ( "
    strSql = strSql & "                                                        ( "
    strSql = strSql & "                                                            ags_cn As c "
    strSql = strSql & "                                                            INNER Join "
    strSql = strSql & "                                                                ags_cn_s AS s ON c.cn_key = s.cn_key "
    strSql = strSql & "                                                        ) "
    strSql = strSql & "                                                        INNER Join "
    strSql = strSql & "                                                            ags_cn_s_org AS o ON s.cn_s_key = o.cn_s_key "
    strSql = strSql & "                                                    ) "
    strSql = strSql & "                                                    INNER Join "
    strSql = strSql & "                                                        ags_org_id AS i ON o.org_id = i.org_id_key "
    strSql = strSql & "                                                ) "
    strSql = strSql & "                                                INNER JOIN ags_og AS g ON i.org = g.ogKey "
    strSql = strSql & "                                            WHERE (((s.cn_s_type) = 2)) "
    strSql = strSql & "                                        ) as l ON (k.cidutCntrPrtNum = l.org_id_value_l) AND (k.cidutCnName = l.cn_number)  AND ((k.cidutCnDate = l.csoCnDate) or (isnull(k.cidutCnDate) and isnull(l.csoCnDate))) "
    strSql = strSql & "                                WHERE (((l.cn_key) Is Null)) "
    strSql = strSql & "                                GROUP BY k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate "
    strSql = strSql & "                            ) as z "
    strSql = strSql & "                            Left Join "
    strSql = strSql & "                                ( "
    strSql = strSql & "                                    select iif(isnull(o.cn_number), ""Null»лиѕусто"", iif(o.cn_number = '', ""Null»лиѕусто"", TRIM(o.cn_number))) AS cn_number, o.cn_key "
    strSql = strSql & "                                    from ags_cn as o "
    strSql = strSql & "                                )as y on z.cidutCnName = y.cn_number "
    strSql = strSql & "                        GROUP BY z.cidutCntrPrtNum, z.cidutCntrPrtName, z.cidutCntrPrtITN, z.cidutCnName, z.cidutCnDate "
    strSql = strSql & "                        HAVING (((Count(y.cn_key)) = 0)) "
    strSql = strSql & "                    ) as a "
    strSql = strSql & "                Group by a.cidutCnName "
    strSql = strSql & "            ) as e on d.cidutCnName = e.cidutCnName "
    strSql = strSql & "    ) "
    strSql = strSql & "    Left Join "
    strSql = strSql & "        ( "
    strSql = strSql & "            SELECT org_id_value_l, org, org_id_type, org_id_key "
    strSql = strSql & "            FROM ags_org_id "
    strSql = strSql & "            WHERE org_id_type = 1 "
    strSql = strSql & "        ) AS x ON d.cidutCntrPrtNum = x.org_id_value_l "
    strSql = strSql & ")"

    SqlCnNotLoad = strSql

End Function
' клеем длинный SQL дл€ процедуры *ќтображаем отсутствующие в Ѕƒ договоры с исполнител€ми либо добавл€ем их*, окончание *****************************
'****************************************************************************************************************************************************


'****************************************************************************************************************************************************
' клеем длинный SQL дл€ процедуры *ќтображаем счета-фактуры не имеющие пар #счЄт-фактура + счЄт главной книги# в Ѕƒ либо добавл€ем их* **************
' 18.11.2021 17:37 **********************************************************************************************************************************
Public Function SqlCnCtptInvExistAccNotLoad() As String

    Dim sQ As String
    
    sQ = ""
    
    sQ = sQ & "INSERT INTO ags_cnInvAccnt (ciaCnInv, ciaAccnt) "
    sQ = sQ & "SELECT d.ciKey, d.cidutAccount "
    sQ = sQ & "FROM (SELECT x.cidutCntrPrtNum, x.cidutCntrPrtName, x.cidutCnName, x.cidutCnDate, x.cn_key, x.cidutCnInv, x.ciKey, x.cidutAccount, x.account_num, w.ciaKey "
    sQ = sQ & "FROM (select "
    sQ = sQ & "            Z.cidutCntrPrtNum , Z.cidutCntrPrtName, Z.cidutCnName, Z.cidutCnDate, Z.cn_key, Z.cidutCnInv, Z.ciKey, y.cidutAccount, y.account_num "
    sQ = sQ & "        from "
    sQ = sQ & "            ( "
    sQ = sQ & "                select "
    sQ = sQ & "                    f.cidutCntrPrtNum , f.cidutCntrPrtName, f.cidutCnName, f.cidutCnDate, f.cn_key, f.cidutCnInv, g.ciKey "
    sQ = sQ & "                from "
    sQ = sQ & "                    ( "
    sQ = sQ & "                        select "
    sQ = sQ & "                            h.cidutCntrPrtNum, h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, "
    sQ = sQ & "                            iif(isnull(h.cidutCnInv), ""Null»лиѕусто"", iif(h.cidutCnInv = '', ""Null»лиѕусто"", trim(h.cidutCnInv))) as cidutCnInv "
    sQ = sQ & "                        from "
    sQ = sQ & "                            ( "
    sQ = sQ & "                                select u.cidutCntrPrtNum, u.cidutCntrPrtName, u.cidutCntrPrtITN, u.cidutCnName, u.cidutCnDate, u.cn_key, t.cidutCnInv, t.cidutAccount "
    sQ = sQ & "                                from "
    sQ = sQ & "                                    ( "
    sQ = sQ & "                                        SELECT "
    sQ = sQ & "                                            k.cidutCntrPrtNum , k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
    sQ = sQ & "                                        from "
    sQ = sQ & "                                            ( "
    sQ = sQ & "                                                SELECT "
    sQ = sQ & "                                                    a.cidutAccount, a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCntrPrtITN, a.cidutCnDate, "
    sQ = sQ & "                                                    iif(isnull(a.cidutCnName), ""Null»лиѕусто"", iif(a.cidutCnName = '', ""Null»лиѕусто"", TRIM(a.cidutCnName))) AS cidutCnName, "
    sQ = sQ & "                                                    a.cidutCnInv, a.cidutFormtnDate, a.cidutMatrtyDate, a.cidutDebt, a.cidutDebtOverdue, a.cidutDoc, "
    sQ = sQ & "                                                    a.cidutLink , a.cidutSheet, a.cidutSheetNum, a.cidutUnloadKey "
    sQ = sQ & "                                                from "
    sQ = sQ & "                                                    CnInvDbtUplTbl As a "
    sQ = sQ & "                                                    Left Join "
    sQ = sQ & "                                                        ( "
    sQ = sQ & "                                                            SELECT "
    sQ = sQ & "                                                                Z.cidutCntrPrtNum , Z.cidutCntrPrtName, Z.cidutCntrPrtITN, x.org_id_value_l, x.org, x.org_id_key "
    sQ = sQ & "                                                            from "
    sQ = sQ & "                                                                ( "
    sQ = sQ & "                                                                    SELECT cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
    sQ = sQ & "                                                                    from CnInvDbtUplTbl "
    sQ = sQ & "                                                                    GROUP BY cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
    sQ = sQ & "                                                                ) AS z "
    sQ = sQ & "                                                                Left Join "
    sQ = sQ & "                                                                    ( "
    sQ = sQ & "                                                                        SELECT org_id_value_l, org, org_id_type, org_id_key "
    sQ = sQ & "                                                                        from ags_org_id "
    sQ = sQ & "                                                                        where org_id_type = 1 "
    sQ = sQ & "                                                                    ) AS x ON z.cidutCntrPrtNum = x.org_id_value_l "
    sQ = sQ & "                                                            where (((x.org_id_key) Is Null)) "
    sQ = sQ & "                                                        ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum "
    sQ = sQ & "                                                where b.cidutCntrPrtName Is Null "
    sQ = sQ & "                                            ) as k "
    sQ = sQ & "                                            Left Join "
    sQ = sQ & "                                                ( "
    sQ = sQ & "                                                    SELECT "
    sQ = sQ & "                                                        c.cn_key, "
    sQ = sQ & "                                                        iif(isnull(c.cn_number), ""Null»лиѕусто"", iif(c.cn_number = '', ""Null»лиѕусто"", TRIM(c.cn_number))) AS cn_number, "
    sQ = sQ & "                                                        s.cn_s_key, s.cn_s_type, o.cn_s_org_key, o.org_id, c.cn_date, o.date_beg, o.date_end, "
    sQ = sQ & "                                                        o.csoCnDate , i.org_id_value_l, g.ogNm "
    sQ = sQ & "                                                    from "
    sQ = sQ & "                                                        ( "
    sQ = sQ & "                                                            ( "
    sQ = sQ & "                                                                ( "
    sQ = sQ & "                                                                    ags_cn As c "
    sQ = sQ & "                                                                    inner Join "
    sQ = sQ & "                                                                        ags_cn_s AS s ON c.cn_key = s.cn_key "
    sQ = sQ & "                                                                ) "
    sQ = sQ & "                                                                inner Join "
    sQ = sQ & "                                                                    ags_cn_s_org AS o ON s.cn_s_key = o.cn_s_key "
    sQ = sQ & "                                                            ) "
    sQ = sQ & "                                                            inner Join "
    sQ = sQ & "                                                                ags_org_id AS i ON o.org_id = i.org_id_key "
    sQ = sQ & "                                                        ) "
    sQ = sQ & "                                                        INNER JOIN ags_og AS g ON i.org = g.ogKey "
    sQ = sQ & "                                                    where (((s.cn_s_type) = 2)) "
    sQ = sQ & "                                                ) as l ON (k.cidutCntrPrtNum = l.org_id_value_l) AND (k.cidutCnName = l.cn_number)  AND ((k.cidutCnDate = l.csoCnDate) or (isnull(k.cidutCnDate) and isnull(l.csoCnDate))) "
    sQ = sQ & "                                        where (((l.cn_key) Is Not Null)) "
    sQ = sQ & "                                        GROUP BY k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
    sQ = sQ & "                                    ) as u "
    sQ = sQ & "                                Left Join "
    sQ = sQ & "                                    CnInvDbtUplTbl As t "
    sQ = sQ & "                                    on u.cidutCntrPrtNum = t.cidutCntrPrtNum and u.cidutCnName = t.cidutCnName and (u.cidutCnDate = t.cidutCnDate or (isnull(u.cidutCnDate) and isnull(t.cidutCnDate))) "
    sQ = sQ & "                            ) as h "
    sQ = sQ & "                        Group by "
    sQ = sQ & "                            h.cidutCntrPrtNum , h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, h.cidutCnInv "
    sQ = sQ & "                    ) as f "
    sQ = sQ & "                    Left Join "
    sQ = sQ & "                        ( "
    sQ = sQ & "                            select "
    sQ = sQ & "                                i.ciKey, i.ciCn, iif(isnull(i.ciNum), ""Null»лиѕусто"", iif(i.ciNum = '', ""Null»лиѕусто"", trim(i.ciNum))) as ciNum "
    sQ = sQ & "                            from "
    sQ = sQ & "                                ags_cnInv i "
    sQ = sQ & "                        ) as g on f.cn_key = g.ciCn and f.cidutCnInv = g.ciNum "
    sQ = sQ & "                where g.ciKey Is Not Null "
    sQ = sQ & "            ) as z "
    sQ = sQ & "            Left Join "
    sQ = sQ & "                ( "
    sQ = sQ & "                    select "
    sQ = sQ & "                        i.cidutCntrPrtNum, "
    sQ = sQ & "                        iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
    sQ = sQ & "                        i.cidutCnDate, ii.account_num, "
    sQ = sQ & "                        iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
    sQ = sQ & "                        i.cidutAccount "
    sQ = sQ & "                    from "
    sQ = sQ & "                        CnInvDbtUplTbl As i "
    sQ = sQ & "                        inner Join "
    sQ = sQ & "                            ags_accnt as ii on i.cidutAccount = ii.account_key "
    sQ = sQ & "                ) as y on z.cidutCntrPrtNum = y.cidutCntrPrtNum and z.cidutCnName = y.cidutCnName "
    sQ = sQ & "                    and (z.cidutCnDate = y.cidutCnDate or (isnull(z.cidutCnDate) and isnull(y.cidutCnDate))) and z.cidutCnInv = y.cidutCnInv "
    sQ = sQ & "    )  AS x LEFT JOIN ags_cnInvAccnt AS w ON (x.cidutAccount = w.ciaAccnt) AND (x.ciKey = w.ciaCnInv) "
    sQ = sQ & "WHERE (((w.ciaKey) Is Null)) "
    sQ = sQ & ")  AS d "
    sQ = sQ & "GROUP BY d.ciKey, d.cidutAccount; "

    SqlCnCtptInvExistAccNotLoad = sQ

End Function
' клеем длинный SQL дл€ процедуры *ќтображаем счета-фактуры не имеющие пар #счЄт-фактура + счЄт главной книги# в Ѕƒ либо добавл€ем их*, окончание ***
'****************************************************************************************************************************************************

'****************************************************************************************************************************************************
' клеем длинный SQL дл€ процедуры *ќтображаем счета-фактуры не имеющие пар #счЄт-фактура + счЄт главной книги# в Ѕƒ* 18.11.2021 14:43 ***************
Public Function SqlCnCtptInvExistAccNot() As String

    Dim strSql As String

    strSql = ""
    
    strSql = strSql & "select "
    strSql = strSql & "    x.cidutCntrPrtNum , x.cidutCntrPrtName, x.cidutCnName, x.cidutCnDate, x.cn_key, x.cidutCnInv, x.ciKey, x.cidutAccount, x.account_num, w.ciaKey "
    strSql = strSql & "from "
    strSql = strSql & "    ( "
    strSql = strSql & "        select "
    strSql = strSql & "            Z.cidutCntrPrtNum , Z.cidutCntrPrtName, Z.cidutCnName, Z.cidutCnDate, Z.cn_key, Z.cidutCnInv, Z.ciKey, y.cidutAccount, y.account_num "
    strSql = strSql & "        from "
    strSql = strSql & "            ( "
    strSql = strSql & "                select "
    strSql = strSql & "                    f.cidutCntrPrtNum , f.cidutCntrPrtName, f.cidutCnName, f.cidutCnDate, f.cn_key, f.cidutCnInv, g.ciKey "
    strSql = strSql & "                from "
    strSql = strSql & "                    ( "
    strSql = strSql & "                        select "
    strSql = strSql & "                            h.cidutCntrPrtNum, h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, "
    strSql = strSql & "                            iif(isnull(h.cidutCnInv), ""Null»лиѕусто"", iif(h.cidutCnInv = '', ""Null»лиѕусто"", trim(h.cidutCnInv))) as cidutCnInv "
    strSql = strSql & "                        from "
    strSql = strSql & "                            ( "
    strSql = strSql & "                                select u.cidutCntrPrtNum, u.cidutCntrPrtName, u.cidutCntrPrtITN, u.cidutCnName, u.cidutCnDate, u.cn_key, t.cidutCnInv, t.cidutAccount "
    strSql = strSql & "                                from "
    strSql = strSql & "                                    ( "
    strSql = strSql & "                                        SELECT "
    strSql = strSql & "                                            k.cidutCntrPrtNum , k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
    strSql = strSql & "                                        from "
    strSql = strSql & "                                            ( "
    strSql = strSql & "                                                SELECT "
    strSql = strSql & "                                                    a.cidutAccount, a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCntrPrtITN, a.cidutCnDate, "
    strSql = strSql & "                                                    iif(isnull(a.cidutCnName), ""Null»лиѕусто"", iif(a.cidutCnName = '', ""Null»лиѕусто"", TRIM(a.cidutCnName))) AS cidutCnName, "
    strSql = strSql & "                                                    a.cidutCnInv, a.cidutFormtnDate, a.cidutMatrtyDate, a.cidutDebt, a.cidutDebtOverdue, a.cidutDoc, "
    strSql = strSql & "                                                    a.cidutLink , a.cidutSheet, a.cidutSheetNum, a.cidutUnloadKey "
    strSql = strSql & "                                                from "
    strSql = strSql & "                                                    CnInvDbtUplTbl As a "
    strSql = strSql & "                                                    Left Join "
    strSql = strSql & "                                                        ( "
    strSql = strSql & "                                                            SELECT "
    strSql = strSql & "                                                                Z.cidutCntrPrtNum , Z.cidutCntrPrtName, Z.cidutCntrPrtITN, x.org_id_value_l, x.org, x.org_id_key "
    strSql = strSql & "                                                            from "
    strSql = strSql & "                                                                ( "
    strSql = strSql & "                                                                    SELECT cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
    strSql = strSql & "                                                                    from CnInvDbtUplTbl "
    strSql = strSql & "                                                                    GROUP BY cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
    strSql = strSql & "                                                                ) AS z "
    strSql = strSql & "                                                                Left Join "
    strSql = strSql & "                                                                    ( "
    strSql = strSql & "                                                                        SELECT org_id_value_l, org, org_id_type, org_id_key "
    strSql = strSql & "                                                                        from ags_org_id "
    strSql = strSql & "                                                                        where org_id_type = 1 "
    strSql = strSql & "                                                                    ) AS x ON z.cidutCntrPrtNum = x.org_id_value_l "
    strSql = strSql & "                                                            where (((x.org_id_key) Is Null)) "
    strSql = strSql & "                                                        ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum "
    strSql = strSql & "                                                where b.cidutCntrPrtName Is Null "
    strSql = strSql & "                                            ) as k "
    strSql = strSql & "                                            Left Join "
    strSql = strSql & "                                                ( "
    strSql = strSql & "                                                    SELECT "
    strSql = strSql & "                                                        c.cn_key, "
    strSql = strSql & "                                                        iif(isnull(c.cn_number), ""Null»лиѕусто"", iif(c.cn_number = '', ""Null»лиѕусто"", TRIM(c.cn_number))) AS cn_number, "
    strSql = strSql & "                                                        s.cn_s_key, s.cn_s_type, o.cn_s_org_key, o.org_id, c.cn_date, o.date_beg, o.date_end, "
    strSql = strSql & "                                                        o.csoCnDate , i.org_id_value_l, g.ogNm "
    strSql = strSql & "                                                    from "
    strSql = strSql & "                                                        ( "
    strSql = strSql & "                                                            ( "
    strSql = strSql & "                                                                ( "
    strSql = strSql & "                                                                    ags_cn As c "
    strSql = strSql & "                                                                    inner Join "
    strSql = strSql & "                                                                        ags_cn_s AS s ON c.cn_key = s.cn_key "
    strSql = strSql & "                                                                ) "
    strSql = strSql & "                                                                inner Join "
    strSql = strSql & "                                                                    ags_cn_s_org AS o ON s.cn_s_key = o.cn_s_key "
    strSql = strSql & "                                                            ) "
    strSql = strSql & "                                                            inner Join "
    strSql = strSql & "                                                                ags_org_id AS i ON o.org_id = i.org_id_key "
    strSql = strSql & "                                                        ) "
    strSql = strSql & "                                                        INNER JOIN ags_og AS g ON i.org = g.ogKey "
    strSql = strSql & "                                                    where (((s.cn_s_type) = 2)) "
    strSql = strSql & "                                                ) as l ON (k.cidutCntrPrtNum = l.org_id_value_l) AND (k.cidutCnName = l.cn_number)  AND ((k.cidutCnDate = l.csoCnDate) or (isnull(k.cidutCnDate) and isnull(l.csoCnDate))) "
    strSql = strSql & "                                        where (((l.cn_key) Is Not Null)) "
    strSql = strSql & "                                        GROUP BY k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
    strSql = strSql & "                                    ) as u "
    strSql = strSql & "                                Left Join "
    strSql = strSql & "                                    CnInvDbtUplTbl As t "
    strSql = strSql & "                                    on u.cidutCntrPrtNum = t.cidutCntrPrtNum and u.cidutCnName = t.cidutCnName and (u.cidutCnDate = t.cidutCnDate or (isnull(u.cidutCnDate) and isnull(t.cidutCnDate))) "
    strSql = strSql & "                            ) as h "
    strSql = strSql & "                        Group by "
    strSql = strSql & "                            h.cidutCntrPrtNum , h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, h.cidutCnInv "
    strSql = strSql & "                    ) as f "
    strSql = strSql & "                    Left Join "
    strSql = strSql & "                        ( "
    strSql = strSql & "                            select "
    strSql = strSql & "                                i.ciKey, i.ciCn, iif(isnull(i.ciNum), ""Null»лиѕусто"", iif(i.ciNum = '', ""Null»лиѕусто"", trim(i.ciNum))) as ciNum "
    strSql = strSql & "                            from "
    strSql = strSql & "                                ags_cnInv i "
    strSql = strSql & "                        ) as g on f.cn_key = g.ciCn and f.cidutCnInv = g.ciNum "
    strSql = strSql & "                where g.ciKey Is Not Null "
    strSql = strSql & "            ) as z "
    strSql = strSql & "            Left Join "
    strSql = strSql & "                ( "
    strSql = strSql & "                    select "
    strSql = strSql & "                        i.cidutCntrPrtNum, "
    strSql = strSql & "                        iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
    strSql = strSql & "                        i.cidutCnDate, ii.account_num, "
    strSql = strSql & "                        iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
    strSql = strSql & "                        i.cidutAccount "
    strSql = strSql & "                    from "
    strSql = strSql & "                        CnInvDbtUplTbl As i "
    strSql = strSql & "                        inner Join "
    strSql = strSql & "                            ags_accnt as ii on i.cidutAccount = ii.account_key "
    strSql = strSql & "                ) as y on z.cidutCntrPrtNum = y.cidutCntrPrtNum and z.cidutCnName = y.cidutCnName "
    strSql = strSql & "                    and (z.cidutCnDate = y.cidutCnDate or (isnull(z.cidutCnDate) and isnull(y.cidutCnDate))) and z.cidutCnInv = y.cidutCnInv "
    strSql = strSql & "    ) as x "
    strSql = strSql & "    Left Join "
    strSql = strSql & "        ags_cnInvAccnt as w on x.ciKey = w.ciaCnInv and x.cidutAccount = w.ciaAccnt "
    strSql = strSql & "where "
    strSql = strSql & "    w.ciaKey is null"

    SqlCnCtptInvExistAccNot = strSql

End Function
' клеем длинный SQL дл€ процедуры *ќтображаем счета-фактуры не имеющие пар #счЄт-фактура + счЄт главной книги# в Ѕƒ*, окончание *********************
'****************************************************************************************************************************************************

'****************************************************************************************************************************************************
' клеем длинный SQL дл€ процедуры *ќтображаем пары —‘+—√  имеющие задолженности в Ѕƒ* 18.11.2021 15:39 **********************************************
Public Function SqlCnCtptInvAccDbtExist() As String

    Dim sQ As String
    
    sQ = ""
    
    sQ = sQ & "select "
    sQ = sQ & " n.cidutCntrPrtNum, n.cidutCntrPrtName, n.cidutCnName, n.cidutCnDate, n.cn_key, n.cidutCnInv, n.ciKey,  "
    sQ = sQ & " n.cidutAccount, n.account_num, n.ciaKey, n.cidutUnloadKey, n.cidutUnloadKeyCount, "
    sQ = sQ & " n.cidutFormtnDate, n.cidutMatrtyDate, n.cidutDebt, n.cidutDebtOverdue, n.cidutDoc, n.cidutLink, n.cidutSheet, n.cidutSheetNum, "
    sQ = sQ & " m.cn_inv_date_start, m.cn_inv_date_maturity, m.dbt_ttl, m.dbt_overd, m.doc_base, m.link, m.number, m.cidCounterParty, m.cn_inv_dbt_key, "
    sQ = sQ & " iif(n.cidutFormtnDate = m.cn_inv_date_start, true, false) as FormtnDateDiff, "
    sQ = sQ & " iif(n.cidutMatrtyDate = m.cn_inv_date_maturity, true, false) as MatrtyDateDiff, "
    sQ = sQ & " iif(n.cidutDebt = m.dbt_ttl, true, false) as DebtDiff, "
    sQ = sQ & " iif(n.cidutDebtOverdue = m.dbt_overd, true, false) as DebtOverdueDiff, "
    sQ = sQ & " iif(iif(isnull(n.cidutDoc), ""пусто"",iif(n.cidutDoc = '', ""пусто"", n.cidutDoc)) = iif(isnull(m.doc_base), ""пусто"",iif(m.doc_base = '', ""пусто"", m.doc_base)), true, false) as DocDiff, "
    sQ = sQ & " iif(iif(isnull(n.cidutLink), ""пусто"",iif(n.cidutLink = '', ""пусто"", n.cidutLink)) = iif(isnull(m.link), ""пусто"",iif(m.link = '', ""пусто"", m.link)), true, false) as LinkDiff, "
    sQ = sQ & " iif(n.cidutSheetNum = m.Number, True, False) As NumDiff "
    sQ = sQ & "from "
    sQ = sQ & " ( "
    sQ = sQ & "     select "
    sQ = sQ & "         * "
    sQ = sQ & "     from "
    sQ = sQ & "         ciduCnCtptInvAccExistCount "
    sQ = sQ & "     where cidutUnloadKeyCount = 1 "
    sQ = sQ & " ) as n "
    sQ = sQ & " left join "
    sQ = sQ & "     ags_cn_inv_dbt as m on n.cidutUnloadKey = m.cn_inv_dbt_upl and n.ciaKey = m.cidCnInvAccnt "
    sQ = sQ & "where "
    sQ = sQ & "  m.cn_inv_dbt_key is not null "
    
    
'    sQ = sQ & "select "
'    sQ = sQ & " n.cidutCntrPrtNum, n.cidutCntrPrtName, n.cidutCnName, n.cidutCnDate, n.cn_key, n.cidutCnInv, n.ciKey,  "
'    sQ = sQ & " n.cidutAccount, n.account_num, n.ciaKey, n.cidutUnloadKey, n.cidutUnloadKeyCount, "
'    sQ = sQ & " n.cidutFormtnDate, n.cidutMatrtyDate, n.cidutDebt, n.cidutDebtOverdue, n.cidutDoc, n.cidutLink, n.cidutSheet, n.cidutSheetNum, "
'    sQ = sQ & " m.cn_inv_date_start, m.cn_inv_date_maturity, m.dbt_ttl, m.dbt_overd, m.doc_base, m.link, m.number, m.cidCounterParty, m.cn_inv_dbt_key, "
'    sQ = sQ & " iif(n.cidutFormtnDate = m.cn_inv_date_start, true, false) as FormtnDateDiff, "
'    sQ = sQ & " iif(n.cidutMatrtyDate = m.cn_inv_date_maturity, true, false) as MatrtyDateDiff, "
'    sQ = sQ & " iif(n.cidutDebt = m.dbt_ttl, true, false) as DebtDiff, "
'    sQ = sQ & " iif(n.cidutDebtOverdue = m.dbt_overd, true, false) as DebtOverdueDiff, "
'    sQ = sQ & " iif(iif(isnull(n.cidutDoc), ""пусто"",iif(n.cidutDoc = '', ""пусто"", n.cidutDoc)) = iif(isnull(m.doc_base), ""пусто"",iif(m.doc_base = '', ""пусто"", m.doc_base)), true, false) as DocDiff, "
'    sQ = sQ & " iif(iif(isnull(n.cidutLink), ""пусто"",iif(n.cidutLink = '', ""пусто"", n.cidutLink)) = iif(isnull(m.link), ""пусто"",iif(m.link = '', ""пусто"", m.link)), true, false) as LinkDiff, "
'    sQ = sQ & " iif(n.cidutSheetNum = m.Number, True, False) As NumDiff "
'    sQ = sQ & "from "
'    sQ = sQ & " ( "
'    sQ = sQ & "     select "
'    sQ = sQ & "         j.cidutCntrPrtNum, j.cidutCntrPrtName, j.cidutCnName, j.cidutCnDate, j.cn_key, j.cidutCnInv, j.ciKey,  "
'    sQ = sQ & "         j.cidutAccount, j.account_num, j.ciaKey, j.cidutUnloadKey, k.cidutUnloadKeyCount, "
'    sQ = sQ & "         j.cidutFormtnDate, j.cidutMatrtyDate, j.cidutDebt, j.cidutDebtOverdue, j.cidutDoc, j.cidutLink, j.cidutSheet, j.cidutSheetNum "
'    sQ = sQ & "     from "
'    sQ = sQ & "         ( "
'    sQ = sQ & "             select "
'    sQ = sQ & "                 a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCnName, a.cidutCnDate, a.cn_key, a.cidutCnInv, a.ciKey,  "
'    sQ = sQ & "                 a.cidutAccount, a.account_num, a.ciaKey, b.cidutUnloadKey,  "
'    sQ = sQ & "                 b.cidutFormtnDate, b.cidutMatrtyDate, b.cidutDebt, b.cidutDebtOverdue, b.cidutDoc, b.cidutLink, b.cidutSheet, b.cidutSheetNum "
'    sQ = sQ & "             from "
'    sQ = sQ & "                 ( "
'    sQ = sQ & "                     select "
'    sQ = sQ & "                         x.cidutCntrPrtNum, x.cidutCntrPrtName, x.cidutCnName, x.cidutCnDate, x.cn_key, x.cidutCnInv, x.ciKey,  "
'    sQ = sQ & "                         x.cidutAccount, x.account_num, w.ciaKey "
'    sQ = sQ & "                     from "
'    sQ = sQ & "                         ( "
'    sQ = sQ & "                             select "
'    sQ = sQ & "                                 z.cidutCntrPrtNum, z.cidutCntrPrtName, z.cidutCnName, z.cidutCnDate, z.cn_key, z.cidutCnInv, z.ciKey, y.cidutAccount, y.account_num "
'    sQ = sQ & "                             from "
'    sQ = sQ & "                                 ( "
'    sQ = sQ & "                                     select  "
'    sQ = sQ & "                                         f.cidutCntrPrtNum, f.cidutCntrPrtName, f.cidutCnName, f.cidutCnDate, f.cn_key, f.cidutCnInv, g.ciKey "
'    sQ = sQ & "                                     from "
'    sQ = sQ & "                                         ( "
'    sQ = sQ & "                                             select  "
'    sQ = sQ & "                                                 h.cidutCntrPrtNum, h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key,  "
'    sQ = sQ & "                                                 iif(isnull(h.cidutCnInv), ""Null»лиѕусто"", iif(h.cidutCnInv = '', ""Null»лиѕусто"", trim(h.cidutCnInv))) as cidutCnInv "
'    sQ = sQ & "                                             from "
'    sQ = sQ & "                                                 ( "
'    sQ = sQ & "                                                     select u.cidutCntrPrtNum, u.cidutCntrPrtName, u.cidutCntrPrtITN, u.cidutCnName, u.cidutCnDate, u.cn_key, t.cidutCnInv, t.cidutAccount "
'    sQ = sQ & "                                                     from "
'    sQ = sQ & "                                                         ( "
'    sQ = sQ & "                                                             SELECT  "
'    sQ = sQ & "                                                                 k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
'    sQ = sQ & "                                                             From "
'    sQ = sQ & "                                                                 ( "
'    sQ = sQ & "                                                                     SELECT  "
'    sQ = sQ & "                                                                         a.cidutAccount, a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCntrPrtITN, a.cidutCnDate,  "
'    sQ = sQ & "                                                                         iif(isnull(a.cidutCnName), ""Null»лиѕусто"", iif(a.cidutCnName = '', ""Null»лиѕусто"", TRIM(a.cidutCnName))) AS cidutCnName,  "
'    sQ = sQ & "                                                                         a.cidutCnInv, a.cidutFormtnDate, a.cidutMatrtyDate, a.cidutDebt, a.cidutDebtOverdue, a.cidutDoc,  "
'    sQ = sQ & "                                                                         a.cidutLink, a.cidutSheet, a.cidutSheetNum, a.cidutUnloadKey "
'    sQ = sQ & "                                                                     FROM  "
'    sQ = sQ & "                                                                         CnInvDbtUplTbl as a "
'    sQ = sQ & "                                                                         Left join "
'    sQ = sQ & "                                                                             ( "
'    sQ = sQ & "                                                                                 SELECT  "
'    sQ = sQ & "                                                                                     z.cidutCntrPrtNum, z.cidutCntrPrtName, z.cidutCntrPrtITN, x.org_id_value_l, x.org, x.org_id_key  "
'    sQ = sQ & "                                                                                 FROM  "
'    sQ = sQ & "                                                                                     ( "
'    sQ = sQ & "                                                                                         SELECT cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN  "
'    sQ = sQ & "                                                                                         FROM CnInvDbtUplTbl  "
'    sQ = sQ & "                                                                                         GROUP BY cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
'    sQ = sQ & "                                                                                     ) AS z  "
'    sQ = sQ & "                                                                                     LEFT JOIN  "
'    sQ = sQ & "                                                                                         ( "
'    sQ = sQ & "                                                                                             SELECT org_id_value_l, org, org_id_type, org_id_key  "
'    sQ = sQ & "                                                                                             FROM ags_org_id  "
'    sQ = sQ & "                                                                                             WHERE org_id_type = 1 "
'    sQ = sQ & "                                                                                         ) AS x ON z.cidutCntrPrtNum = x.org_id_value_l  "
'    sQ = sQ & "                                                                                 WHERE (((x.org_id_key) Is Null))  "
'    sQ = sQ & "                                                                             ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum "
'    sQ = sQ & "                                                                     where b.cidutCntrPrtName is null "
'    sQ = sQ & "                                                                 ) as k "
'    sQ = sQ & "                                                                 Left join "
'    sQ = sQ & "                                                                     ( "
'    sQ = sQ & "                                                                         SELECT  "
'    sQ = sQ & "                                                                             c.cn_key,  "
'    sQ = sQ & "                                                                             iif(isnull(c.cn_number), ""Null»лиѕусто"", iif(c.cn_number = '', ""Null»лиѕусто"", TRIM(c.cn_number))) AS cn_number,  "
'    sQ = sQ & "                                                                             s.cn_s_key, s.cn_s_type, o.cn_s_org_key, o.org_id, c.cn_date, o.date_beg, o.date_end,  "
'    sQ = sQ & "                                                                             o.csoCnDate, i.org_id_value_l, g.ogNm "
'    sQ = sQ & "                                                                         FROM  "
'    sQ = sQ & "                                                                             ( "
'    sQ = sQ & "                                                                                 ( "
'    sQ = sQ & "                                                                                     ( "
'    sQ = sQ & "                                                                                         ags_cn AS c  "
'    sQ = sQ & "                                                                                         INNER JOIN  "
'    sQ = sQ & "                                                                                             ags_cn_s AS s ON c.cn_key = s.cn_key "
'    sQ = sQ & "                                                                                     )  "
'    sQ = sQ & "                                                                                     INNER JOIN  "
'    sQ = sQ & "                                                                                         ags_cn_s_org AS o ON s.cn_s_key = o.cn_s_key "
'    sQ = sQ & "                                                                                 )  "
'    sQ = sQ & "                                                                                 INNER JOIN  "
'    sQ = sQ & "                                                                                     ags_org_id AS i ON o.org_id = i.org_id_key "
'    sQ = sQ & "                                                                             )  "
'    sQ = sQ & "                                                                             INNER JOIN ags_og AS g ON i.org = g.ogKey "
'    sQ = sQ & "                                                                         WHERE (((s.cn_s_type)=2)) "
'    sQ = sQ & "                                                                     ) as l ON (k.cidutCntrPrtNum = l.org_id_value_l) AND (k.cidutCnName = l.cn_number)  AND ((k.cidutCnDate = l.csoCnDate) or (isnull(k.cidutCnDate) and isnull(l.csoCnDate))) "
'    sQ = sQ & "                                                             WHERE (((l.cn_key) Is not Null)) "
'    sQ = sQ & "                                                             GROUP BY k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
'    sQ = sQ & "                                                         ) as u "
'    sQ = sQ & "                                                     left join "
'    sQ = sQ & "                                                         CnInvDbtUplTbl as t "
'    sQ = sQ & "                                                         on u.cidutCntrPrtNum = t.cidutCntrPrtNum and u.cidutCnName = t.cidutCnName and (u.cidutCnDate = t.cidutCnDate or (isnull(u.cidutCnDate) and isnull(t.cidutCnDate))) "
'    sQ = sQ & "                                                 ) as h "
'    sQ = sQ & "                                             group by "
'    sQ = sQ & "                                                 h.cidutCntrPrtNum, h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, h.cidutCnInv "
'    sQ = sQ & "                                         ) as f "
'    sQ = sQ & "                                         left join "
'    sQ = sQ & "                                             ( "
'    sQ = sQ & "                                                 select  "
'    sQ = sQ & "                                                     i.ciKey, i.ciCn, iif(isnull(i.ciNum), ""Null»лиѕусто"", iif(i.ciNum = '', ""Null»лиѕусто"", trim(i.ciNum))) as ciNum "
'    sQ = sQ & "                                                 from  "
'    sQ = sQ & "                                                     ags_cnInv i "
'    sQ = sQ & "                                             ) as g on f.cn_key = g.ciCn and f.cidutCnInv = g.ciNum "
'    sQ = sQ & "                                     where g.ciKey is not null "
'    sQ = sQ & "                                 ) as z "
'    sQ = sQ & "                                 left join "
'    sQ = sQ & "                                     ( "
'    sQ = sQ & "                                         select "
'    sQ = sQ & "                                             i.cidutCntrPrtNum,  "
'    sQ = sQ & "                                             iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
'    sQ = sQ & "                                             i.cidutCnDate, ii.account_num, "
'    sQ = sQ & "                                             iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
'    sQ = sQ & "                                             i.cidutAccount "
'    sQ = sQ & "                                         from "
'    sQ = sQ & "                                             CnInvDbtUplTbl as i "
'    sQ = sQ & "                                             inner join "
'    sQ = sQ & "                                                 ags_accnt as ii on i.cidutAccount = ii.account_key "
'    sQ = sQ & "                                     ) as y on z.cidutCntrPrtNum = y.cidutCntrPrtNum and z.cidutCnName = y.cidutCnName  "
'    sQ = sQ & "                                         and (z.cidutCnDate = y.cidutCnDate or (isnull(z.cidutCnDate) and isnull(y.cidutCnDate))) and z.cidutCnInv = y.cidutCnInv "
'    sQ = sQ & "                         ) as x "
'    sQ = sQ & "                         left join "
'    sQ = sQ & "                             ags_cnInvAccnt as w on x.ciKey = w.ciaCnInv and x.cidutAccount = w.ciaAccnt "
'    sQ = sQ & "                     where "
'    sQ = sQ & "                         w.ciaKey is not null "
'    sQ = sQ & "                 ) as a "
'    sQ = sQ & "                 left join "
'    sQ = sQ & "                     ( "
'    sQ = sQ & "                         select  "
'    sQ = sQ & "                             i.cidutCntrPrtNum,  "
'    sQ = sQ & "                             iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
'    sQ = sQ & "                             i.cidutCnDate, "
'    sQ = sQ & "                             iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
'    sQ = sQ & "                             i.cidutAccount, i.cidutUnloadKey, "
'    sQ = sQ & "                             i.cidutFormtnDate, i.cidutMatrtyDate, i.cidutDebt, i.cidutDebtOverdue, i.cidutDoc, i.cidutLink, i.cidutSheet, i.cidutSheetNum "
'    sQ = sQ & "                         from "
'    sQ = sQ & "                             CnInvDbtUplTbl as i "
'    sQ = sQ & "                     ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum and a.cidutCnName = b.cidutCnName  "
'    sQ = sQ & "                         and (a.cidutCnDate = b.cidutCnDate or (isnull(a.cidutCnDate) and isnull(b.cidutCnDate))) and a.cidutCnInv = b.cidutCnInv and a.cidutCnInv = b.cidutCnInv and a.cidutAccount = b.cidutAccount "
'    sQ = sQ & "         ) as j "
'    sQ = sQ & "         left join "
'    sQ = sQ & "             ( "
'    sQ = sQ & "                 select "
'    sQ = sQ & "                     h.ciaKey, count(h.cidutUnloadKey) as cidutUnloadKeyCount "
'    sQ = sQ & "                 from "
'    sQ = sQ & "                     ( "
'    sQ = sQ & "                         select "
'    sQ = sQ & "                             a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCnName, a.cidutCnDate, a.cn_key, a.cidutCnInv, a.ciKey,  "
'    sQ = sQ & "                             a.cidutAccount, a.account_num, a.ciaKey, b.cidutUnloadKey "
'    sQ = sQ & "                         from "
'    sQ = sQ & "                             ( "
'    sQ = sQ & "                                 select "
'    sQ = sQ & "                                     x.cidutCntrPrtNum, x.cidutCntrPrtName, x.cidutCnName, x.cidutCnDate, x.cn_key, x.cidutCnInv, x.ciKey, x.cidutAccount, x.account_num, w.ciaKey "
'    sQ = sQ & "                                 from "
'    sQ = sQ & "                                     ( "
'    sQ = sQ & "                                         select "
'    sQ = sQ & "                                             z.cidutCntrPrtNum, z.cidutCntrPrtName, z.cidutCnName, z.cidutCnDate, z.cn_key, z.cidutCnInv, z.ciKey, y.cidutAccount, y.account_num "
'    sQ = sQ & "                                         from "
'    sQ = sQ & "                                             ( "
'    sQ = sQ & "                                                 select  "
'    sQ = sQ & "                                                     f.cidutCntrPrtNum, f.cidutCntrPrtName, f.cidutCnName, f.cidutCnDate, f.cn_key, f.cidutCnInv, g.ciKey "
'    sQ = sQ & "                                                 from "
'    sQ = sQ & "                                                     ( "
'    sQ = sQ & "                                                         select  "
'    sQ = sQ & "                                                             h.cidutCntrPrtNum, h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key,  "
'    sQ = sQ & "                                                             iif(isnull(h.cidutCnInv), ""Null»лиѕусто"", iif(h.cidutCnInv = '', ""Null»лиѕусто"", trim(h.cidutCnInv))) as cidutCnInv "
'    sQ = sQ & "                                                         from "
'    sQ = sQ & "                                                             ( "
'    sQ = sQ & "                                                                 select u.cidutCntrPrtNum, u.cidutCntrPrtName, u.cidutCntrPrtITN, u.cidutCnName, u.cidutCnDate, u.cn_key, t.cidutCnInv, t.cidutAccount "
'    sQ = sQ & "                                                                 from "
'    sQ = sQ & "                                                                     ( "
'    sQ = sQ & "                                                                         SELECT  "
'    sQ = sQ & "                                                                             k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
'    sQ = sQ & "                                                                         From "
'    sQ = sQ & "                                                                             ( "
'    sQ = sQ & "                                                                                 SELECT  "
'    sQ = sQ & "                                                                                     a.cidutAccount, a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCntrPrtITN, a.cidutCnDate,  "
'    sQ = sQ & "                                                                                     iif(isnull(a.cidutCnName), ""Null»лиѕусто"", iif(a.cidutCnName = '', ""Null»лиѕусто"", TRIM(a.cidutCnName))) AS cidutCnName,  "
'    sQ = sQ & "                                                                                     a.cidutCnInv, a.cidutFormtnDate, a.cidutMatrtyDate, a.cidutDebt, a.cidutDebtOverdue, a.cidutDoc,  "
'    sQ = sQ & "                                                                                     a.cidutLink, a.cidutSheet, a.cidutSheetNum, a.cidutUnloadKey "
'    sQ = sQ & "                                                                                 FROM  "
'    sQ = sQ & "                                                                                     CnInvDbtUplTbl as a "
'    sQ = sQ & "                                                                                     Left join "
'    sQ = sQ & "                                                                                         ( "
'    sQ = sQ & "                                                                                             SELECT  "
'    sQ = sQ & "                                                                                                 z.cidutCntrPrtNum, z.cidutCntrPrtName, z.cidutCntrPrtITN, x.org_id_value_l, x.org, x.org_id_key  "
'    sQ = sQ & "                                                                                             FROM  "
'    sQ = sQ & "                                                                                                 ( "
'    sQ = sQ & "                                                                                                     SELECT cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN  "
'    sQ = sQ & "                                                                                                     FROM CnInvDbtUplTbl  "
'    sQ = sQ & "                                                                                                     GROUP BY cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
'    sQ = sQ & "                                                                                                 ) AS z  "
'    sQ = sQ & "                                                                                                 LEFT JOIN  "
'    sQ = sQ & "                                                                                                     ( "
'    sQ = sQ & "                                                                                                         SELECT org_id_value_l, org, org_id_type, org_id_key  "
'    sQ = sQ & "                                                                                                         FROM ags_org_id  "
'    sQ = sQ & "                                                                                                         WHERE org_id_type = 1 "
'    sQ = sQ & "                                                                                                     ) AS x ON z.cidutCntrPrtNum = x.org_id_value_l  "
'    sQ = sQ & "                                                                                             WHERE (((x.org_id_key) Is Null))  "
'    sQ = sQ & "                                                                                         ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum "
'    sQ = sQ & "                                                                                 where b.cidutCntrPrtName is null "
'    sQ = sQ & "                                                                             ) as k "
'    sQ = sQ & "                                                                             Left join "
'    sQ = sQ & "                                                                                 ( "
'    sQ = sQ & "                                                                                     SELECT  "
'    sQ = sQ & "                                                                                         c.cn_key,  "
'    sQ = sQ & "                                                                                         iif(isnull(c.cn_number), ""Null»лиѕусто"", iif(c.cn_number = '', ""Null»лиѕусто"", TRIM(c.cn_number))) AS cn_number,  "
'    sQ = sQ & "                                                                                         s.cn_s_key, s.cn_s_type, o.cn_s_org_key, o.org_id, c.cn_date, o.date_beg, o.date_end,  "
'    sQ = sQ & "                                                                                         o.csoCnDate, i.org_id_value_l, g.ogNm "
'    sQ = sQ & "                                                                                     FROM  "
'    sQ = sQ & "                                                                                         ( "
'    sQ = sQ & "                                                                                             ( "
'    sQ = sQ & "                                                                                                 ( "
'    sQ = sQ & "                                                                                                     ags_cn AS c  "
'    sQ = sQ & "                                                                                                     INNER JOIN  "
'    sQ = sQ & "                                                                                                         ags_cn_s AS s ON c.cn_key = s.cn_key "
'    sQ = sQ & "                                                                                                 )  "
'    sQ = sQ & "                                                                                                 INNER JOIN  "
'    sQ = sQ & "                                                                                                     ags_cn_s_org AS o ON s.cn_s_key = o.cn_s_key "
'    sQ = sQ & "                                                                                             )  "
'    sQ = sQ & "                                                                                             INNER JOIN  "
'    sQ = sQ & "                                                                                                 ags_org_id AS i ON o.org_id = i.org_id_key "
'    sQ = sQ & "                                                                                         )  "
'    sQ = sQ & "                                                                                         INNER JOIN ags_og AS g ON i.org = g.ogKey "
'    sQ = sQ & "                                                                                     WHERE (((s.cn_s_type)=2)) "
'    sQ = sQ & "                                                                                 ) as l ON (k.cidutCntrPrtNum = l.org_id_value_l) AND (k.cidutCnName = l.cn_number)  AND ((k.cidutCnDate = l.csoCnDate) or (isnull(k.cidutCnDate) and isnull(l.csoCnDate))) "
'    sQ = sQ & "                                                                         WHERE (((l.cn_key) Is not Null)) "
'    sQ = sQ & "                                                                         GROUP BY k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
'    sQ = sQ & "                                                                     ) as u "
'    sQ = sQ & "                                                                 left join "
'    sQ = sQ & "                                                                     CnInvDbtUplTbl as t "
'    sQ = sQ & "                                                                     on u.cidutCntrPrtNum = t.cidutCntrPrtNum and u.cidutCnName = t.cidutCnName and (u.cidutCnDate = t.cidutCnDate or (isnull(u.cidutCnDate) and isnull(t.cidutCnDate))) "
'    sQ = sQ & "                                                             ) as h "
'    sQ = sQ & "                                                         group by "
'    sQ = sQ & "                                                             h.cidutCntrPrtNum, h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, h.cidutCnInv "
'    sQ = sQ & "                                                     ) as f "
'    sQ = sQ & "                                                     left join "
'    sQ = sQ & "                                                         ( "
'    sQ = sQ & "                                                             select  "
'    sQ = sQ & "                                                                 i.ciKey, i.ciCn, iif(isnull(i.ciNum), ""Null»лиѕусто"", iif(i.ciNum = '', ""Null»лиѕусто"", trim(i.ciNum))) as ciNum "
'    sQ = sQ & "                                                             from  "
'    sQ = sQ & "                                                                 ags_cnInv i "
'    sQ = sQ & "                                                         ) as g on f.cn_key = g.ciCn and f.cidutCnInv = g.ciNum "
'    sQ = sQ & "                                                 where g.ciKey is not null "
'    sQ = sQ & "                                             ) as z "
'    sQ = sQ & "                                             left join "
'    sQ = sQ & "                                                 ( "
'    sQ = sQ & "                                                     select "
'    sQ = sQ & "                                                         i.cidutCntrPrtNum,  "
'    sQ = sQ & "                                                         iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
'    sQ = sQ & "                                                         i.cidutCnDate, ii.account_num, "
'    sQ = sQ & "                                                         iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
'    sQ = sQ & "                                                         i.cidutAccount "
'    sQ = sQ & "                                                     from "
'    sQ = sQ & "                                                         CnInvDbtUplTbl as i "
'    sQ = sQ & "                                                         inner join "
'    sQ = sQ & "                                                             ags_accnt as ii on i.cidutAccount = ii.account_key "
'    sQ = sQ & "                                                 ) as y on z.cidutCntrPrtNum = y.cidutCntrPrtNum and z.cidutCnName = y.cidutCnName  "
'    sQ = sQ & "                                                     and (z.cidutCnDate = y.cidutCnDate or (isnull(z.cidutCnDate) and isnull(y.cidutCnDate))) and z.cidutCnInv = y.cidutCnInv "
'    sQ = sQ & "                                     ) as x "
'    sQ = sQ & "                                     left join "
'    sQ = sQ & "                                         ags_cnInvAccnt as w on x.ciKey = w.ciaCnInv and x.cidutAccount = w.ciaAccnt "
'    sQ = sQ & "                                 where "
'    sQ = sQ & "                                     w.ciaKey is not null "
'    sQ = sQ & "                             ) as a "
'    sQ = sQ & "                             left join "
'    sQ = sQ & "                                 ( "
'    sQ = sQ & "                                     select  "
'    sQ = sQ & "                                         i.cidutCntrPrtNum,  "
'    sQ = sQ & "                                         iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
'    sQ = sQ & "                                         i.cidutCnDate, "
'    sQ = sQ & "                                         iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
'    sQ = sQ & "                                         i.cidutAccount, i.cidutUnloadKey "
'    sQ = sQ & "                                     from "
'    sQ = sQ & "                                         CnInvDbtUplTbl as i "
'    sQ = sQ & "                                 ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum and a.cidutCnName = b.cidutCnName  "
'    sQ = sQ & "                                     and (a.cidutCnDate = b.cidutCnDate or (isnull(a.cidutCnDate) and isnull(b.cidutCnDate))) and a.cidutCnInv = b.cidutCnInv and a.cidutCnInv = b.cidutCnInv and a.cidutAccount = b.cidutAccount "
'    sQ = sQ & "                     ) as h "
'    sQ = sQ & "                 group by "
'    sQ = sQ & "                     h.ciaKey "
'    sQ = sQ & "             ) as k on j.ciaKey = k.ciaKey "
'    sQ = sQ & "     where k.cidutUnloadKeyCount = 1 "
'    sQ = sQ & " ) as n "
'    sQ = sQ & " left join "
'    sQ = sQ & "     ags_cn_inv_dbt as m on n.cidutUnloadKey = m.cn_inv_dbt_upl and n.ciaKey = m.cidCnInvAccnt "
'    sQ = sQ & "where "
'    sQ = sQ & "  m.cn_inv_dbt_key is not null "
    
    SqlCnCtptInvAccDbtExist = sQ

End Function
' клеем длинный SQL дл€ процедуры *ќтображаем пары —‘+—√  имеющие задолженности в Ѕƒ*, окончание ****************************************************
'****************************************************************************************************************************************************


'****************************************************************************************************************************************************
' клеем длинный SQL дл€ процедуры *ќтображаем пары —‘+—√  не имеющие задолженности в Ѕƒ* 18.11.2021 15:31 *******************************************
Public Function SqlCnCtptInvAccExistDbtNot() As String

    Dim sQ As String
    
    sQ = ""
    
    sQ = sQ & "select "
    sQ = sQ & "    n.cidutCntrPrtNum, n.cidutCntrPrtName, "
    sQ = sQ & "    iif(n.cidutCnName = ""Null»лиѕусто"", null, n.cidutCnName) as cidutCnName, "
    sQ = sQ & "    n.cidutCnDate, n.cn_key, "
    sQ = sQ & "    iif(n.cidutCnInv = ""Null»лиѕусто"", null, n.cidutCnInv) as cidutCnInv, "
    sQ = sQ & "    n.ciKey, "
    sQ = sQ & "    n.cidutAccount, n.account_num, n.ciaKey, n.cidutUnloadKey, n.cidutUnloadKeyCount, "
    sQ = sQ & "    n.cidutFormtnDate, n.cidutMatrtyDate, n.cidutDebt, n.cidutDebtOverdue, n.cidutDoc, n.cidutLink, n.cidutSheet, n.cidutSheetNum, "
    sQ = sQ & "    m.cn_inv_date_start , m.cn_inv_date_maturity, m.dbt_ttl, m.dbt_overd, m.doc_base, m.link, m.Number, m.cidCounterParty, m.cn_inv_dbt_key "
    sQ = sQ & "from "
    sQ = sQ & "    ( "
    sQ = sQ & "         select "
    sQ = sQ & "             * "
    sQ = sQ & "         from "
    sQ = sQ & "             ciduCnCtptInvAccExistCount "
    sQ = sQ & "         where cidutUnloadKeyCount = 1 "
    sQ = sQ & "    ) as n "
    sQ = sQ & "    Left Join "
    sQ = sQ & "        ags_cn_inv_dbt as m on n.cidutUnloadKey = m.cn_inv_dbt_upl and n.ciaKey = m.cidCnInvAccnt "
    sQ = sQ & "where "
    sQ = sQ & "    m.cn_inv_dbt_key is null"

    
'    sQ = sQ & "select "
'    sQ = sQ & "    n.cidutCntrPrtNum, n.cidutCntrPrtName, "
'    sQ = sQ & "    iif(n.cidutCnName = ""Null»лиѕусто"", null, n.cidutCnName) as cidutCnName, "
'    sQ = sQ & "    n.cidutCnDate, n.cn_key, "
'    sQ = sQ & "    iif(n.cidutCnInv = ""Null»лиѕусто"", null, n.cidutCnInv) as cidutCnInv, "
'    sQ = sQ & "    n.ciKey, "
'    sQ = sQ & "    n.cidutAccount, n.account_num, n.ciaKey, n.cidutUnloadKey, n.cidutUnloadKeyCount, "
'    sQ = sQ & "    n.cidutFormtnDate, n.cidutMatrtyDate, n.cidutDebt, n.cidutDebtOverdue, n.cidutDoc, n.cidutLink, n.cidutSheet, n.cidutSheetNum, "
'    sQ = sQ & "    m.cn_inv_date_start , m.cn_inv_date_maturity, m.dbt_ttl, m.dbt_overd, m.doc_base, m.link, m.Number, m.cidCounterParty, m.cn_inv_dbt_key "
'    sQ = sQ & "from "
'    sQ = sQ & "    ( "
'    sQ = sQ & "        select "
'    sQ = sQ & "            j.cidutCntrPrtNum, j.cidutCntrPrtName, j.cidutCnName, j.cidutCnDate, j.cn_key, j.cidutCnInv, j.ciKey, "
'    sQ = sQ & "            j.cidutAccount, j.account_num, j.ciaKey, j.cidutUnloadKey, k.cidutUnloadKeyCount, "
'    sQ = sQ & "            j.cidutFormtnDate , j.cidutMatrtyDate, j.cidutDebt, j.cidutDebtOverdue, j.cidutDoc, j.cidutLink, j.cidutSheet, j.cidutSheetNum "
'    sQ = sQ & "        from "
'    sQ = sQ & "            ( "
'    sQ = sQ & "                select "
'    sQ = sQ & "                    a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCnName, a.cidutCnDate, a.cn_key, a.cidutCnInv, a.ciKey, "
'    sQ = sQ & "                    a.cidutAccount, a.account_num, a.ciaKey, b.cidutUnloadKey, "
'    sQ = sQ & "                    b.cidutFormtnDate , b.cidutMatrtyDate, b.cidutDebt, b.cidutDebtOverdue, b.cidutDoc, b.cidutLink, b.cidutSheet, b.cidutSheetNum "
'    sQ = sQ & "                from "
'    sQ = sQ & "                    ( "
'    sQ = sQ & "                        select "
'    sQ = sQ & "                            x.cidutCntrPrtNum, x.cidutCntrPrtName, x.cidutCnName, x.cidutCnDate, x.cn_key, x.cidutCnInv, x.ciKey, "
'    sQ = sQ & "                            x.cidutAccount , x.account_num, w.ciaKey "
'    sQ = sQ & "                        from "
'    sQ = sQ & "                            ( "
'    sQ = sQ & "                                select "
'    sQ = sQ & "                                    Z.cidutCntrPrtNum , Z.cidutCntrPrtName, Z.cidutCnName, Z.cidutCnDate, Z.cn_key, Z.cidutCnInv, Z.ciKey, y.cidutAccount, y.account_num "
'    sQ = sQ & "                                from "
'    sQ = sQ & "                                    ( "
'    sQ = sQ & "                                        select "
'    sQ = sQ & "                                            f.cidutCntrPrtNum , f.cidutCntrPrtName, f.cidutCnName, f.cidutCnDate, f.cn_key, f.cidutCnInv, g.ciKey "
'    sQ = sQ & "                                        from "
'    sQ = sQ & "                                            ( "
'    sQ = sQ & "                                                select "
'    sQ = sQ & "                                                    h.cidutCntrPrtNum, h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, "
'    sQ = sQ & "                                                    iif(isnull(h.cidutCnInv), ""Null»лиѕусто"", iif(h.cidutCnInv = '', ""Null»лиѕусто"", trim(h.cidutCnInv))) as cidutCnInv "
'    sQ = sQ & "                                                from "
'    sQ = sQ & "                                                    ( "
'    sQ = sQ & "                                                        select u.cidutCntrPrtNum, u.cidutCntrPrtName, u.cidutCntrPrtITN, u.cidutCnName, u.cidutCnDate, u.cn_key, t.cidutCnInv, t.cidutAccount "
'    sQ = sQ & "                                                        from "
'    sQ = sQ & "                                                            ( "
'    sQ = sQ & "                                                                SELECT "
'    sQ = sQ & "                                                                    k.cidutCntrPrtNum , k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
'    sQ = sQ & "                                                                from "
'    sQ = sQ & "                                                                    ( "
'    sQ = sQ & "                                                                        SELECT "
'    sQ = sQ & "                                                                            a.cidutAccount, a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCntrPrtITN, a.cidutCnDate,"
'    sQ = sQ & "                                                                            iif(isnull(a.cidutCnName), ""Null»лиѕусто"", iif(a.cidutCnName = '', ""Null»лиѕусто"", TRIM(a.cidutCnName))) AS cidutCnName,"
'    sQ = sQ & "                                                                            a.cidutCnInv, a.cidutFormtnDate, a.cidutMatrtyDate, a.cidutDebt, a.cidutDebtOverdue, a.cidutDoc,"
'    sQ = sQ & "                                                                            a.cidutLink , a.cidutSheet, a.cidutSheetNum, a.cidutUnloadKey "
'    sQ = sQ & "                                                                        from "
'    sQ = sQ & "                                                                            CnInvDbtUplTbl As a "
'    sQ = sQ & "                                                                            Left Join "
'    sQ = sQ & "                                                                                ( "
'    sQ = sQ & "                                                                                    SELECT "
'    sQ = sQ & "                                                                                        Z.cidutCntrPrtNum , Z.cidutCntrPrtName, Z.cidutCntrPrtITN, x.org_id_value_l, x.org, x.org_id_key "
'    sQ = sQ & "                                                                                    from "
'    sQ = sQ & "                                                                                        ( "
'    sQ = sQ & "                                                                                            SELECT cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
'    sQ = sQ & "                                                                                            from CnInvDbtUplTbl "
'    sQ = sQ & "                                                                                            GROUP BY cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
'    sQ = sQ & "                                                                                        ) AS z "
'    sQ = sQ & "                                                                                        Left Join "
'    sQ = sQ & "                                                                                            ( "
'    sQ = sQ & "                                                                                                SELECT org_id_value_l, org, org_id_type, org_id_key "
'    sQ = sQ & "                                                                                                from ags_org_id "
'    sQ = sQ & "                                                                                                where org_id_type = 1 "
'    sQ = sQ & "                                                                                            ) AS x ON z.cidutCntrPrtNum = x.org_id_value_l "
'    sQ = sQ & "                                                                                    where (((x.org_id_key) Is Null)) "
'    sQ = sQ & "                                                                                ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum "
'    sQ = sQ & "                                                                        where b.cidutCntrPrtName Is Null "
'    sQ = sQ & "                                                                    ) as k "
'    sQ = sQ & "                                                                    Left Join "
'    sQ = sQ & "                                                                        ( "
'    sQ = sQ & "                                                                            SELECT "
'    sQ = sQ & "                                                                                c.cn_key, "
'    sQ = sQ & "                                                                                iif(isnull(c.cn_number), ""Null»лиѕусто"", iif(c.cn_number = '', ""Null»лиѕусто"", TRIM(c.cn_number))) AS cn_number, "
'    sQ = sQ & "                                                                                s.cn_s_key, s.cn_s_type, o.cn_s_org_key, o.org_id, c.cn_date, o.date_beg, o.date_end, "
'    sQ = sQ & "                                                                                o.csoCnDate , i.org_id_value_l, g.ogNm "
'    sQ = sQ & "                                                                            from "
'    sQ = sQ & "                                                                                ( "
'    sQ = sQ & "                                                                                    ( "
'    sQ = sQ & "                                                                                        ( "
'    sQ = sQ & "                                                                                            ags_cn As c "
'    sQ = sQ & "                                                                                            inner Join "
'    sQ = sQ & "                                                                                                ags_cn_s AS s ON c.cn_key = s.cn_key "
'    sQ = sQ & "                                                                                        ) "
'    sQ = sQ & "                                                                                        inner Join "
'    sQ = sQ & "                                                                                            ags_cn_s_org AS o ON s.cn_s_key = o.cn_s_key "
'    sQ = sQ & "                                                                                    ) "
'    sQ = sQ & "                                                                                    inner Join "
'    sQ = sQ & "                                                                                        ags_org_id AS i ON o.org_id = i.org_id_key "
'    sQ = sQ & "                                                                                ) "
'    sQ = sQ & "                                                                                INNER JOIN ags_og AS g ON i.org = g.ogKey "
'    sQ = sQ & "                                                                            where (((s.cn_s_type) = 2)) "
'    sQ = sQ & "                                                                        ) as l ON (k.cidutCntrPrtNum = l.org_id_value_l) AND (k.cidutCnName = l.cn_number)  AND ((k.cidutCnDate = l.csoCnDate) or (isnull(k.cidutCnDate) and isnull(l.csoCnDate))) "
'    sQ = sQ & "                                                                where (((l.cn_key) Is Not Null)) "
'    sQ = sQ & "                                                                GROUP BY k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
'    sQ = sQ & "                                                            ) as u "
'    sQ = sQ & "                                                        Left Join "
'    sQ = sQ & "                                                            CnInvDbtUplTbl As t "
'    sQ = sQ & "                                                            on u.cidutCntrPrtNum = t.cidutCntrPrtNum and u.cidutCnName = t.cidutCnName and (u.cidutCnDate = t.cidutCnDate or (isnull(u.cidutCnDate) and isnull(t.cidutCnDate))) "
'    sQ = sQ & "                                                    ) as h "
'    sQ = sQ & "                                                Group by "
'    sQ = sQ & "                                                    h.cidutCntrPrtNum , h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, h.cidutCnInv "
'    sQ = sQ & "                                            ) as f "
'    sQ = sQ & "                                            Left Join "
'    sQ = sQ & "                                                ( "
'    sQ = sQ & "                                                    select "
'    sQ = sQ & "                                                        i.ciKey, i.ciCn, iif(isnull(i.ciNum), ""Null»лиѕусто"", iif(i.ciNum = '', ""Null»лиѕусто"", trim(i.ciNum))) as ciNum "
'    sQ = sQ & "                                                    from "
'    sQ = sQ & "                                                        ags_cnInv i "
'    sQ = sQ & "                                                ) as g on f.cn_key = g.ciCn and f.cidutCnInv = g.ciNum "
'    sQ = sQ & "                                        where g.ciKey Is Not Null "
'    sQ = sQ & "                                    ) as z "
'    sQ = sQ & "                                    Left Join "
'    sQ = sQ & "                                        ( "
'    sQ = sQ & "                                            select "
'    sQ = sQ & "                                                i.cidutCntrPrtNum, "
'    sQ = sQ & "                                                iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
'    sQ = sQ & "                                                i.cidutCnDate, ii.account_num, "
'    sQ = sQ & "                                                iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
'    sQ = sQ & "                                                i.cidutAccount "
'    sQ = sQ & "                                            from "
'    sQ = sQ & "                                                CnInvDbtUplTbl As i "
'    sQ = sQ & "                                                inner Join "
'    sQ = sQ & "                                                    ags_accnt as ii on i.cidutAccount = ii.account_key "
'    sQ = sQ & "                                        ) as y on z.cidutCntrPrtNum = y.cidutCntrPrtNum and z.cidutCnName = y.cidutCnName "
'    sQ = sQ & "                                            and (z.cidutCnDate = y.cidutCnDate or (isnull(z.cidutCnDate) and isnull(y.cidutCnDate))) and z.cidutCnInv = y.cidutCnInv "
'    sQ = sQ & "                            ) as x "
'    sQ = sQ & "                            Left Join "
'    sQ = sQ & "                                ags_cnInvAccnt as w on x.ciKey = w.ciaCnInv and x.cidutAccount = w.ciaAccnt "
'    sQ = sQ & "                        where "
'    sQ = sQ & "                            w.ciaKey is not null "
'    sQ = sQ & "                    ) as a "
'    sQ = sQ & "                    Left Join "
'    sQ = sQ & "                        ( "
'    sQ = sQ & "                            select "
'    sQ = sQ & "                                i.cidutCntrPrtNum, "
'    sQ = sQ & "                                iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
'    sQ = sQ & "                                i.cidutCnDate, "
'    sQ = sQ & "                                iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
'    sQ = sQ & "                                i.cidutAccount, i.cidutUnloadKey, "
'    sQ = sQ & "                                i.cidutFormtnDate , i.cidutMatrtyDate, i.cidutDebt, i.cidutDebtOverdue, i.cidutDoc, i.cidutLink, i.cidutSheet, i.cidutSheetNum "
'    sQ = sQ & "                            from "
'    sQ = sQ & "                                CnInvDbtUplTbl As i "
'    sQ = sQ & "                        ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum and a.cidutCnName = b.cidutCnName "
'    sQ = sQ & "                            and (a.cidutCnDate = b.cidutCnDate or (isnull(a.cidutCnDate) and isnull(b.cidutCnDate))) and a.cidutCnInv = b.cidutCnInv and a.cidutCnInv = b.cidutCnInv and a.cidutAccount = b.cidutAccount "
'    sQ = sQ & "            ) as j "
'    sQ = sQ & "            Left Join "
'    sQ = sQ & "                ( "
'    sQ = sQ & "                    select "
'    sQ = sQ & "                        h.ciaKey, count(h.cidutUnloadKey) as cidutUnloadKeyCount "
'    sQ = sQ & "                    from "
'    sQ = sQ & "                        ( "
'    sQ = sQ & "                            select "
'    sQ = sQ & "                                a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCnName, a.cidutCnDate, a.cn_key, a.cidutCnInv, a.ciKey, "
'    sQ = sQ & "                                a.cidutAccount , a.account_num, a.ciaKey, b.cidutUnloadKey "
'    sQ = sQ & "                            from "
'    sQ = sQ & "                                ( "
'    sQ = sQ & "                                    select "
'    sQ = sQ & "                                        x.cidutCntrPrtNum , x.cidutCntrPrtName, x.cidutCnName, x.cidutCnDate, x.cn_key, x.cidutCnInv, x.ciKey, x.cidutAccount, x.account_num, w.ciaKey "
'    sQ = sQ & "                                    from "
'    sQ = sQ & "                                        ( "
'    sQ = sQ & "                                            select "
'    sQ = sQ & "                                                Z.cidutCntrPrtNum , Z.cidutCntrPrtName, Z.cidutCnName, Z.cidutCnDate, Z.cn_key, Z.cidutCnInv, Z.ciKey, y.cidutAccount, y.account_num "
'    sQ = sQ & "                                            from "
'    sQ = sQ & "                                                ( "
'    sQ = sQ & "                                                    select "
'    sQ = sQ & "                                                        f.cidutCntrPrtNum , f.cidutCntrPrtName, f.cidutCnName, f.cidutCnDate, f.cn_key, f.cidutCnInv, g.ciKey "
'    sQ = sQ & "                                                    from "
'    sQ = sQ & "                                                        ( "
'    sQ = sQ & "                                                            select "
'    sQ = sQ & "                                                                h.cidutCntrPrtNum, h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, "
'    sQ = sQ & "                                                                iif(isnull(h.cidutCnInv), ""Null»лиѕусто"", iif(h.cidutCnInv = '', ""Null»лиѕусто"", trim(h.cidutCnInv))) as cidutCnInv "
'    sQ = sQ & "                                                            from "
'    sQ = sQ & "                                                                ( "
'    sQ = sQ & "                                                                    select u.cidutCntrPrtNum, u.cidutCntrPrtName, u.cidutCntrPrtITN, u.cidutCnName, u.cidutCnDate, u.cn_key, t.cidutCnInv, t.cidutAccount "
'    sQ = sQ & "                                                                    from "
'    sQ = sQ & "                                                                        ( "
'    sQ = sQ & "                                                                            SELECT "
'    sQ = sQ & "                                                                                k.cidutCntrPrtNum , k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
'    sQ = sQ & "                                                                            from "
'    sQ = sQ & "                                                                                ( "
'    sQ = sQ & "                                                                                    SELECT "
'    sQ = sQ & "                                                                                        a.cidutAccount, a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCntrPrtITN, a.cidutCnDate, "
'    sQ = sQ & "                                                                                        iif(isnull(a.cidutCnName), ""Null»лиѕусто"", iif(a.cidutCnName = '', ""Null»лиѕусто"", TRIM(a.cidutCnName))) AS cidutCnName, "
'    sQ = sQ & "                                                                                        a.cidutCnInv, a.cidutFormtnDate, a.cidutMatrtyDate, a.cidutDebt, a.cidutDebtOverdue, a.cidutDoc, "
'    sQ = sQ & "                                                                                        a.cidutLink , a.cidutSheet, a.cidutSheetNum, a.cidutUnloadKey "
'    sQ = sQ & "                                                                                    from "
'    sQ = sQ & "                                                                                        CnInvDbtUplTbl As a "
'    sQ = sQ & "                                                                                        Left Join "
'    sQ = sQ & "                                                                                            ( "
'    sQ = sQ & "                                                                                                SELECT "
'    sQ = sQ & "                                                                                                    Z.cidutCntrPrtNum , Z.cidutCntrPrtName, Z.cidutCntrPrtITN, x.org_id_value_l, x.org, x.org_id_key "
'    sQ = sQ & "                                                                                                from "
'    sQ = sQ & "                                                                                                    ( "
'    sQ = sQ & "                                                                                                        SELECT cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
'    sQ = sQ & "                                                                                                        from CnInvDbtUplTbl "
'    sQ = sQ & "                                                                                                        GROUP BY cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
'    sQ = sQ & "                                                                                                    ) AS z "
'    sQ = sQ & "                                                                                                    Left Join "
'    sQ = sQ & "                                                                                                        ( "
'    sQ = sQ & "                                                                                                            SELECT org_id_value_l, org, org_id_type, org_id_key "
'    sQ = sQ & "                                                                                                            from ags_org_id "
'    sQ = sQ & "                                                                                                            where org_id_type = 1 "
'    sQ = sQ & "                                                                                                        ) AS x ON z.cidutCntrPrtNum = x.org_id_value_l "
'    sQ = sQ & "                                                                                                where (((x.org_id_key) Is Null)) "
'    sQ = sQ & "                                                                                            ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum "
'    sQ = sQ & "                                                                                    where b.cidutCntrPrtName Is Null "
'    sQ = sQ & "                                                                                ) as k "
'    sQ = sQ & "                                                                                Left Join "
'    sQ = sQ & "                                                                                    ( "
'    sQ = sQ & "                                                                                        SELECT "
'    sQ = sQ & "                                                                                            c.cn_key, "
'    sQ = sQ & "                                                                                            iif(isnull(c.cn_number), ""Null»лиѕусто"", iif(c.cn_number = '', ""Null»лиѕусто"", TRIM(c.cn_number))) AS cn_number, "
'    sQ = sQ & "                                                                                            s.cn_s_key, s.cn_s_type, o.cn_s_org_key, o.org_id, c.cn_date, o.date_beg, o.date_end, "
'    sQ = sQ & "                                                                                            o.csoCnDate , i.org_id_value_l, g.ogNm "
'    sQ = sQ & "                                                                                        from "
'    sQ = sQ & "                                                                                            ( "
'    sQ = sQ & "                                                                                                ( "
'    sQ = sQ & "                                                                                                    ( "
'    sQ = sQ & "                                                                                                        ags_cn As c "
'    sQ = sQ & "                                                                                                        inner Join "
'    sQ = sQ & "                                                                                                            ags_cn_s AS s ON c.cn_key = s.cn_key "
'    sQ = sQ & "                                                                                                    ) "
'    sQ = sQ & "                                                                                                    inner Join "
'    sQ = sQ & "                                                                                                        ags_cn_s_org AS o ON s.cn_s_key = o.cn_s_key "
'    sQ = sQ & "                                                                                                ) "
'    sQ = sQ & "                                                                                                inner Join "
'    sQ = sQ & "                                                                                                    ags_org_id AS i ON o.org_id = i.org_id_key "
'    sQ = sQ & "                                                                                            ) "
'    sQ = sQ & "                                                                                            INNER JOIN ags_og AS g ON i.org = g.ogKey "
'    sQ = sQ & "                                                                                        where (((s.cn_s_type) = 2)) "
'    sQ = sQ & "                                                                                    ) as l ON (k.cidutCntrPrtNum = l.org_id_value_l) AND (k.cidutCnName = l.cn_number)  AND ((k.cidutCnDate = l.csoCnDate) or (isnull(k.cidutCnDate) and isnull(l.csoCnDate))) "
'    sQ = sQ & "                                                                            where (((l.cn_key) Is Not Null)) "
'    sQ = sQ & "                                                                            GROUP BY k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
'    sQ = sQ & "                                                                        ) as u "
'    sQ = sQ & "                                                                    Left Join "
'    sQ = sQ & "                                                                        CnInvDbtUplTbl As t "
'    sQ = sQ & "                                                                        on u.cidutCntrPrtNum = t.cidutCntrPrtNum and u.cidutCnName = t.cidutCnName and (u.cidutCnDate = t.cidutCnDate or (isnull(u.cidutCnDate) and isnull(t.cidutCnDate))) "
'    sQ = sQ & "                                                                ) as h "
'    sQ = sQ & "                                                            Group by "
'    sQ = sQ & "                                                                h.cidutCntrPrtNum , h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, h.cidutCnInv "
'    sQ = sQ & "                                                        ) as f "
'    sQ = sQ & "                                                        Left Join "
'    sQ = sQ & "                                                            ( "
'    sQ = sQ & "                                                                select "
'    sQ = sQ & "                                                                    i.ciKey, i.ciCn, iif(isnull(i.ciNum), ""Null»лиѕусто"", iif(i.ciNum = '', ""Null»лиѕусто"", trim(i.ciNum))) as ciNum "
'    sQ = sQ & "                                                                from "
'    sQ = sQ & "                                                                    ags_cnInv i "
'    sQ = sQ & "                                                            ) as g on f.cn_key = g.ciCn and f.cidutCnInv = g.ciNum "
'    sQ = sQ & "                                                    where g.ciKey Is Not Null "
'    sQ = sQ & "                                                ) as z "
'    sQ = sQ & "                                                Left Join "
'    sQ = sQ & "                                                    ( "
'    sQ = sQ & "                                                        select "
'    sQ = sQ & "                                                            i.cidutCntrPrtNum, "
'    sQ = sQ & "                                                            iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
'    sQ = sQ & "                                                            i.cidutCnDate, ii.account_num, "
'    sQ = sQ & "                                                            iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
'    sQ = sQ & "                                                            i.cidutAccount "
'    sQ = sQ & "                                                        from "
'    sQ = sQ & "                                                            CnInvDbtUplTbl As i "
'    sQ = sQ & "                                                            inner Join "
'    sQ = sQ & "                                                                ags_accnt as ii on i.cidutAccount = ii.account_key "
'    sQ = sQ & "                                                    ) as y on z.cidutCntrPrtNum = y.cidutCntrPrtNum and z.cidutCnName = y.cidutCnName "
'    sQ = sQ & "                                                        and (z.cidutCnDate = y.cidutCnDate or (isnull(z.cidutCnDate) and isnull(y.cidutCnDate))) and z.cidutCnInv = y.cidutCnInv "
'    sQ = sQ & "                                        ) as x "
'    sQ = sQ & "                                        Left Join "
'    sQ = sQ & "                                            ags_cnInvAccnt as w on x.ciKey = w.ciaCnInv and x.cidutAccount = w.ciaAccnt "
'    sQ = sQ & "                                    where "
'    sQ = sQ & "                                        w.ciaKey is not null "
'    sQ = sQ & "                                ) as a "
'    sQ = sQ & "                                Left Join "
'    sQ = sQ & "                                    ( "
'    sQ = sQ & "                                        select "
'    sQ = sQ & "                                            i.cidutCntrPrtNum, "
'    sQ = sQ & "                                            iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
'    sQ = sQ & "                                            i.cidutCnDate, "
'    sQ = sQ & "                                            iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
'    sQ = sQ & "                                            i.cidutAccount , i.cidutUnloadKey "
'    sQ = sQ & "                                        from "
'    sQ = sQ & "                                            CnInvDbtUplTbl As i "
'    sQ = sQ & "                                    ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum and a.cidutCnName = b.cidutCnName "
'    sQ = sQ & "                                        and (a.cidutCnDate = b.cidutCnDate or (isnull(a.cidutCnDate) and isnull(b.cidutCnDate))) and a.cidutCnInv = b.cidutCnInv and a.cidutCnInv = b.cidutCnInv and a.cidutAccount = b.cidutAccount "
'    sQ = sQ & "                        ) as h "
'    sQ = sQ & "                    Group by "
'    sQ = sQ & "                        h.ciaKey "
'    sQ = sQ & "                ) as k on j.ciaKey = k.ciaKey "
'    sQ = sQ & "        where k.cidutUnloadKeyCount = 1 "
'    sQ = sQ & "    ) as n "
'    sQ = sQ & "    Left Join "
'    sQ = sQ & "        ags_cn_inv_dbt as m on n.cidutUnloadKey = m.cn_inv_dbt_upl and n.ciaKey = m.cidCnInvAccnt "
'    sQ = sQ & "where "
'    sQ = sQ & "    m.cn_inv_dbt_key is null"

    SqlCnCtptInvAccExistDbtNot = sQ

End Function
' клеем длинный SQL дл€ процедуры *ќтображаем пары —‘+—√  не имеющие задолженности в Ѕƒ*, окончание *************************************************
'****************************************************************************************************************************************************


'****************************************************************************************************************************************************
' клеем длинный SQL дл€ процедуры *ќтображаем пары —‘+—√  имеющие более одной задолженности в выгрузке* *********************************************
Public Function SqlCnCtptInvAccExistDbl() As String

    Dim sQ As String
    
    sQ = ""
    
    sQ = sQ & " Select "
    sQ = sQ & " r.cidutCntrPrtNum, r.cidutCntrPrtName, r.cidutCnName, r.cidutCnDate, r.cn_key, r.cidutCnInv, r.ciKey, "
    sQ = sQ & "     r.account_key , r.account_num, r.ciaKey, r.cidutUnloadKey, r.cidutUnloadKeyCount "
    sQ = sQ & " From "
    sQ = sQ & "     ciduCnCtptInvAccSmplExtAccExtCnt As r "
    sQ = sQ & " where "
    sQ = sQ & "     r.cidutUnloadKeyCount <> 1"

    
'    sQ = sQ & "select "
'    sQ = sQ & "    j.cidutCntrPrtNum, j.cidutCntrPrtName, j.cidutCnName, j.cidutCnDate, j.cn_key, j.cidutCnInv, j.ciKey, "
'    sQ = sQ & "    j.cidutAccount , j.account_num, j.ciaKey, j.cidutUnloadKey, k.cidutUnloadKeyCount "
'    sQ = sQ & "from "
'    sQ = sQ & "    ( "
'    sQ = sQ & "        select "
'    sQ = sQ & "            a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCnName, a.cidutCnDate, a.cn_key, a.cidutCnInv, a.ciKey, "
'    sQ = sQ & "            a.cidutAccount , a.account_num, a.ciaKey, b.cidutUnloadKey "
'    sQ = sQ & "        from "
'    sQ = sQ & "            ( "
'    sQ = sQ & "                select "
'    sQ = sQ & "                    x.cidutCntrPrtNum, x.cidutCntrPrtName, x.cidutCnName, x.cidutCnDate, x.cn_key, x.cidutCnInv, x.ciKey, "
'    sQ = sQ & "                    x.cidutAccount , x.account_num, w.ciaKey "
'    sQ = sQ & "                from "
'    sQ = sQ & "                    ( "
'    sQ = sQ & "                        select "
'    sQ = sQ & "                            Z.cidutCntrPrtNum , Z.cidutCntrPrtName, Z.cidutCnName, Z.cidutCnDate, Z.cn_key, Z.cidutCnInv, Z.ciKey, y.cidutAccount, y.account_num "
'    sQ = sQ & "                        from "
'    sQ = sQ & "                            ( "
'    sQ = sQ & "                                select "
'    sQ = sQ & "                                    f.cidutCntrPrtNum , f.cidutCntrPrtName, f.cidutCnName, f.cidutCnDate, f.cn_key, f.cidutCnInv, g.ciKey "
'    sQ = sQ & "                                from "
'    sQ = sQ & "                                    ( "
'    sQ = sQ & "                                        select "
'    sQ = sQ & "                                            h.cidutCntrPrtNum, h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, "
'    sQ = sQ & "                                            iif(isnull(h.cidutCnInv), ""Null»лиѕусто"", iif(h.cidutCnInv = '', ""Null»лиѕусто"", trim(h.cidutCnInv))) as cidutCnInv "
'    sQ = sQ & "                                        from "
'    sQ = sQ & "                                            ( "
'    sQ = sQ & "                                                select u.cidutCntrPrtNum, u.cidutCntrPrtName, u.cidutCntrPrtITN, u.cidutCnName, u.cidutCnDate, u.cn_key, t.cidutCnInv, t.cidutAccount "
'    sQ = sQ & "                                                from "
'    sQ = sQ & "                                                    ( "
'    sQ = sQ & "                                                        SELECT "
'    sQ = sQ & "                                                            k.cidutCntrPrtNum , k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
'    sQ = sQ & "                                                        from "
'    sQ = sQ & "                                                            ( "
'    sQ = sQ & "                                                                SELECT "
'    sQ = sQ & "                                                                    a.cidutAccount, a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCntrPrtITN, a.cidutCnDate, "
'    sQ = sQ & "                                                                    iif(isnull(a.cidutCnName), ""Null»лиѕусто"", iif(a.cidutCnName = '', ""Null»лиѕусто"", TRIM(a.cidutCnName))) AS cidutCnName, "
'    sQ = sQ & "                                                                    a.cidutCnInv, a.cidutFormtnDate, a.cidutMatrtyDate, a.cidutDebt, a.cidutDebtOverdue, a.cidutDoc, "
'    sQ = sQ & "                                                                    a.cidutLink , a.cidutSheet, a.cidutSheetNum, a.cidutUnloadKey "
'    sQ = sQ & "                                                                from "
'    sQ = sQ & "                                                                    CnInvDbtUplTbl As a "
'    sQ = sQ & "                                                                    Left Join "
'    sQ = sQ & "                                                                        ( "
'    sQ = sQ & "                                                                            SELECT "
'    sQ = sQ & "                                                                                Z.cidutCntrPrtNum , Z.cidutCntrPrtName, Z.cidutCntrPrtITN, x.org_id_value_l, x.org, x.org_id_key "
'    sQ = sQ & "                                                                            from "
'    sQ = sQ & "                                                                                ( "
'    sQ = sQ & "                                                                                    SELECT cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
'    sQ = sQ & "                                                                                    from CnInvDbtUplTbl "
'    sQ = sQ & "                                                                                    GROUP BY cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
'    sQ = sQ & "                                                                                ) AS z "
'    sQ = sQ & "                                                                                Left Join "
'    sQ = sQ & "                                                                                    ( "
'    sQ = sQ & "                                                                                        SELECT org_id_value_l, org, org_id_type, org_id_key "
'    sQ = sQ & "                                                                                        from ags_org_id "
'    sQ = sQ & "                                                                                        where org_id_type = 1 "
'    sQ = sQ & "                                                                                    ) AS x ON z.cidutCntrPrtNum = x.org_id_value_l "
'    sQ = sQ & "                                                                            where (((x.org_id_key) Is Null)) "
'    sQ = sQ & "                                                                        ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum "
'    sQ = sQ & "                                                                where b.cidutCntrPrtName Is Null "
'    sQ = sQ & "                                                            ) as k "
'    sQ = sQ & "                                                            Left Join "
'    sQ = sQ & "                                                                ( "
'    sQ = sQ & "                                                                    SELECT "
'    sQ = sQ & "                                                                        c.cn_key, "
'    sQ = sQ & "                                                                        iif(isnull(c.cn_number), ""Null»лиѕусто"", iif(c.cn_number = '', ""Null»лиѕусто"", TRIM(c.cn_number))) AS cn_number, "
'    sQ = sQ & "                                                                        s.cn_s_key, s.cn_s_type, o.cn_s_org_key, o.org_id, c.cn_date, o.date_beg, o.date_end, "
'    sQ = sQ & "                                                                        o.csoCnDate , i.org_id_value_l, g.ogNm "
'    sQ = sQ & "                                                                    from "
'    sQ = sQ & "                                                                        ( "
'    sQ = sQ & "                                                                            ( "
'    sQ = sQ & "                                                                                ( "
'    sQ = sQ & "                                                                                    ags_cn As c "
'    sQ = sQ & "                                                                                    inner Join "
'    sQ = sQ & "                                                                                        ags_cn_s AS s ON c.cn_key = s.cn_key "
'    sQ = sQ & "                                                                                ) "
'    sQ = sQ & "                                                                                inner Join "
'    sQ = sQ & "                                                                                    ags_cn_s_org AS o ON s.cn_s_key = o.cn_s_key "
'    sQ = sQ & "                                                                            ) "
'    sQ = sQ & "                                                                            inner Join "
'    sQ = sQ & "                                                                                ags_org_id AS i ON o.org_id = i.org_id_key "
'    sQ = sQ & "                                                                        ) "
'    sQ = sQ & "                                                                        INNER JOIN ags_og AS g ON i.org = g.ogKey "
'    sQ = sQ & "                                                                    where (((s.cn_s_type) = 2)) "
'    sQ = sQ & "                                                                ) as l ON (k.cidutCntrPrtNum = l.org_id_value_l) AND (k.cidutCnName = l.cn_number)  AND ((k.cidutCnDate = l.csoCnDate) or (isnull(k.cidutCnDate) and isnull(l.csoCnDate))) "
'    sQ = sQ & "                                                        where (((l.cn_key) Is Not Null)) "
'    sQ = sQ & "                                                        GROUP BY k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
'    sQ = sQ & "                                                    ) as u "
'    sQ = sQ & "                                                Left Join "
'    sQ = sQ & "                                                    CnInvDbtUplTbl As t "
'    sQ = sQ & "                                                    on u.cidutCntrPrtNum = t.cidutCntrPrtNum and u.cidutCnName = t.cidutCnName and (u.cidutCnDate = t.cidutCnDate or (isnull(u.cidutCnDate) and isnull(t.cidutCnDate))) "
'    sQ = sQ & "                                            ) as h "
'    sQ = sQ & "                                        Group by "
'    sQ = sQ & "                                            h.cidutCntrPrtNum , h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, h.cidutCnInv "
'    sQ = sQ & "                                    ) as f "
'    sQ = sQ & "                                    Left Join "
'    sQ = sQ & "                                        ( "
'    sQ = sQ & "                                            select "
'    sQ = sQ & "                                                i.ciKey, i.ciCn, iif(isnull(i.ciNum), ""Null»лиѕусто"", iif(i.ciNum = '', ""Null»лиѕусто"", trim(i.ciNum))) as ciNum "
'    sQ = sQ & "                                            from "
'    sQ = sQ & "                                                ags_cnInv i "
'    sQ = sQ & "                                        ) as g on f.cn_key = g.ciCn and f.cidutCnInv = g.ciNum "
'    sQ = sQ & "                                where g.ciKey Is Not Null "
'    sQ = sQ & "                            ) as z "
'    sQ = sQ & "                            Left Join "
'    sQ = sQ & "                                ( "
'    sQ = sQ & "                                    select "
'    sQ = sQ & "                                        i.cidutCntrPrtNum, "
'    sQ = sQ & "                                        iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
'    sQ = sQ & "                                        i.cidutCnDate, ii.account_num, "
'    sQ = sQ & "                                        iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
'    sQ = sQ & "                                        i.cidutAccount "
'    sQ = sQ & "                                    from "
'    sQ = sQ & "                                        CnInvDbtUplTbl As i "
'    sQ = sQ & "                                        inner Join "
'    sQ = sQ & "                                            ags_accnt as ii on i.cidutAccount = ii.account_key "
'    sQ = sQ & "                                ) as y on z.cidutCntrPrtNum = y.cidutCntrPrtNum and z.cidutCnName = y.cidutCnName "
'    sQ = sQ & "                                    and (z.cidutCnDate = y.cidutCnDate or (isnull(z.cidutCnDate) and isnull(y.cidutCnDate))) and z.cidutCnInv = y.cidutCnInv "
'    sQ = sQ & "                    ) as x "
'    sQ = sQ & "                    Left Join "
'    sQ = sQ & "                        ags_cnInvAccnt as w on x.ciKey = w.ciaCnInv and x.cidutAccount = w.ciaAccnt "
'    sQ = sQ & "                where "
'    sQ = sQ & "                    w.ciaKey is not null "
'    sQ = sQ & "            ) as a "
'    sQ = sQ & "            Left Join "
'    sQ = sQ & "                ( "
'    sQ = sQ & "                    select "
'    sQ = sQ & "                        i.cidutCntrPrtNum, "
'    sQ = sQ & "                        iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
'    sQ = sQ & "                        i.cidutCnDate, "
'    sQ = sQ & "                        iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
'    sQ = sQ & "                        i.cidutAccount , i.cidutUnloadKey "
'    sQ = sQ & "                    from "
'    sQ = sQ & "                        CnInvDbtUplTbl As i "
'    sQ = sQ & "                ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum and a.cidutCnName = b.cidutCnName "
'    sQ = sQ & "                    and (a.cidutCnDate = b.cidutCnDate or (isnull(a.cidutCnDate) and isnull(b.cidutCnDate))) and a.cidutCnInv = b.cidutCnInv and a.cidutCnInv = b.cidutCnInv and a.cidutAccount = b.cidutAccount "
'    sQ = sQ & "    ) as j "
'    sQ = sQ & "    Left Join "
'    sQ = sQ & "        ( "
'    sQ = sQ & "            select "
'    sQ = sQ & "                h.ciaKey, count(h.cidutUnloadKey) as cidutUnloadKeyCount "
'    sQ = sQ & "            from "
'    sQ = sQ & "                ( "
'    sQ = sQ & "                    select "
'    sQ = sQ & "                        a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCnName, a.cidutCnDate, a.cn_key, a.cidutCnInv, a.ciKey, "
'    sQ = sQ & "                        a.cidutAccount , a.account_num, a.ciaKey, b.cidutUnloadKey "
'    sQ = sQ & "                    from "
'    sQ = sQ & "                        ( "
'    sQ = sQ & "                            select "
'    sQ = sQ & "                                x.cidutCntrPrtNum , x.cidutCntrPrtName, x.cidutCnName, x.cidutCnDate, x.cn_key, x.cidutCnInv, x.ciKey, x.cidutAccount, x.account_num, w.ciaKey "
'    sQ = sQ & "                            from "
'    sQ = sQ & "                                ( "
'    sQ = sQ & "                                    select "
'    sQ = sQ & "                                        Z.cidutCntrPrtNum , Z.cidutCntrPrtName, Z.cidutCnName, Z.cidutCnDate, Z.cn_key, Z.cidutCnInv, Z.ciKey, y.cidutAccount, y.account_num "
'    sQ = sQ & "                                    from "
'    sQ = sQ & "                                        ( "
'    sQ = sQ & "                                            select "
'    sQ = sQ & "                                                f.cidutCntrPrtNum , f.cidutCntrPrtName, f.cidutCnName, f.cidutCnDate, f.cn_key, f.cidutCnInv, g.ciKey "
'    sQ = sQ & "                                            from "
'    sQ = sQ & "                                                ( "
'    sQ = sQ & "                                                    select "
'    sQ = sQ & "                                                        h.cidutCntrPrtNum, h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, "
'    sQ = sQ & "                                                        iif(isnull(h.cidutCnInv), ""Null»лиѕусто"", iif(h.cidutCnInv = '', ""Null»лиѕусто"", trim(h.cidutCnInv))) as cidutCnInv "
'    sQ = sQ & "                                                    from "
'    sQ = sQ & "                                                        ( "
'    sQ = sQ & "                                                            select u.cidutCntrPrtNum, u.cidutCntrPrtName, u.cidutCntrPrtITN, u.cidutCnName, u.cidutCnDate, u.cn_key, t.cidutCnInv, t.cidutAccount "
'    sQ = sQ & "                                                            from "
'    sQ = sQ & "                                                                ( "
'    sQ = sQ & "                                                                    SELECT "
'    sQ = sQ & "                                                                        k.cidutCntrPrtNum , k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
'    sQ = sQ & "                                                                    from "
'    sQ = sQ & "                                                                        ( "
'    sQ = sQ & "                                                                            SELECT "
'    sQ = sQ & "                                                                                a.cidutAccount, a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCntrPrtITN, a.cidutCnDate, "
'    sQ = sQ & "                                                                                iif(isnull(a.cidutCnName), ""Null»лиѕусто"", iif(a.cidutCnName = '', ""Null»лиѕусто"", TRIM(a.cidutCnName))) AS cidutCnName, "
'    sQ = sQ & "                                                                                a.cidutCnInv, a.cidutFormtnDate, a.cidutMatrtyDate, a.cidutDebt, a.cidutDebtOverdue, a.cidutDoc, "
'    sQ = sQ & "                                                                                a.cidutLink , a.cidutSheet, a.cidutSheetNum, a.cidutUnloadKey "
'    sQ = sQ & "                                                                            from "
'    sQ = sQ & "                                                                                CnInvDbtUplTbl As a "
'    sQ = sQ & "                                                                                Left Join "
'    sQ = sQ & "                                                                                    ( "
'    sQ = sQ & "                                                                                        SELECT "
'    sQ = sQ & "                                                                                            Z.cidutCntrPrtNum , Z.cidutCntrPrtName, Z.cidutCntrPrtITN, x.org_id_value_l, x.org, x.org_id_key "
'    sQ = sQ & "                                                                                        from "
'    sQ = sQ & "                                                                                            ( "
'    sQ = sQ & "                                                                                                SELECT cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
'    sQ = sQ & "                                                                                                from CnInvDbtUplTbl "
'    sQ = sQ & "                                                                                                GROUP BY cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
'    sQ = sQ & "                                                                                            ) AS z "
'    sQ = sQ & "                                                                                            Left Join "
'    sQ = sQ & "                                                                                                ( "
'    sQ = sQ & "                                                                                                    SELECT org_id_value_l, org, org_id_type, org_id_key "
'    sQ = sQ & "                                                                                                    from ags_org_id "
'    sQ = sQ & "                                                                                                    where org_id_type = 1 "
'    sQ = sQ & "                                                                                                ) AS x ON z.cidutCntrPrtNum = x.org_id_value_l "
'    sQ = sQ & "                                                                                        where (((x.org_id_key) Is Null)) "
'    sQ = sQ & "                                                                                    ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum "
'    sQ = sQ & "                                                                            where b.cidutCntrPrtName Is Null "
'    sQ = sQ & "                                                                        ) as k "
'    sQ = sQ & "                                                                        Left Join "
'    sQ = sQ & "                                                                            ( "
'    sQ = sQ & "                                                                                SELECT "
'    sQ = sQ & "                                                                                    c.cn_key, "
'    sQ = sQ & "                                                                                    iif(isnull(c.cn_number), ""Null»лиѕусто"", iif(c.cn_number = '', ""Null»лиѕусто"", TRIM(c.cn_number))) AS cn_number, "
'    sQ = sQ & "                                                                                    s.cn_s_key, s.cn_s_type, o.cn_s_org_key, o.org_id, c.cn_date, o.date_beg, o.date_end, "
'    sQ = sQ & "                                                                                    o.csoCnDate , i.org_id_value_l, g.ogNm "
'    sQ = sQ & "                                                                                from "
'    sQ = sQ & "                                                                                    ( "
'    sQ = sQ & "                                                                                        ( "
'    sQ = sQ & "                                                                                            ( "
'    sQ = sQ & "                                                                                                ags_cn As c "
'    sQ = sQ & "                                                                                                inner Join "
'    sQ = sQ & "                                                                                                    ags_cn_s AS s ON c.cn_key = s.cn_key "
'    sQ = sQ & "                                                                                            ) "
'    sQ = sQ & "                                                                                            inner Join "
'    sQ = sQ & "                                                                                                ags_cn_s_org AS o ON s.cn_s_key = o.cn_s_key "
'    sQ = sQ & "                                                                                        ) "
'    sQ = sQ & "                                                                                        inner Join "
'    sQ = sQ & "                                                                                            ags_org_id AS i ON o.org_id = i.org_id_key "
'    sQ = sQ & "                                                                                    ) "
'    sQ = sQ & "                                                                                    INNER JOIN ags_og AS g ON i.org = g.ogKey "
'    sQ = sQ & "                                                                                where (((s.cn_s_type) = 2)) "
'    sQ = sQ & "                                                                            ) as l ON (k.cidutCntrPrtNum = l.org_id_value_l) AND (k.cidutCnName = l.cn_number)  AND ((k.cidutCnDate = l.csoCnDate) or (isnull(k.cidutCnDate) and isnull(l.csoCnDate))) "
'    sQ = sQ & "                                                                    where (((l.cn_key) Is Not Null)) "
'    sQ = sQ & "                                                                    GROUP BY k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
'    sQ = sQ & "                                                                ) as u "
'    sQ = sQ & "                                                            Left Join "
'    sQ = sQ & "                                                                CnInvDbtUplTbl As t "
'    sQ = sQ & "                                                                on u.cidutCntrPrtNum = t.cidutCntrPrtNum and u.cidutCnName = t.cidutCnName and (u.cidutCnDate = t.cidutCnDate or (isnull(u.cidutCnDate) and isnull(t.cidutCnDate))) "
'    sQ = sQ & "                                                        ) as h "
'    sQ = sQ & "                                                    Group by "
'    sQ = sQ & "                                                        h.cidutCntrPrtNum , h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, h.cidutCnInv "
'    sQ = sQ & "                                                ) as f "
'    sQ = sQ & "                                                Left Join "
'    sQ = sQ & "                                                    ( "
'    sQ = sQ & "                                                        select "
'    sQ = sQ & "                                                            i.ciKey, i.ciCn, iif(isnull(i.ciNum), ""Null»лиѕусто"", iif(i.ciNum = '', ""Null»лиѕусто"", trim(i.ciNum))) as ciNum "
'    sQ = sQ & "                                                        from "
'    sQ = sQ & "                                                            ags_cnInv i "
'    sQ = sQ & "                                                    ) as g on f.cn_key = g.ciCn and f.cidutCnInv = g.ciNum "
'    sQ = sQ & "                                            where g.ciKey Is Not Null "
'    sQ = sQ & "                                        ) as z "
'    sQ = sQ & "                                        Left Join "
'    sQ = sQ & "                                            ( "
'    sQ = sQ & "                                                select "
'    sQ = sQ & "                                                    i.cidutCntrPrtNum, "
'    sQ = sQ & "                                                    iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
'    sQ = sQ & "                                                    i.cidutCnDate, ii.account_num, "
'    sQ = sQ & "                                                    iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
'    sQ = sQ & "                                                    i.cidutAccount "
'    sQ = sQ & "                                                from "
'    sQ = sQ & "                                                    CnInvDbtUplTbl As i "
'    sQ = sQ & "                                                    inner Join "
'    sQ = sQ & "                                                        ags_accnt as ii on i.cidutAccount = ii.account_key "
'    sQ = sQ & "                                            ) as y on z.cidutCntrPrtNum = y.cidutCntrPrtNum and z.cidutCnName = y.cidutCnName "
'    sQ = sQ & "                                                and (z.cidutCnDate = y.cidutCnDate or (isnull(z.cidutCnDate) and isnull(y.cidutCnDate))) and z.cidutCnInv = y.cidutCnInv "
'    sQ = sQ & "                                ) as x "
'    sQ = sQ & "                                Left Join "
'    sQ = sQ & "                                    ags_cnInvAccnt as w on x.ciKey = w.ciaCnInv and x.cidutAccount = w.ciaAccnt "
'    sQ = sQ & "                            where "
'    sQ = sQ & "                                w.ciaKey is not null "
'    sQ = sQ & "                        ) as a "
'    sQ = sQ & "                        Left Join "
'    sQ = sQ & "                            ( "
'    sQ = sQ & "                                select "
'    sQ = sQ & "                                    i.cidutCntrPrtNum, "
'    sQ = sQ & "                                    iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
'    sQ = sQ & "                                    i.cidutCnDate, "
'    sQ = sQ & "                                    iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
'    sQ = sQ & "                                    i.cidutAccount , i.cidutUnloadKey "
'    sQ = sQ & "                                from "
'    sQ = sQ & "                                    CnInvDbtUplTbl As i "
'    sQ = sQ & "                            ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum and a.cidutCnName = b.cidutCnName "
'    sQ = sQ & "                                and (a.cidutCnDate = b.cidutCnDate or (isnull(a.cidutCnDate) and isnull(b.cidutCnDate))) and a.cidutCnInv = b.cidutCnInv and a.cidutCnInv = b.cidutCnInv and a.cidutAccount = b.cidutAccount "
'    sQ = sQ & "                ) as h "
'    sQ = sQ & "            Group by "
'    sQ = sQ & "                h.ciaKey "
'    sQ = sQ & "        ) as k on j.ciaKey = k.ciaKey "
'    sQ = sQ & "where k.cidutUnloadKeyCount <> 1"

    SqlCnCtptInvAccExistDbl = sQ

End Function
' клеем длинный SQL дл€ процедуры *ќтображаем пары —‘+—√  имеющие более одной задолженности в выгрузке*, окончание **********************************
'****************************************************************************************************************************************************


'****************************************************************************************************************************************************
' ‘ормируем метку из даты по форме мес€ц-день-часы-минуты *******************************************************************************************
Public Function strMark(ByVal dateMark As Date) As String

    Dim sM As String
        
    sM = CStr(DatePart("m", dateMark))
    sM = sM & IIf(Len(DatePart("d", dateMark)) = 1, "0" & CStr(DatePart("d", dateMark)), CStr(DatePart("d", dateMark)))
    sM = sM & IIf(Len(DatePart("h", dateMark)) = 1, "0" & CStr(DatePart("h", dateMark)), CStr(DatePart("h", dateMark)))
    sM = sM & IIf(Len(DatePart("n", dateMark)) = 1, "0" & CStr(DatePart("n", dateMark)), CStr(DatePart("n", dateMark)))
    
    strMark = sM

End Function
' ‘ормируем метку из даты по форме мес€ц-день-часы-минуты, окончание ********************************************************************************
'****************************************************************************************************************************************************

'****************************************************************************************************************************************************
' клеем длинный SQL дл€ процедуры *ќтображаем отсутствующие договоры (по выгрузке платежей)* 29.11.2021 11:38 ***************************************
Public Function SqlCipuCn_CtptCnNot() As String

    Dim sQ As String
        
    sQ = ""
    
'    sQ = sQ & "SELECT a.CntrPrtNum, a.CntrPrtName, a.CnName, a.org_id_key, count(b.cn_key) as countCn "
'    sQ = sQ & "FROM cipuCn_CtptCnNot as a "
'    sQ = sQ & "Left Join "
'    sQ = sQ & " ( "
'    sQ = sQ & "     select "
'    sQ = sQ & "         iif(isnull(c.cn_number), ""Null»лиѕусто"", iif(c.cn_number = '', ""Null»лиѕусто"", c.cn_number)) as cn_number, c.cn_key "
'    sQ = sQ & "     from "
'    sQ = sQ & "         ags_cn As c "
'    sQ = sQ & " ) as b ON a.CnName = b.cn_number "
'    sQ = sQ & "Group BY "
'    sQ = sQ & " a.CntrPrtNum , a.CntrPrtName, a.CnName, a.org_id_key "
'    sQ = sQ & "ORDER BY a.CntrPrtNum, a.CnName;"
    
    
    
    sQ = sQ & "SELECT a.CntrPrtNum, a.CntrPrtName, a.CnName, a.org_id_key, Count(b.cn_key) AS countCn "
    sQ = sQ & "FROM cipuCn_CtptCnNot AS a "
    sQ = sQ & "Left Join "
    sQ = sQ & "( "
    sQ = sQ & "     SELECT n.cnnNumNull as cn_number, c.cn_key "
    sQ = sQ & "     FROM ags_cn AS c INNER JOIN ags_cnNum AS n ON c.cn_key = n.cnnCn "
    sQ = sQ & ")  AS b ON a.CnName = b.cn_number "
    sQ = sQ & "GROUP BY a.CntrPrtNum, a.CntrPrtName, a.CnName, a.org_id_key "
    sQ = sQ & "ORDER BY a.CntrPrtNum, a.CnName;"

    
    
    SqlCipuCn_CtptCnNot = sQ
    
End Function
' клеем длинный SQL дл€ процедуры *ќтображаем отсутствующие договоры (по выгрузке платежей)*, окончание *********************************************
'****************************************************************************************************************************************************

'****************************************************************************************************************************************************
' клеем длинный SQL дл€ процедуры *ќтображаем пары —‘+—√  не имеющие задолженности в Ѕƒ либо добавл€ем их туда* *************************************
Public Function SqlCnCtptInvAccExistDbtNotLoad() As String

    Dim sQ As String
        
    sQ = ""
    
    sQ = sQ & "insert into ags_cn_inv_dbt "
    sQ = sQ & " (cn_inv_date_start, cn_inv_date_maturity, debt_type, dbt_ttl, dbt_overd, doc_base, link, cn_inv_dbt_upl, [number], mark, cidCounterParty, cidCnInvAccnt) "
    sQ = sQ & "select "
    sQ = sQ & " n.cidutFormtnDate, n.cidutMatrtyDate, ""D"" as debt_type, n.cidutDebt, n.cidutDebtOverdue, n.cidutDoc, n.cidutLink,  n.cidutUnloadKey, n.cidutSheetNum,  "
    sQ = sQ & strMark(Now()) & " as mark, n.cn_s_org_key, n.ciaKey "
    sQ = sQ & "from "
    sQ = sQ & " ( "
    sQ = sQ & "     select "
    sQ = sQ & "         * "
    sQ = sQ & "     from "
    sQ = sQ & "         ciduCnCtptInvAccExistCount "
    sQ = sQ & "     where cidutUnloadKeyCount = 1 "
    sQ = sQ & " ) as n "
    sQ = sQ & " left join "
    sQ = sQ & "     ags_cn_inv_dbt as m on n.cidutUnloadKey = m.cn_inv_dbt_upl and n.ciaKey = m.cidCnInvAccnt "
    sQ = sQ & "where "
    sQ = sQ & " m.cn_inv_dbt_key is null"
    
    
    
'    sQ = sQ & "insert into ags_cn_inv_dbt "
'    sQ = sQ & " (cn_inv_date_start, cn_inv_date_maturity, debt_type, dbt_ttl, dbt_overd, doc_base, link, cn_inv_dbt_upl, [number], mark, cidCounterParty, cidCnInvAccnt) "
'    sQ = sQ & "select "
'    sQ = sQ & " n.cidutFormtnDate, n.cidutMatrtyDate, ""D"" as debt_type, n.cidutDebt, n.cidutDebtOverdue, n.cidutDoc, n.cidutLink,  n.cidutUnloadKey, n.cidutSheetNum,  "
'    sQ = sQ & strMark(Now()) & " as mark, n.cn_s_org_key, n.ciaKey "
'    sQ = sQ & "from "
'    sQ = sQ & " ( "
'    sQ = sQ & "     select "
'    sQ = sQ & "         j.cidutCntrPrtNum, j.cidutCntrPrtName, j.cidutCnName, j.cidutCnDate, j.cn_key, j.cn_s_org_key, j.cidutCnInv, j.ciKey,  "
'    sQ = sQ & "         j.cidutAccount, j.account_num, j.ciaKey, j.cidutUnloadKey, k.cidutUnloadKeyCount, "
'    sQ = sQ & "         j.cidutFormtnDate, j.cidutMatrtyDate, j.cidutDebt, j.cidutDebtOverdue, j.cidutDoc, j.cidutLink, j.cidutSheet, j.cidutSheetNum "
'    sQ = sQ & "     from "
'    sQ = sQ & "         ( "
'    sQ = sQ & "             select "
'    sQ = sQ & "                 a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCnName, a.cidutCnDate, a.cn_key, a.cn_s_org_key, a.cidutCnInv, a.ciKey,  "
'    sQ = sQ & "                 a.cidutAccount, a.account_num, a.ciaKey, b.cidutUnloadKey,  "
'    sQ = sQ & "                 b.cidutFormtnDate, b.cidutMatrtyDate, b.cidutDebt, b.cidutDebtOverdue, b.cidutDoc, b.cidutLink, b.cidutSheet, b.cidutSheetNum "
'    sQ = sQ & "             from "
'    sQ = sQ & "                 ( "
'    sQ = sQ & "                     select "
'    sQ = sQ & "                         x.cidutCntrPrtNum, x.cidutCntrPrtName, x.cidutCnName, x.cidutCnDate, x.cn_key, x.cn_s_org_key,  "
'    sQ = sQ & "                         x.cidutCnInv, x.ciKey, x.cidutAccount, x.account_num, w.ciaKey "
'    sQ = sQ & "                     from "
'    sQ = sQ & "                         ( "
'    sQ = sQ & "                             select "
'    sQ = sQ & "                                 z.cidutCntrPrtNum, z.cidutCntrPrtName, z.cidutCnName, z.cidutCnDate, z.cn_key, z.cn_s_org_key,  "
'    sQ = sQ & "                                 z.cidutCnInv, z.ciKey, y.cidutAccount, y.account_num "
'    sQ = sQ & "                             from "
'    sQ = sQ & "                                 ( "
'    sQ = sQ & "                                     select  "
'    sQ = sQ & "                                         f.cidutCntrPrtNum, f.cidutCntrPrtName, f.cidutCnName, f.cidutCnDate, f.cn_key, f.cn_s_org_key,  "
'    sQ = sQ & "                                         f.cidutCnInv, g.ciKey "
'    sQ = sQ & "                                     from "
'    sQ = sQ & "                                         ( "
'    sQ = sQ & "                                             select  "
'    sQ = sQ & "                                                 h.cidutCntrPrtNum, h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, h.cn_s_org_key,  "
'    sQ = sQ & "                                                 iif(isnull(h.cidutCnInv), ""Null»лиѕусто"", iif(h.cidutCnInv = '', ""Null»лиѕусто"", trim(h.cidutCnInv))) as cidutCnInv "
'    sQ = sQ & "                                             from "
'    sQ = sQ & "                                                 ( "
'    sQ = sQ & "                                                     select  "
'    sQ = sQ & "                                                         u.cidutCntrPrtNum, u.cidutCntrPrtName, u.cidutCntrPrtITN, u.cidutCnName, u.cidutCnDate,  "
'    sQ = sQ & "                                                         u.cn_key, u.cn_s_org_key, t.cidutCnInv, t.cidutAccount "
'    sQ = sQ & "                                                     from "
'    sQ = sQ & "                                                         ( "
'    sQ = sQ & "                                                             SELECT  "
'    sQ = sQ & "                                                                 k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate,  "
'    sQ = sQ & "                                                                 l.cn_key, l.cn_s_org_key "
'    sQ = sQ & "                                                             From "
'    sQ = sQ & "                                                                 ( "
'    sQ = sQ & "                                                                     SELECT  "
'    sQ = sQ & "                                                                         a.cidutAccount, a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCntrPrtITN, a.cidutCnDate,  "
'    sQ = sQ & "                                                                         iif(isnull(a.cidutCnName), ""Null»лиѕусто"", iif(a.cidutCnName = '', ""Null»лиѕусто"", TRIM(a.cidutCnName))) AS cidutCnName,  "
'    sQ = sQ & "                                                                         a.cidutCnInv, a.cidutFormtnDate, a.cidutMatrtyDate, a.cidutDebt, a.cidutDebtOverdue, a.cidutDoc,  "
'    sQ = sQ & "                                                                         a.cidutLink, a.cidutSheet, a.cidutSheetNum, a.cidutUnloadKey "
'    sQ = sQ & "                                                                     FROM  "
'    sQ = sQ & "                                                                         CnInvDbtUplTbl as a "
'    sQ = sQ & "                                                                         Left join "
'    sQ = sQ & "                                                                             ( "
'    sQ = sQ & "                                                                                 SELECT  "
'    sQ = sQ & "                                                                                     z.cidutCntrPrtNum, z.cidutCntrPrtName, z.cidutCntrPrtITN, x.org_id_value_l, x.org, x.org_id_key  "
'    sQ = sQ & "                                                                                 FROM  "
'    sQ = sQ & "                                                                                     ( "
'    sQ = sQ & "                                                                                         SELECT cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN  "
'    sQ = sQ & "                                                                                         FROM CnInvDbtUplTbl  "
'    sQ = sQ & "                                                                                         GROUP BY cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
'    sQ = sQ & "                                                                                     ) AS z  "
'    sQ = sQ & "                                                                                     LEFT JOIN  "
'    sQ = sQ & "                                                                                         ( "
'    sQ = sQ & "                                                                                             SELECT org_id_value_l, org, org_id_type, org_id_key  "
'    sQ = sQ & "                                                                                             FROM ags_org_id  "
'    sQ = sQ & "                                                                                             WHERE org_id_type = 1 "
'    sQ = sQ & "                                                                                         ) AS x ON z.cidutCntrPrtNum = x.org_id_value_l  "
'    sQ = sQ & "                                                                                 WHERE (((x.org_id_key) Is Null))  "
'    sQ = sQ & "                                                                             ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum "
'    sQ = sQ & "                                                                     where b.cidutCntrPrtName is null "
'    sQ = sQ & "                                                                 ) as k "
'    sQ = sQ & "                                                                 Left join "
'    sQ = sQ & "                                                                     ( "
'    sQ = sQ & "                                                                         SELECT  "
'    sQ = sQ & "                                                                             c.cn_key,  "
'    sQ = sQ & "                                                                             iif(isnull(c.cn_number), ""Null»лиѕусто"", iif(c.cn_number = '', ""Null»лиѕусто"", TRIM(c.cn_number))) AS cn_number,  "
'    sQ = sQ & "                                                                             s.cn_s_key, s.cn_s_type, o.cn_s_org_key, o.org_id, c.cn_date, o.date_beg, o.date_end,  "
'    sQ = sQ & "                                                                             o.csoCnDate, i.org_id_value_l, g.ogNm "
'    sQ = sQ & "                                                                         FROM  "
'    sQ = sQ & "                                                                             ( "
'    sQ = sQ & "                                                                                 ( "
'    sQ = sQ & "                                                                                     ( "
'    sQ = sQ & "                                                                                         ags_cn AS c  "
'    sQ = sQ & "                                                                                         INNER JOIN  "
'    sQ = sQ & "                                                                                             ags_cn_s AS s ON c.cn_key = s.cn_key "
'    sQ = sQ & "                                                                                     )  "
'    sQ = sQ & "                                                                                     INNER JOIN  "
'    sQ = sQ & "                                                                                         ags_cn_s_org AS o ON s.cn_s_key = o.cn_s_key "
'    sQ = sQ & "                                                                                 )  "
'    sQ = sQ & "                                                                                 INNER JOIN  "
'    sQ = sQ & "                                                                                     ags_org_id AS i ON o.org_id = i.org_id_key "
'    sQ = sQ & "                                                                             )  "
'    sQ = sQ & "                                                                             INNER JOIN ags_og AS g ON i.org = g.ogKey "
'    sQ = sQ & "                                                                         WHERE (((s.cn_s_type)=2)) "
'    sQ = sQ & "                                                                     ) as l ON (k.cidutCntrPrtNum = l.org_id_value_l) AND (k.cidutCnName = l.cn_number)  AND ((k.cidutCnDate = l.csoCnDate) or (isnull(k.cidutCnDate) and isnull(l.csoCnDate))) "
'    sQ = sQ & "                                                             WHERE (((l.cn_key) Is not Null)) "
'    sQ = sQ & "                                                             GROUP BY k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key, l.cn_s_org_key "
'    sQ = sQ & "                                                         ) as u "
'    sQ = sQ & "                                                     left join "
'    sQ = sQ & "                                                         CnInvDbtUplTbl as t "
'    sQ = sQ & "                                                         on u.cidutCntrPrtNum = t.cidutCntrPrtNum and u.cidutCnName = t.cidutCnName and (u.cidutCnDate = t.cidutCnDate or (isnull(u.cidutCnDate) and isnull(t.cidutCnDate))) "
'    sQ = sQ & "                                                 ) as h "
'    sQ = sQ & "                                             group by "
'    sQ = sQ & "                                                 h.cidutCntrPrtNum, h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, h.cn_s_org_key, h.cidutCnInv "
'    sQ = sQ & "                                         ) as f "
'    sQ = sQ & "                                         left join "
'    sQ = sQ & "                                             ( "
'    sQ = sQ & "                                                 select  "
'    sQ = sQ & "                                                     i.ciKey, i.ciCn, iif(isnull(i.ciNum), ""Null»лиѕусто"", iif(i.ciNum = '', ""Null»лиѕусто"", trim(i.ciNum))) as ciNum "
'    sQ = sQ & "                                                 from  "
'    sQ = sQ & "                                                     ags_cnInv i "
'    sQ = sQ & "                                             ) as g on f.cn_key = g.ciCn and f.cidutCnInv = g.ciNum "
'    sQ = sQ & "                                     where g.ciKey is not null "
'    sQ = sQ & "                                 ) as z "
'    sQ = sQ & "                                 left join "
'    sQ = sQ & "                                     ( "
'    sQ = sQ & "                                         select "
'    sQ = sQ & "                                             i.cidutCntrPrtNum,  "
'    sQ = sQ & "                                             iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
'    sQ = sQ & "                                             i.cidutCnDate, ii.account_num, "
'    sQ = sQ & "                                             iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
'    sQ = sQ & "                                             i.cidutAccount "
'    sQ = sQ & "                                         from "
'    sQ = sQ & "                                             CnInvDbtUplTbl as i "
'    sQ = sQ & "                                             inner join "
'    sQ = sQ & "                                                 ags_accnt as ii on i.cidutAccount = ii.account_key "
'    sQ = sQ & "                                     ) as y on z.cidutCntrPrtNum = y.cidutCntrPrtNum and z.cidutCnName = y.cidutCnName  "
'    sQ = sQ & "                                         and (z.cidutCnDate = y.cidutCnDate or (isnull(z.cidutCnDate) and isnull(y.cidutCnDate))) and z.cidutCnInv = y.cidutCnInv "
'    sQ = sQ & "                         ) as x "
'    sQ = sQ & "                         left join "
'    sQ = sQ & "                             ags_cnInvAccnt as w on x.ciKey = w.ciaCnInv and x.cidutAccount = w.ciaAccnt "
'    sQ = sQ & "                     where "
'    sQ = sQ & "                         w.ciaKey is not null "
'    sQ = sQ & "                 ) as a "
'    sQ = sQ & "                 left join "
'    sQ = sQ & "                     ( "
'    sQ = sQ & "                         select  "
'    sQ = sQ & "                             i.cidutCntrPrtNum,  "
'    sQ = sQ & "                             iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
'    sQ = sQ & "                             i.cidutCnDate, "
'    sQ = sQ & "                             iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
'    sQ = sQ & "                             i.cidutAccount, i.cidutUnloadKey, "
'    sQ = sQ & "                             i.cidutFormtnDate, i.cidutMatrtyDate, i.cidutDebt, i.cidutDebtOverdue, i.cidutDoc, i.cidutLink, i.cidutSheet, i.cidutSheetNum "
'    sQ = sQ & "                         from "
'    sQ = sQ & "                             CnInvDbtUplTbl as i "
'    sQ = sQ & "                     ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum and a.cidutCnName = b.cidutCnName  "
'    sQ = sQ & "                         and (a.cidutCnDate = b.cidutCnDate or (isnull(a.cidutCnDate) and isnull(b.cidutCnDate))) and a.cidutCnInv = b.cidutCnInv and a.cidutCnInv = b.cidutCnInv and a.cidutAccount = b.cidutAccount "
'    sQ = sQ & "         ) as j "
'    sQ = sQ & "         left join "
'    sQ = sQ & "             ( "
'    sQ = sQ & "                 select "
'    sQ = sQ & "                     h.ciaKey, count(h.cidutUnloadKey) as cidutUnloadKeyCount "
'    sQ = sQ & "                 from "
'    sQ = sQ & "                     ( "
'    sQ = sQ & "                         select "
'    sQ = sQ & "                             a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCnName, a.cidutCnDate, a.cn_key, a.cidutCnInv, a.ciKey,  "
'    sQ = sQ & "                             a.cidutAccount, a.account_num, a.ciaKey, b.cidutUnloadKey "
'    sQ = sQ & "                         from "
'    sQ = sQ & "                             ( "
'    sQ = sQ & "                                 select "
'    sQ = sQ & "                                     x.cidutCntrPrtNum, x.cidutCntrPrtName, x.cidutCnName, x.cidutCnDate, x.cn_key, x.cidutCnInv, x.ciKey, x.cidutAccount, x.account_num, w.ciaKey "
'    sQ = sQ & "                                 from "
'    sQ = sQ & "                                     ( "
'    sQ = sQ & "                                         select "
'    sQ = sQ & "                                             z.cidutCntrPrtNum, z.cidutCntrPrtName, z.cidutCnName, z.cidutCnDate, z.cn_key, z.cidutCnInv, z.ciKey, y.cidutAccount, y.account_num "
'    sQ = sQ & "                                         from "
'    sQ = sQ & "                                             ( "
'    sQ = sQ & "                                                 select  "
'    sQ = sQ & "                                                     f.cidutCntrPrtNum, f.cidutCntrPrtName, f.cidutCnName, f.cidutCnDate, f.cn_key, f.cidutCnInv, g.ciKey "
'    sQ = sQ & "                                                 from "
'    sQ = sQ & "                                                     ( "
'    sQ = sQ & "                                                         select  "
'    sQ = sQ & "                                                             h.cidutCntrPrtNum, h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key,  "
'    sQ = sQ & "                                                             iif(isnull(h.cidutCnInv), ""Null»лиѕусто"", iif(h.cidutCnInv = '', ""Null»лиѕусто"", trim(h.cidutCnInv))) as cidutCnInv "
'    sQ = sQ & "                                                         from "
'    sQ = sQ & "                                                             ( "
'    sQ = sQ & "                                                                 select u.cidutCntrPrtNum, u.cidutCntrPrtName, u.cidutCntrPrtITN, u.cidutCnName, u.cidutCnDate, u.cn_key, t.cidutCnInv, t.cidutAccount "
'    sQ = sQ & "                                                                 from "
'    sQ = sQ & "                                                                     ( "
'    sQ = sQ & "                                                                         SELECT  "
'    sQ = sQ & "                                                                             k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
'    sQ = sQ & "                                                                         From "
'    sQ = sQ & "                                                                             ( "
'    sQ = sQ & "                                                                                 SELECT  "
'    sQ = sQ & "                                                                                     a.cidutAccount, a.cidutCntrPrtNum, a.cidutCntrPrtName, a.cidutCntrPrtITN, a.cidutCnDate,  "
'    sQ = sQ & "                                                                                     iif(isnull(a.cidutCnName), ""Null»лиѕусто"", iif(a.cidutCnName = '', ""Null»лиѕусто"", TRIM(a.cidutCnName))) AS cidutCnName,  "
'    sQ = sQ & "                                                                                     a.cidutCnInv, a.cidutFormtnDate, a.cidutMatrtyDate, a.cidutDebt, a.cidutDebtOverdue, a.cidutDoc,  "
'    sQ = sQ & "                                                                                     a.cidutLink, a.cidutSheet, a.cidutSheetNum, a.cidutUnloadKey "
'    sQ = sQ & "                                                                                 FROM  "
'    sQ = sQ & "                                                                                     CnInvDbtUplTbl as a "
'    sQ = sQ & "                                                                                     Left join "
'    sQ = sQ & "                                                                                         ( "
'    sQ = sQ & "                                                                                             SELECT  "
'    sQ = sQ & "                                                                                                 z.cidutCntrPrtNum, z.cidutCntrPrtName, z.cidutCntrPrtITN, x.org_id_value_l, x.org, x.org_id_key  "
'    sQ = sQ & "                                                                                             FROM  "
'    sQ = sQ & "                                                                                                 ( "
'    sQ = sQ & "                                                                                                     SELECT cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN  "
'    sQ = sQ & "                                                                                                     FROM CnInvDbtUplTbl  "
'    sQ = sQ & "                                                                                                     GROUP BY cidutCntrPrtNum, cidutCntrPrtName, cidutCntrPrtITN "
'    sQ = sQ & "                                                                                                 ) AS z  "
'    sQ = sQ & "                                                                                                 LEFT JOIN  "
'    sQ = sQ & "                                                                                                     ( "
'    sQ = sQ & "                                                                                                         SELECT org_id_value_l, org, org_id_type, org_id_key  "
'    sQ = sQ & "                                                                                                         FROM ags_org_id  "
'    sQ = sQ & "                                                                                                         WHERE org_id_type = 1 "
'    sQ = sQ & "                                                                                                     ) AS x ON z.cidutCntrPrtNum = x.org_id_value_l  "
'    sQ = sQ & "                                                                                             WHERE (((x.org_id_key) Is Null))  "
'    sQ = sQ & "                                                                                         ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum "
'    sQ = sQ & "                                                                                 where b.cidutCntrPrtName is null "
'    sQ = sQ & "                                                                             ) as k "
'    sQ = sQ & "                                                                             Left join "
'    sQ = sQ & "                                                                                 ( "
'    sQ = sQ & "                                                                                     SELECT  "
'    sQ = sQ & "                                                                                         c.cn_key,  "
'    sQ = sQ & "                                                                                         iif(isnull(c.cn_number), ""Null»лиѕусто"", iif(c.cn_number = '', ""Null»лиѕусто"", TRIM(c.cn_number))) AS cn_number,  "
'    sQ = sQ & "                                                                                         s.cn_s_key, s.cn_s_type, o.cn_s_org_key, o.org_id, c.cn_date, o.date_beg, o.date_end,  "
'    sQ = sQ & "                                                                                         o.csoCnDate, i.org_id_value_l, g.ogNm "
'    sQ = sQ & "                                                                                     FROM  "
'    sQ = sQ & "                                                                                         ( "
'    sQ = sQ & "                                                                                             ( "
'    sQ = sQ & "                                                                                                 ( "
'    sQ = sQ & "                                                                                                     ags_cn AS c  "
'    sQ = sQ & "                                                                                                     INNER JOIN  "
'    sQ = sQ & "                                                                                                         ags_cn_s AS s ON c.cn_key = s.cn_key "
'    sQ = sQ & "                                                                                                 )  "
'    sQ = sQ & "                                                                                                 INNER JOIN  "
'    sQ = sQ & "                                                                                                     ags_cn_s_org AS o ON s.cn_s_key = o.cn_s_key "
'    sQ = sQ & "                                                                                             )  "
'    sQ = sQ & "                                                                                             INNER JOIN  "
'    sQ = sQ & "                                                                                                 ags_org_id AS i ON o.org_id = i.org_id_key "
'    sQ = sQ & "                                                                                         )  "
'    sQ = sQ & "                                                                                         INNER JOIN ags_og AS g ON i.org = g.ogKey "
'    sQ = sQ & "                                                                                     WHERE (((s.cn_s_type)=2)) "
'    sQ = sQ & "                                                                                 ) as l ON (k.cidutCntrPrtNum = l.org_id_value_l) AND (k.cidutCnName = l.cn_number)  AND ((k.cidutCnDate = l.csoCnDate) or (isnull(k.cidutCnDate) and isnull(l.csoCnDate))) "
'    sQ = sQ & "                                                                         WHERE (((l.cn_key) Is not Null)) "
'    sQ = sQ & "                                                                         GROUP BY k.cidutCntrPrtNum, k.cidutCntrPrtName, k.cidutCntrPrtITN, k.cidutCnName, k.cidutCnDate, l.cn_key "
'    sQ = sQ & "                                                                     ) as u "
'    sQ = sQ & "                                                                 left join "
'    sQ = sQ & "                                                                     CnInvDbtUplTbl as t "
'    sQ = sQ & "                                                                     on u.cidutCntrPrtNum = t.cidutCntrPrtNum and u.cidutCnName = t.cidutCnName and (u.cidutCnDate = t.cidutCnDate or (isnull(u.cidutCnDate) and isnull(t.cidutCnDate))) "
'    sQ = sQ & "                                                             ) as h "
'    sQ = sQ & "                                                         group by "
'    sQ = sQ & "                                                             h.cidutCntrPrtNum, h.cidutCntrPrtName, h.cidutCnName, h.cidutCnDate, h.cn_key, h.cidutCnInv "
'    sQ = sQ & "                                                     ) as f "
'    sQ = sQ & "                                                     left join "
'    sQ = sQ & "                                                         ( "
'    sQ = sQ & "                                                             select  "
'    sQ = sQ & "                                                                 i.ciKey, i.ciCn, iif(isnull(i.ciNum), ""Null»лиѕусто"", iif(i.ciNum = '', ""Null»лиѕусто"", trim(i.ciNum))) as ciNum "
'    sQ = sQ & "                                                             from  "
'    sQ = sQ & "                                                                 ags_cnInv i "
'    sQ = sQ & "                                                         ) as g on f.cn_key = g.ciCn and f.cidutCnInv = g.ciNum "
'    sQ = sQ & "                                                 where g.ciKey is not null "
'    sQ = sQ & "                                             ) as z "
'    sQ = sQ & "                                             left join "
'    sQ = sQ & "                                                 ( "
'    sQ = sQ & "                                                     select "
'    sQ = sQ & "                                                         i.cidutCntrPrtNum,  "
'    sQ = sQ & "                                                         iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
'    sQ = sQ & "                                                         i.cidutCnDate, ii.account_num, "
'    sQ = sQ & "                                                         iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
'    sQ = sQ & "                                                         i.cidutAccount "
'    sQ = sQ & "                                                     from "
'    sQ = sQ & "                                                         CnInvDbtUplTbl as i "
'    sQ = sQ & "                                                         inner join "
'    sQ = sQ & "                                                             ags_accnt as ii on i.cidutAccount = ii.account_key "
'    sQ = sQ & "                                                 ) as y on z.cidutCntrPrtNum = y.cidutCntrPrtNum and z.cidutCnName = y.cidutCnName  "
'    sQ = sQ & "                                                     and (z.cidutCnDate = y.cidutCnDate or (isnull(z.cidutCnDate) and isnull(y.cidutCnDate))) and z.cidutCnInv = y.cidutCnInv "
'    sQ = sQ & "                                     ) as x "
'    sQ = sQ & "                                     left join "
'    sQ = sQ & "                                         ags_cnInvAccnt as w on x.ciKey = w.ciaCnInv and x.cidutAccount = w.ciaAccnt "
'    sQ = sQ & "                                 where "
'    sQ = sQ & "                                     w.ciaKey is not null "
'    sQ = sQ & "                             ) as a "
'    sQ = sQ & "                             left join "
'    sQ = sQ & "                                 ( "
'    sQ = sQ & "                                     select  "
'    sQ = sQ & "                                         i.cidutCntrPrtNum,  "
'    sQ = sQ & "                                         iif(isnull(i.cidutCnName), ""Null»лиѕусто"", iif(i.cidutCnName = '', ""Null»лиѕусто"", trim(i.cidutCnName))) as cidutCnName, "
'    sQ = sQ & "                                         i.cidutCnDate, "
'    sQ = sQ & "                                         iif(isnull(i.cidutCnInv), ""Null»лиѕусто"", iif(i.cidutCnInv = '', ""Null»лиѕусто"", trim(i.cidutCnInv))) as cidutCnInv, "
'    sQ = sQ & "                                         i.cidutAccount, i.cidutUnloadKey "
'    sQ = sQ & "                                     from "
'    sQ = sQ & "                                         CnInvDbtUplTbl as i "
'    sQ = sQ & "                                 ) as b on a.cidutCntrPrtNum = b.cidutCntrPrtNum and a.cidutCnName = b.cidutCnName  "
'    sQ = sQ & "                                     and (a.cidutCnDate = b.cidutCnDate or (isnull(a.cidutCnDate) and isnull(b.cidutCnDate))) and a.cidutCnInv = b.cidutCnInv and a.cidutCnInv = b.cidutCnInv and a.cidutAccount = b.cidutAccount "
'    sQ = sQ & "                     ) as h "
'    sQ = sQ & "                 group by "
'    sQ = sQ & "                     h.ciaKey "
'    sQ = sQ & "             ) as k on j.ciaKey = k.ciaKey "
'    sQ = sQ & "     where k.cidutUnloadKeyCount = 1 "
'    sQ = sQ & " ) as n "
'    sQ = sQ & " left join "
'    sQ = sQ & "     ags_cn_inv_dbt as m on n.cidutUnloadKey = m.cn_inv_dbt_upl and n.ciaKey = m.cidCnInvAccnt "
'    sQ = sQ & "where "
'    sQ = sQ & " m.cn_inv_dbt_key is null"

    SqlCnCtptInvAccExistDbtNotLoad = sQ

End Function
' клеем длинный SQL дл€ процедуры *ќтображаем пары —‘+—√  не имеющие задолженности в Ѕƒ либо добавл€ем их туда*, окончание **************************
'****************************************************************************************************************************************************


'****************************************************************************************************************************************************
' формируем склейку номеров счетов-фактур ***********************************************************************************************************
Function CnInvConcat(db As DAO.Database, cidutciCn_key As Long, _
    Optional ByVal pCiduf = 0, Optional ByVal pCnNnn = 0 _
    ) As String
    Dim strSql As String, strDate As String, rs As DAO.Recordset, iii As Integer, strRslt As String, strNull As String
    Const cstrTitle As String = "ѕроцедура *‘ормируем склейку номеров счетов-фактур*"
    '************************************************************************************************************************************************
    
On Error GoTo ErrHandler

    strSql = ""
    strSql = strSql & "SELECT cidutciCnName, cidutciCnInv, inNumCount "
    strSql = strSql & "FROM CnInvDbtUplTblCnInv "
    strSql = strSql & "WHERE cidutciCn_key = " & cidutciCn_key & " "
    strSql = strSql & "GROUP BY cidutciCnName, cidutciCnInv, inNumCount"
    
    Set rs = db.OpenRecordset(strSql, dbOpenSnapshot)
    
    ' имеютс€ ли записи?
    If rs.RecordCount > 0 Then
        ' да, записи имеютс€
        ' проходим по каждой записи
        rs.MoveFirst: iii = 1: strRslt = ""
        Do Until rs.EOF = True
            ' провер€ем на пустоту, пустой?
            If IsNull(rs!cidutciCnInv) Or rs!cidutciCnInv = "" Then
                ' да, пустой
                strNull = "*<font color=""DarkOrange"">пуста€ строка</font>*"
                ' если ранее номер встречалс€, то указываем сколько раз
                If Not IsNull(rs!inNumCount) Then
                    strNull = strNull & " {<font color=""Salmon"">встречалс€ " & rs!inNumCount & " раз(а)</font>}"
                    ' добавл€ем записи дво€щих счЄтов-фактур в специальную таблицу
                    If pCiduf <> 0 Then
                        CnInvDbtUplFileInvDoubleAdd db, pCiduf, pCnNnn, rs!cidutciCnName, cidutciCn_key, iii, rs!cidutciCnInv, rs!inNumCount
                    End If
                End If
                Else
                ' нет, не пустой
                strNull = rs!cidutciCnInv
                ' если ранее номер встречалс€, то указываем сколько раз
                If Not IsNull(rs!inNumCount) Then
                    strNull = strNull & " {<font color=""Salmon"">встречалс€ " & rs!inNumCount & " раз(а)</font>}"
                    ' добавл€ем записи дво€щих счЄтов-фактур в специальную таблицу
                    If pCiduf <> 0 Then
                        CnInvDbtUplFileInvDoubleAdd db, pCiduf, pCnNnn, rs!cidutciCnName, cidutciCn_key, iii, rs!cidutciCnInv, rs!inNumCount
                    End If
                End If
            End If
            ' формируем результат
            If iii = 1 Then
                strRslt = "<font color=""MediumOrchid"">" & iii & "</font>. " & strNull
                Else
                strRslt = strRslt & "; <font color=""MediumOrchid"">" & iii & "</font>. " & strNull
            End If
            ' переходим к следующей записи
            rs.MoveNext: iii = iii + 1
        Loop
        CnInvConcat = strRslt
        Else
        ' нет, записи отсутствуют
        CnInvConcat = "*нет записей*"
    End If
    
    rs.Close: Set rs = Nothing

NormalExit:
    Exit Function
    
ErrHandler:
    MsgBox Err.Description & vbCrLf & "Error number: " & Err.Number & vbCrLf & cstrTitle, vbExclamation, cstrTitle
    Resume NormalExit

End Function
' формируем склейку номеров счетов-фактур, окончание ************************************************************************************************
'****************************************************************************************************************************************************

'****************************************************************************************************************************************************
' добавл€ем записи дво€щих счЄтов-фактур в специальную таблицу 25.10.2022 10:14 *********************************************************************
Private Sub CnInvDbtUplFileInvDoubleAdd(ByRef db As DAO.Database, _
        ByVal pCiduf As Long, ByVal pCnNnn As Long, ByVal pCnNum As String, ByVal pCnKey As Long, ByVal pInvNnn As Long, _
        ByVal pInvNum As String, ByVal pInvNumCount As Long _
    )
    Dim rs As DAO.Recordset, lngCnInvDbtUplFileInvDouble As Long
    Const cstrTitle As String = "ѕроцедура ƒобавл€ем записи дво€щих счЄтов-фактур в специальную таблицу*"
    '************************************************************************************************************************************************
    
On Error GoTo ErrHandler
    
    Set rs = db.OpenRecordset("CnInvDbtUplFileInvDouble", dbOpenDynaset)
        
    ' добавл€ем счЄт-фактуру
    With rs
        .AddNew
            !cidufiCiduf = pCiduf
            !cidufiCnNnn = pCnNnn
            !cidufiCnNum = pCnNum
            !cidufiCnKey = pCnKey
            !cidufiInvNnn = pInvNnn
            !cidufiInvNum = pInvNum
            !cidufiInvNumCount = pInvNumCount
        .Update
        .Bookmark = .LastModified
        lngCnInvDbtUplFileInvDouble = !cidufiKey
    End With
        
    rs.Close: Set rs = Nothing

NormalExit:
    Exit Sub
    
ErrHandler:
    MsgBox Err.Description & vbCrLf & "Error number: " & Err.Number & vbCrLf & cstrTitle, vbExclamation, cstrTitle
    Resume NormalExit
End Sub
' добавл€ем записи дво€щих счЄтов-фактур в специальную таблицу 25.10.2022 10:14, окончание **********************************************************
'****************************************************************************************************************************************************

'****************************************************************************************************************************************************
' формируем склейку номеров счетов-фактур дл€ платежей 14.12.2021 16:55 *****************************************************************************
Function CnInvConcatPm(db As DAO.Database, CntrPrtNum As Long, cnName As String, _
    Optional CnDate As Date = #1/1/1900#) As String

    Dim strSql As String, strDate As String, rs As DAO.Recordset, iii As Integer, strRslt As String, strNull As String

    Const cstrTitle As String _
        = "ѕроцедура *‘ормируем склейку номеров счетов-фактур дл€ платежей. ћодуль: SqlLong, CnInvConcatPm.*"
    '************************************************************************************************************************************************
    
On Error GoTo ErrHandler

    strSql = ""
    
    If CnDate = #1/1/1900# Then
        strSql = strSql & "SELECT ciputciCntrPrtNum, ciputciCnName, ciputciCnDate, ciputciCnInv, ciputciCnInvNumCount "
        strSql = strSql & "FROM CnInvPmtUplTblCnInv "
        strSql = strSql & "WHERE (((ciputciCntrPrtNum) = " & CntrPrtNum & ") And ((ciputciCnName) = """ & cnName & """) And ((ciputciCnDate) is Null)) "
        strSql = strSql & "GROUP BY ciputciCntrPrtNum, ciputciCnName, ciputciCnDate, ciputciCnInv, ciputciCnInvNumCount"
        Else
        strDate = DateConvertToQuery(CnDate)
        strSql = strSql & "SELECT ciputciCntrPrtNum, ciputciCnName, ciputciCnDate, ciputciCnInv, ciputciCnInvNumCount, ciputciCnInvNumCount "
        strSql = strSql & "FROM CnInvPmtUplTblCnInv "
        strSql = strSql & "WHERE (((ciputciCntrPrtNum) = " & CntrPrtNum & ") And ((ciputciCnName) = """ & cnName & """) And ((ciputciCnDate) = " & strDate & ")) "
        strSql = strSql & "GROUP BY ciputciCntrPrtNum, ciputciCnName, ciputciCnDate, ciputciCnInv, ciputciCnInvNumCount"
    End If
    
    Set rs = db.OpenRecordset(strSql, dbOpenSnapshot)
    
    ' имеютс€ ли записи?
    If rs.RecordCount > 0 Then
        ' да, записи имеютс€
        ' проходим по каждой записи
        rs.MoveFirst: iii = 1: strRslt = ""
        Do Until rs.EOF = True
            ' провер€ем на пустоту
            If IsNull(rs!ciputciCnInv) Or rs!ciputciCnInv = "" Then
                strNull = "*<font color=""DarkOrange"">пуста€ строка</font>*"
                Else
                strNull = rs!ciputciCnInv
            End If
            ' формируем результат
            If iii = 1 Then
                strRslt = "<font color=""MediumOrchid"">" & iii & "</font>. " & strNull
                Else
                strRslt = strRslt & "; <font color=""MediumOrchid"">" & iii & "</font>. " & strNull
            End If
            ' если ранее номер встречалс€, то указываем сколько раз
            If Not IsNull(rs!ciputciCnInvNumCount) Then
                strRslt = strRslt & " {<font color=""Salmon"">был " & rs!ciputciCnInvNumCount & " раз(а)</font>}"
            End If
            ' переходим к следующей записи
            rs.MoveNext: iii = iii + 1
        Loop
        CnInvConcatPm = strRslt
        Else
        ' нет, записи отсутствуют
        CnInvConcatPm = "*нет записей*"
    End If
    
    rs.Close: Set rs = Nothing

NormalExit:
    Exit Function
    
ErrHandler:
    MsgBox Err.Description & vbCrLf & "Error number: " & Err.Number & vbCrLf & cstrTitle, vbExclamation, cstrTitle
    Resume NormalExit

End Function
' формируем склейку номеров счетов-фактур дл€ платежей, окончание ***********************************************************************************
'****************************************************************************************************************************************************


