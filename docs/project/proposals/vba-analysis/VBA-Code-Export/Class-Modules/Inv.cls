VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
END
Attribute VB_Name = "Inv"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
Option Compare Database

' объект *Счёт-фактура*

' ###################################################################################################################################################
' область определения закрытых пременных, содержащих значения свойств ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' !!! не нужно их писать в других местах, это приведет к ошибке. 07.07.2022
' ключ счёта-фактуры
Private lngInvKey As Long
' база данных
Private mdbDb As DAO.Database
' область определения закрытых пременных, содержащих значения свойств ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' ---------------------------------------------------------------------------------------------------------------------------------------------------
Const cstrTable As String = "ags_inv", cstrTableKeyField As String = "iKey"
' ---------------------------------------------------------------------------------------------------------------------------------------------------
' ###################################################################################################################################################

' ###################################################################################################################################################
' геттеры и сеттеры (леттеры) свойств

' +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
' свойство *ключ объекта #Счёт-фактура#*. 21.07.2022
' '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' геттер свойства *ключ объекта #Отчёт агента#*
Public Property Get iKey() As String
    ' -----------------------------------------------------------------------------------------------------------------------------------------------
    iKey = lngInvKey
End Property ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' свойство *ключ объекта #Отчёт агента#*. 21.07.2022. Окончание
' +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

' +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
' свойство *Счёт-фактура, наименование*. 06.02.2023
' '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' геттер свойства *Стройка, наименование*
Public Property Get strInvName() As Variant
    Const cstrTitle As String = "Процедура *Геттер свойства *Счёт-фактура, наименование*."
    ' -----------------------------------------------------------------------------------------------------------------------------------------------
On Error GoTo ErrHandler

    strInvName = readFieldVar("iName")

NormalExit:
    Exit Property
ErrHandler:
    MsgBox Err.Description & vbCrLf & "Error number: " & Err.Number & vbCrLf & cstrTitle, vbExclamation, cstrTitle: Resume NormalExit
End Property ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' свойство *Счёт-фактура, наименование*. 06.02.2023. Окончание
' +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
' геттеры и сеттеры (леттеры) свойств. Окончание
' ###################################################################################################################################################

' ###################################################################################################################################################
' инициализации и реинициализации
' ***************************************************************************************************************************************************
' обработка встроенного события инициализации
Private Sub Class_Initialize()
    ' инициализируем объект с нулевым ключём. В таком виде он не имеет смысла.
    ' Требуется реинициализация.
    ' -1 означает, что проверки наличия свойства не было. Если позже будет установлено значение свойства,
    ' то оно будет приведено к 0 при отсутствии и к значению при наличии.
    ' Это чтобы избежать необходимости каждый раз вычислять свойство заново
    lngInvKey = -1
End Sub
' ***************************************************************************************************************************************************

' ***************************************************************************************************************************************************
' реинициализируем объект счёта-фактуры по известному ключу такого объекта. 06.02.2023
' ...................................................................................................................................................
Public Sub ReinitialiseByKey(ByVal iKey As Long, ByRef boResult As Boolean, ByRef db As DAO.Database)
    ' ...............................................................................................................................................
    Dim rs As DAO.Recordset, strSql As String
    ' -----------------------------------------------------------------------------------------------------------------------------------------------
    Const cstrTitle As String = "Процедура *Реинициализируем объект счёта-фактуры по известному ключу такого объекта*."
' ---------------------------------------------------------------------------------------------------------------------------------------------------
On Error GoTo ErrHandler

    ' ключ объекта равен -1? То есть реинициализация ранее не проводилась
    If lngInvKey = -1 Then
        ' да,ключ объекта равен -1
        ' отыскиваем объект по известному ключу
        strSql = "SELECT * FROM " & cstrTable & " WHERE " & cstrTableKeyField & " = " & iKey & ";"
        Set rs = db.OpenRecordset(strSql, dbOpenSnapshot)
        
        ' имеются ли записи с указанным ключём?
        If rs.RecordCount = 1 Then
            ' да, записи с указанным ключём имеются
            lngInvKey = iKey
            Set mdbDb = db ' устанавливаем ссылку на базу данных
            boResult = True ' результат положительный
        Else
            ' нет, записи с указанным ключём отсутствуют
            lngInvKey = 0
            boResult = False ' результат отрицательный
        End If
    Else
        ' да,ключ объекта не равен -1
        ' ключ объекта равен 0?
        If lngInvKey = 0 Then
            ' да, ключ объекта равен 0. Ранее он безуспешно реинициализировался
            boResult = False
        Else
            ' нет, ключ объекта не равен 0. Ранее он успешно реинициализировался
            boResult = True
        End If
    End If
    
    ' закрываем набор записей
    rs.Close: Set rs = Nothing
    
NormalExit:
    Exit Sub
ErrHandler:
    MsgBox Err.Description & vbCrLf & "Error number: " & Err.Number & vbCrLf & cstrTitle, vbExclamation, cstrTitle: Resume NormalExit
End Sub
' реинициализируем объект счёта-фактуры по известному ключу такого объекта. 06.02.2023. Окончание
' ***************************************************************************************************************************************************

' ***************************************************************************************************************************************************
' реинициализируем объект счёта-фактуры через создание нового по номеру и дате. 22.03.2022
Public Sub riInvCreateNewNumDate(invNum As Variant, invDate As Variant, db As DAO.Database, strNote As String)
    Dim invNew As Inv, invNumNew As invNum
    Const cstrTitle As String = "Процедура *Реинициализируем объект счёта-фактуры через создание нового по номеру и дате*."
    '************************************************************************************************************************************************
On Error GoTo ErrHandler
    
    ' получаем ключ счёта-фактуры путём создания его по дате
    Set invNew = ClassFactory.invCreateNewDate(invDate, db, strNote)
    lngInvKey = invNew.iKey
    Set invNew = Nothing
    
    ' создаём номер для вновь созданного счёта-фактуры
    Set invNumNew = ClassFactory.invNumCreateNew(invNum, lngInvKey, db, strNote)
    Set invNumNew = Nothing
    
NormalExit:
    Exit Sub
ErrHandler:
    MsgBox Err.Description & vbCrLf & "Error number: " & Err.Number & vbCrLf & cstrTitle, vbExclamation, cstrTitle
    Resume NormalExit
    
End Sub
' реинициализируем объект счёта-фактуры через создание нового по номеру и дате. 22.03.2022. Окончание
' ***************************************************************************************************************************************************

' ***************************************************************************************************************************************************
' реинициализируем объект счёта-фактуры через создание нового по дате. 22.03.2022. Здесь выходит заготовка, без номера.
Public Sub riInvCreateNewDate(invDate As Variant, db As DAO.Database, strNote As String)

    Dim rstInv As DAO.Recordset
    
    Const cstrTitle As String _
        = "Процедура *Реинициализируем объект счёта-фактуры через создание нового по дате*."
        
    '************************************************************************************************************************************************
    
On Error GoTo ErrHandler
    
    ' открываем таблицу для добавления
    Set rsInv = db.OpenRecordset("ags_inv", dbOpenDynaset, dbSeeChanges)
    
    ' добавляем счёт-фактуру
    With rsInv
        .AddNew
            !iTimeOfEntry = Now()
            !iDate = invDate
            !iNote = strNote
        .Update
        .Bookmark = .LastModified
        lngInvKey = !iKey
    End With
    
    ' закрываем набор данных таблицы для добавления
    rsInv.Close: Set rsInv = Nothing
        
NormalExit:
    Exit Sub
    
ErrHandler:
    MsgBox Err.Description & vbCrLf & "Error number: " & Err.Number & vbCrLf & cstrTitle, vbExclamation, cstrTitle
    Resume NormalExit
    
End Sub
' реинициализируем объект счёта-фактуры через создание нового по дате. 22.03.2022. Здесь выходит заготовка, без номера. Окончание
' ***************************************************************************************************************************************************
' инициализации и реинициализации. Окончание
' ###################################################################################################################################################

' ###################################################################################################################################################
' чтение полей и запись в них
' ***************************************************************************************************************************************************
' редактируем строковое поле. 09.08.2022
Private Sub editFieldStr(ByVal strFieldName As String, ByVal strNew As Variant)

    ClassFunc.varEditFieldStr strFieldName, strNew, cstrTable, lngInvKey, cstrTableKeyField, mdbDb
    
End Sub
' редактируем строковое поле. 09.08.2022. Окончание
' ***************************************************************************************************************************************************

' ***************************************************************************************************************************************************
' читаем значение поля в переменную типа Variant. 09.08.2022
Private Function readFieldVar(ByVal dateFieldName As String) As Variant
    
    readFieldVar = ClassFunc.varReadField(dateFieldName, cstrTable, lngInvKey, cstrTableKeyField, mdbDb)
    
End Function
' читаем значение поля в переменную типа Variant. 09.08.2022. Окончание
' ***************************************************************************************************************************************************

' ***************************************************************************************************************************************************
' редактируем поле даты. 09.08.2022
Private Sub editFieldDate(ByVal dateFieldName As String, ByVal dateNew As Variant)
    
    ClassFunc.varEditFieldDate dateFieldName, dateNew, cstrTable, lngInvKey, cstrTableKeyField, mdbDb
    
End Sub
' редактируем поле даты. 09.08.2022. Окончание
' ***************************************************************************************************************************************************

' ***************************************************************************************************************************************************
' редактируем числовое поле. 09.08.2022
Private Sub editFieldNum(ByVal numFieldName As String, ByVal numNew As Variant)
    
    ClassFunc.varEditFieldNum numFieldName, numNew, cstrTable, lngInvKey, cstrTableKeyField, mdbDb
    
End Sub
' редактируем числовое поле. 09.08.2022. Окончание
' ***************************************************************************************************************************************************
' чтение полей и запись в них. Окончание
' ###################################################################################################################################################

' ###################################################################################################################################################
' методы
' ***************************************************************************************************************************************************
' возвращаем перечень номеров счёта-фактуры имеющихся в источнике загрузки дебиторки. 06.02.2023
Public Function invNumbersInDebtUpl(ByRef db As DAO.Database, ByRef rs As DAO.Recordset) As Boolean

    Dim qdef As DAO.QueryDef

    Const cstrTitle As String _
        = "Функция *Возвращаем перечень номеров счёта-фактуры имеющихся в источнике загрузки дебиторки*."
        
    '************************************************************************************************************************************************
    
On Error GoTo ErrHandler

' invDoubleNum
    Set qdef = db.QueryDefs("invDoubleNum")
    qdef.Parameters!iKey = lngInvKey
    ' открываем набор записей
    Set rs = qdef.OpenRecordset(dbOpenSnapshot)
        
    If rs.RecordCount > 0 Then
        rs.MoveLast: rs.MoveFirst
        invNumbersInDebtUpl = True
    Else
        invNumbersInDebtUpl = False
    End If
    
    Set qdef = Nothing

NormalExit:
    Exit Function
    
ErrHandler:
    MsgBox Err.Description & vbCrLf & "Error number: " & Err.Number & vbCrLf & cstrTitle, vbExclamation, cstrTitle
    Resume NormalExit
    
End Function
' возвращаем перечень номеров счёта-фактуры имеющихся в источнике загрузки дебиторки. 06.02.2023. Окончание
' ***************************************************************************************************************************************************
' методы. Окончание
' ###################################################################################################################################################

