VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
END
Attribute VB_Name = "cstAg"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
Option Compare Database

' класс *Стройка агента*. 26.07.2023

' ###################################################################################################################################################
' область определения закрытых пременных, содержащих значения свойств ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' тип для хранения внутренних переменных
Private Type TCstAg
    ' ключ объекта
    cstAgKey As Long
    ' база данных
    cstAgDB As DAO.Database
End Type
Private This As TCstAg
' область определения закрытых пременных, содержащих значения свойств ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' ---------------------------------------------------------------------------------------------------------------------------------------------------
Const cstrTable As String = "ags_cstAg", cstrTableKeyField As String = "cstaKey"
' ---------------------------------------------------------------------------------------------------------------------------------------------------
' ###################################################################################################################################################

' ###################################################################################################################################################
' геттеры и сеттеры (леттеры) свойств
' +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
' свойство *ключ объекта #Стройка агента#*. 26.07.2023
' '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' геттер свойства *ключ объекта #Стройка агента#*
Public Property Get cstAgKey() As Long
    ' -----------------------------------------------------------------------------------------------------------------------------------------------
    cstAgKey = This.cstAgKey
End Property ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' свойство *ключ объекта #Стройка агента#*. 26.07.2023. Окончание
' +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
' геттеры и сеттеры (леттеры) свойств. Окончание
' ###################################################################################################################################################

' ###################################################################################################################################################
' инициализации и реинициализации
' ***************************************************************************************************************************************************
' обработка встроенного события инициализации
Private Sub Class_Initialize()
    ' инициализируем объект с нулевым ключём. В таком виде он не имеет смысла.
    ' Требуется реинициализация.
    This.cstAgKey = -1
End Sub
' ***************************************************************************************************************************************************

' ***************************************************************************************************************************************************
' реинициализируем объект *Стройка агента* созданием нового, а также объекта *Стройка* по имени и коду агента. 26.07.2023
' ...................................................................................................................................................
Public Sub riByNameAndAgent(ByVal cstName As String, ByVal agCode As String, ByRef boResult As Boolean, ByRef db As DAO.Database)
    ' ...............................................................................................................................................
    Dim rs As DAO.Recordset, strSql As String, cstNew As cst, ogAgObj As ogAg
    ' -----------------------------------------------------------------------------------------------------------------------------------------------
    Const cstrTitle As String = _
    "Процедура *Реинициализируем объект *Стройка агента* созданием нового, а также объекта *Стройка* по имени и коду агента."
' ---------------------------------------------------------------------------------------------------------------------------------------------------
On Error GoTo ErrHandler

    ' ключ объекта равен -1? То есть реинициализация ранее не проводилась
    If This.cstAgKey = -1 Then
        ' да,ключ объекта равен -1
        ' создаём новый объект *Стройка*
        Set cstNew = ClassFactory.cstByNameNew(cstName, db)
        If Not cstNew Is Nothing Then
            ' создаём cstAg
            Set ogAgObj = ClassFactory.ogAgByCode(agCode, db)
            If Not ogAgObj Is Nothing Then
                Set rs = db.OpenRecordset(cstrTable, dbOpenDynaset, dbSeeChanges)
                ' заготавливаем создаваемую строку
                rs.AddNew
                    rs.Fields("cstaAg").value = ogAgObj.ogaKey
                    rs.Fields("cstaCst").value = cstNew.cstKey
                ' вносим создаваемую строку в базу данных
                rs.Update
                rs.Bookmark = rs.LastModified
                This.cstAgKey = rs.Fields(cstrTableKeyField).value
                Set This.cstAgDB = db
                boResult = True ' результат положительный
                ' закрываем набор записей
                rs.Close: Set rs = Nothing
            Else
                boResult = False
            End If
        Else
            boResult = False
        End If
    Else
        ' да,ключ объекта не равен -1
        ' ключ объекта равен 0?
        If mlngOgAgFeeKey = 0 Then
            ' да, ключ объекта равен 0. Ранее он безуспешно реинициализировался
            boResult = False
        Else
            ' нет, ключ объекта не равен 0. Ранее он успешно реинициализировался
            boResult = True
        End If
    End If
    
NormalExit:
    Exit Sub
ErrHandler:
    MsgBox Err.Description & vbCrLf & "Error number: " & Err.Number & vbCrLf & cstrTitle, vbExclamation, cstrTitle: Resume NormalExit
End Sub
' ...................................................................................................................................................
' реинициализируем объект *Стройка агента* созданием нового, а также объекта *Стройка* по имени и коду агента. 26.07.2023. Окончание
' ***************************************************************************************************************************************************

' ***************************************************************************************************************************************************
' реинициализируем объект *Стройка агента* по известному ключу. 27.07.2023
' ...................................................................................................................................................
Public Sub riByKey(ByVal cstAgKey As Long, ByRef boResult As Boolean, ByRef db As DAO.Database)
    ' ...............................................................................................................................................
    Dim rs As DAO.Recordset, strSql As String, cstNew As cst, ogAgObj As ogAg
    ' -----------------------------------------------------------------------------------------------------------------------------------------------
    Const cstrTitle As String = _
    "Процедура *Реинициализируем объект *Стройка агента* по известному ключу."
' ---------------------------------------------------------------------------------------------------------------------------------------------------
On Error GoTo ErrHandler

    ' ключ объекта равен -1? То есть реинициализация ранее не проводилась
    If This.cstAgKey = -1 Then
        ' да,ключ объекта равен -1
        ' отыскиваем объект по известному ключу
        strSql = "SELECT * FROM " & cstrTable & " WHERE " & cstrTableKeyField & " = " & cstAgKey & ";"
        Set rs = db.OpenRecordset(strSql, dbOpenSnapshot)
        
        ' имеются ли записи с указанным ключём?
        If rs.RecordCount = 1 Then
            ' да, записи с указанным ключём имеются
            This.cstAgKey = cstAgKey
            Set This.cstAgDB = db ' устанавливаем ссылку на базу данных
            boResult = True ' результат положительный
        Else
            ' нет, записи с указанным ключём отсутствуют
            This.cstAgKey = 0
            boResult = False ' результат отрицательный
        End If
        
        ' закрываем набор записей
        rs.Close: Set rs = Nothing
    Else
        ' да,ключ объекта не равен -1
        ' ключ объекта равен 0?
        If This.cstAgKey = 0 Then
            ' да, ключ объекта равен 0. Ранее он безуспешно реинициализировался
            boResult = False
        Else
            ' нет, ключ объекта не равен 0. Ранее он успешно реинициализировался
            boResult = True
        End If
    End If
    
NormalExit:
    Exit Sub
ErrHandler:
    MsgBox Err.Description & vbCrLf & "Error number: " & Err.Number & vbCrLf & cstrTitle, vbExclamation, cstrTitle: Resume NormalExit
End Sub
' ...................................................................................................................................................
' реинициализируем объект *Стройка агента* по известному ключу. 27.07.2023. Окончание
' ***************************************************************************************************************************************************
' инициализации и реинициализации. Окончание
' ###################################################################################################################################################

