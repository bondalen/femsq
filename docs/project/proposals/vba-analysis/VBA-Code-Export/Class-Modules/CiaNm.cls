VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
END
Attribute VB_Name = "CiaNm"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
Option Compare Database

' объект *Задолженность с именем* 07.02.2023

' ###################################################################################################################################################
' область определения закрытых пременных, содержащих значения свойств ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' !!! не нужно их писать в других местах, это приведет к ошибке. 07.07.2022
' ключ счёта-фактуры
Private lngCiaKey As Long
' ключ счёта-фактуры
Private varCiaName As Variant
' база данных
Private mdbDb As DAO.Database
' область определения закрытых пременных, содержащих значения свойств ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
' ---------------------------------------------------------------------------------------------------------------------------------------------------
Const cstrTable As String = "ags_cnInvAccnt", cstrTableKeyField As String = "ciaKey"
' ---------------------------------------------------------------------------------------------------------------------------------------------------
' ###################################################################################################################################################

' ###################################################################################################################################################
' геттеры и сеттеры (леттеры) свойств

' +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
' свойство *ключ объекта #Задолженность#* объекта *Задолженность с именем*. 07.02.2023
' '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' геттер свойства *ключ объекта #Задолженность#*
Public Property Get ciaKey() As Long
    ' -----------------------------------------------------------------------------------------------------------------------------------------------
    ciaKey = lngCiaKey
End Property ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' свойство *ключ объекта #Задолженность#* объекта *Задолженность с именем*. 07.02.2023. Окончание
' +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

' +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
' свойство *родительский объект #Задолженность#* объекта *Задолженность с именем*. 07.02.2023
' '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' геттер свойства *родительский объект #Задолженность#*
Public Property Get ciaParentObj() As Cia
    ' -----------------------------------------------------------------------------------------------------------------------------------------------
    If IsNull(lngCiaKey) = False And Not mdbDb Is Nothing Then
        If lngCiaKey > 0 Then
            Set ciaParentObj = ClassFactory.ciaByKey(lngCiaKey, mdbDb)
        Else
            Set ciaParentObj = Nothing
        End If
    Else
        Set ciaParentObj = Nothing
    End If
End Property ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' свойство *родительский объект #Задолженность#* объекта *Задолженность с именем*. 07.02.2023. Окончание
' +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

' +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
' свойство *Имя задолженности* объекта *Задолженность с именем*. 07.02.2023
' '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' геттер свойства *ключ объекта #Задолженность#*
Public Property Get ciaName() As Variant
    ' -----------------------------------------------------------------------------------------------------------------------------------------------
    ciaName = varCiaName
End Property ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' свойство *Имя задолженности* объекта *Задолженность с именем*. 07.02.2023. Окончание
' +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
' геттеры и сеттеры (леттеры) свойств. Окончание
' ###################################################################################################################################################

' ###################################################################################################################################################
' инициализации и реинициализации
' ***************************************************************************************************************************************************
' обработка встроенного события инициализации
Private Sub Class_Initialize()
    ' инициализируем объект с нулевым ключём. В таком виде он не имеет смысла.
    ' Требуется реинициализация.
    ' -1 означает, что проверки наличия свойства не было. Если позже будет установлено значение свойства,
    ' то оно будет приведено к 0 при отсутствии и к значению при наличии.
    ' Это чтобы избежать необходимости каждый раз вычислять свойство заново
    lngCiaKey = -1: varCiaName = Null
End Sub
' ***************************************************************************************************************************************************

' ***************************************************************************************************************************************************
' реинициализируем объект *Задолженность с именем* по известному ключу объекта #Задолженность#*. 07.02.2023
' ...................................................................................................................................................
Public Sub ReinitByCiaKey(ByVal ciaKey As Long, ByRef boResult As Boolean, ByRef db As DAO.Database)
    ' ...............................................................................................................................................
    Dim rs As DAO.Recordset, strSql As String
    ' -----------------------------------------------------------------------------------------------------------------------------------------------
    Const cstrTitle As String = "Процедура *Реинициализируем объект *Задолженность* по известному ключу такого объекта*."
' ---------------------------------------------------------------------------------------------------------------------------------------------------
On Error GoTo ErrHandler

    ' ключ объекта равен -1? То есть реинициализация ранее не проводилась
    If lngCiaKey = -1 Then
        ' да,ключ объекта равен -1
        ' отыскиваем объект по известному ключу
        strSql = "SELECT * FROM " & cstrTable & " WHERE " & cstrTableKeyField & " = " & ciaKey & ";"
        Set rs = db.OpenRecordset(strSql, dbOpenSnapshot)
        
        ' имеются ли записи с указанным ключём?
        If rs.RecordCount = 1 Then
            ' да, записи с указанным ключём имеются
            lngCiaKey = ciaKey
            Set mdbDb = db ' устанавливаем ссылку на базу данных
            varCiaName = Null
            boResult = True ' результат положительный
        Else
            ' нет, записи с указанным ключём отсутствуют
            lngCiaKey = 0
            boResult = False ' результат отрицательный
        End If
    Else
        ' да,ключ объекта не равен -1
        ' ключ объекта равен 0?
        If lngCiaKey = 0 Then
            ' да, ключ объекта равен 0. Ранее он безуспешно реинициализировался
            boResult = False
        Else
            ' нет, ключ объекта не равен 0. Ранее он успешно реинициализировался
            boResult = True
        End If
    End If
    
    ' закрываем набор записей
    rs.Close: Set rs = Nothing
    
NormalExit:
    Exit Sub
ErrHandler:
    MsgBox Err.Description & vbCrLf & "Error number: " & Err.Number & vbCrLf & cstrTitle, vbExclamation, cstrTitle: Resume NormalExit
End Sub
' реинициализируем объект *Задолженность с именем* по известному ключу объекта #Задолженность#*. 07.02.2023. Окончание
' ***************************************************************************************************************************************************

' ***************************************************************************************************************************************************
' реинициализируем объект *Задолженность с именем* по ключу объекта #Счёт-фактура# и имени задолженности. 07.02.2023
' ...................................................................................................................................................
Public Sub ReinitByInvAndCiaName(ByVal iKey As Long, ByVal ciaName As String, ByRef boResult As Boolean, ByRef db As DAO.Database)
    ' ...............................................................................................................................................
    Dim rs As DAO.Recordset, strSql As String
    ' -----------------------------------------------------------------------------------------------------------------------------------------------
    Const cstrTitle As String = "Процедура *Реинициализируем объект *Задолженность* по известному ключу такого объекта*."
' ---------------------------------------------------------------------------------------------------------------------------------------------------
On Error GoTo ErrHandler

    ' ключ объекта равен -1? То есть реинициализация ранее не проводилась
    If lngCiaKey = -1 Then
        ' да,ключ объекта равен -1
        ' отыскиваем объект по известному ключу
        strSql = "SELECT cia.ciaKey " _
            & "FROM ags_cnInv AS ci INNER JOIN (" _
            & "ags_cnInvAccntSmpl AS cias INNER JOIN ags_cnInvAccnt AS cia ON cias.ciasKey = cia.ciaCnInvAccntSmpl" _
            & ") ON ci.ciKey = cias.ciasCnInv " _
            & "WHERE (((ci.ciInv)=" & iKey & ") AND ((cia.ciaName)=""" & ciaName & """));"

        Set rs = db.OpenRecordset(strSql, dbOpenSnapshot)
        
        ' имеются ли записи с указанным ключём?
        If rs.RecordCount = 1 Then
            ' да, записи с указанным ключём имеются
            lngCiaKey = rs!ciaKey
            varCiaName = ciaName
            Set mdbDb = db ' устанавливаем ссылку на базу данных
            boResult = True ' результат положительный
        Else
            ' нет, записи с указанным ключём отсутствуют
            lngCiaKey = 0
            boResult = False ' результат отрицательный
        End If
    Else
        ' да,ключ объекта не равен -1
        ' ключ объекта равен 0?
        If lngCiaKey = 0 Then
            ' да, ключ объекта равен 0. Ранее он безуспешно реинициализировался
            boResult = False
        Else
            ' нет, ключ объекта не равен 0. Ранее он успешно реинициализировался
            boResult = True
        End If
    End If
    
    ' закрываем набор записей
    rs.Close: Set rs = Nothing
    
NormalExit:
    Exit Sub
ErrHandler:
    MsgBox Err.Description & vbCrLf & "Error number: " & Err.Number & vbCrLf & cstrTitle, vbExclamation, cstrTitle: Resume NormalExit
End Sub
' реинициализируем объект *Задолженность с именем* по ключу объекта #Счёт-фактура# и имени задолженности. 07.02.2023. Окончание
' ***************************************************************************************************************************************************
' инициализации и реинициализации. Окончание
' ###################################################################################################################################################

' ###################################################################################################################################################
' методы
' ***************************************************************************************************************************************************
' возвращаем количество совпадений суммы с уже имеющимися суммами задолженностей в выгрузках. 07.02.2023
Public Function SumMatch(ByVal curSum As Currency, ByRef maxDate As Date) As Long

    Dim strSql As String, rs As DAO.Recordset, strSum As String
    ' -----------------------------------------------------------------------------------------------------------------------------------------------
    Const cstrTitle As String = "Функция *Возвращаем количество совпадений суммы с уже имеющимися суммами задолженностей в выгрузках*."
' ---------------------------------------------------------------------------------------------------------------------------------------------------
On Error GoTo ErrHandler
    
    strSum = Replace(CStr(curSum), ",", ".")
    
    If IsNull(lngCiaKey) = False And Not mdbDb Is Nothing Then
        If lngCiaKey > 0 Then
            If IsNull(varCiaName) = False Then
            strSql = "SELECT count(*) as ccc, Max([uplStatusOnDate]) AS maxD " & _
                "FROM (((((ags_cn_inv_dbt AS d INNER JOIN ags_cnInvAccnt AS cia ON d.cidCnInvAccntCtpt = cia.ciaKey) " & _
                "INNER JOIN ags_cnInvAccntSmpl AS cias ON cia.ciaCnInvAccntSmpl = cias.ciasKey) " & _
                "INNER JOIN ags_cnInv AS ci ON cias.ciasCnInv = ci.ciKey) " & _
                "INNER JOIN ags_cn_inv_dbt_upl AS u ON d.cn_inv_dbt_upl = u.upl_key) " & _
                "INNER JOIN ags_accnt AS a ON cias.ciasAccnt = a.account_key) INNER JOIN ags_cn AS c ON ci.ciCn = c.cn_key " & _
                "WHERE (((ci.ciInv)=" & ciaParentObj.ciasParentObj.cnInvParentObj.invParentObj.iKey & ") " & _
                "AND ((cia.ciaName)=""" & varCiaName & """) AND ((d.dbt_ttl)=CCur(" & strSum & ")));"
            Else
            strSql = "SELECT count(*) as ccc, Max([uplStatusOnDate]) AS maxD " & _
                "FROM (((((ags_cn_inv_dbt AS d INNER JOIN ags_cnInvAccnt AS cia ON d.cidCnInvAccntCtpt = cia.ciaKey) " & _
                "INNER JOIN ags_cnInvAccntSmpl AS cias ON cia.ciaCnInvAccntSmpl = cias.ciasKey) " & _
                "INNER JOIN ags_cnInv AS ci ON cias.ciasCnInv = ci.ciKey) " & _
                "INNER JOIN ags_cn_inv_dbt_upl AS u ON d.cn_inv_dbt_upl = u.upl_key) " & _
                "INNER JOIN ags_accnt AS a ON cias.ciasAccnt = a.account_key) INNER JOIN ags_cn AS c ON ci.ciCn = c.cn_key " & _
                "WHERE (((ci.ciInv)=" & ciaParentObj.ciasParentObj.cnInvParentObj.invParentObj.iKey & ") " & _
                "AND ((cia.ciaName) is Null) AND ((d.dbt_ttl)=CCur(" & strSum & ")));"
            End If
            
            'Debug.Print strSql
            
            Set rs = mdbDb.OpenRecordset(strSql, dbOpenSnapshot)
            If rs.RecordCount > 0 Then
                SumMatch = rs!ccc
                If Not IsNull(rs!maxD) Then
                    maxDate = rs!maxD
                Else
                    maxDate = CDate("01.01.1900")
                End If
            Else
                SumMatch = 0: maxDate = CDate("01.01.1900")
            End If
            rs.Close: Set rs = Nothing
        Else
            SumMatch = 0: maxDate = CDate("01.01.1900")
        End If
    Else
        SumMatch = 0: maxDate = CDate("01.01.1900")
    End If

NormalExit:
    Exit Function
ErrHandler:
    MsgBox Err.Description & vbCrLf & "Error number: " & Err.Number & vbCrLf & cstrTitle, vbExclamation, cstrTitle: Resume NormalExit
End Function
' возвращаем количество совпадений суммы с уже имеющимися суммами задолженностей в выгрузках. 07.02.2023. Окончание
' ***************************************************************************************************************************************************
' методы. Окончание
' ###################################################################################################################################################


