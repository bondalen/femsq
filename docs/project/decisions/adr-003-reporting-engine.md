# ADR 003: Выбор движка генерации отчётов

**Статус:** Принято  
**Дата:** 2025-11-21  
**Автор:** Александр  
**Связанные задачи:** task:0020 (создание модуля Reports)

---

## Контекст

Проекту FEMSQ (система работы с контрагентами и объектами при капитальном строительстве) требуется функциональность генерации PDF-отчётов со следующими требованиями:

### Функциональные требования
- Генерация отчётов на основе данных из MS SQL Server
- Поддержка сложных отчётов (таблицы, графики, подотчёты)
- Возможность создания новых отчётов без перекомпиляции приложения
- Динамические параметры отчётов (даты, фильтры, выборка данных)
- Экспорт в форматы: PDF (приоритет), Excel, HTML

### Нефункциональные требования
- Единый артефакт развёртывания (JAR файл)
- Возможность обновления шаблонов отчётов после развёртывания
- Open Source решение без коммерческих лицензий
- Интеграция с Spring Boot
- Прямая работа с MS SQL Server через JDBC

### Пользовательские сценарии
1. **Каталог отчётов:** Пользователь выбирает отчёт из списка, заполняет параметры, генерирует PDF
2. **Контекстная генерация:** Из карточки контрагента/объекта быстрая генерация с предзаполненными параметрами
3. **Разработка отчётов:** Разработчик создаёт новые отчёты в визуальном дизайнере, размещает в директории

---

## Рассмотренные варианты

### Вариант 1: JasperReports
**Описание:** Зрелый Open Source движок генерации отчётов с визуальным дизайнером

**Технологии:**
- Библиотека: JasperReports 6.21.0 (LGPL v3)
- Формат шаблонов: JRXML (XML-based)
- Дизайнер: Jaspersoft Studio Community Edition (Eclipse-based)
- Размер зависимостей: ~15 MB

**Плюсы:**
- ✅ **Мощный функционал:** Сложные макеты, подотчёты, графики, диаграммы
- ✅ **Визуальный дизайнер:** Jaspersoft Studio упрощает создание отчётов
- ✅ **Динамические шаблоны:** JRXML файлы в файловой системе, компиляция в runtime
- ✅ **Поддержка подотчётов:** Бесконечная вложенность (практически 2-3 уровня оптимально)
- ✅ **Прямая работа с JDBC:** Нативная поддержка MS SQL Server
- ✅ **Множество форматов экспорта:** PDF, Excel (XLS, XLSX), HTML, CSV, RTF
- ✅ **Open Source:** LGPL v3 лицензия, бесплатно для коммерческого использования
- ✅ **Зрелое решение:** 20+ лет разработки, большое сообщество
- ✅ **Spring Boot интеграция:** Легко интегрируется через стандартные механизмы

**Минусы:**
- ⚠️ **Размер:** +15 MB к размеру JAR файла
- ⚠️ **Сложность освоения:** Требуется изучение JRXML и Jaspersoft Studio
- ⚠️ **Производительность:** При сложных отчётах может быть медленным (оптимизируется кэшированием)

---

### Вариант 2: Thymeleaf + OpenPDF
**Описание:** HTML шаблоны Thymeleaf с конвертацией в PDF через OpenPDF

**Технологии:**
- Шаблонизатор: Thymeleaf (уже используется в проекте)
- PDF движок: OpenPDF 1.3.30 (LGPL/MPL)
- HTML→PDF: Flying Saucer 9.1.22
- Размер зависимостей: ~5 MB

**Плюсы:**
- ✅ **Простота:** HTML шаблоны знакомы веб-разработчикам
- ✅ **Thymeleaf уже в проекте:** Переиспользование существующих навыков
- ✅ **Компактность:** Меньший размер зависимостей
- ✅ **Open Source:** LGPL/MPL лицензии

**Минусы:**
- ❌ **Ограниченный функционал:** Сложные макеты трудно реализовать в HTML
- ❌ **Нет графиков:** Нужны внешние библиотеки (Chart.js + screenshot)
- ❌ **Нет визуального дизайнера:** Только код HTML
- ❌ **Подотчёты вручную:** Нет встроенной поддержки, нужна ручная реализация
- ❌ **Проблемы с CSS:** Flying Saucer не поддерживает современный CSS3
- ❌ **Excel экспорт сложен:** Нет стандартного механизма

---

### Вариант 3: Apache FOP
**Описание:** XML-FO (Formatting Objects) движок генерации PDF

**Технологии:**
- Библиотека: Apache FOP 2.9
- Формат шаблонов: XSL-FO (XML)
- Размер зависимостей: ~10 MB

**Плюсы:**
- ✅ **Строгая типизация:** XML-схемы обеспечивают валидацию
- ✅ **Мощная вёрстка:** Поддержка сложных многоколоночных макетов
- ✅ **Open Source:** Apache License 2.0
- ✅ **Поддержка PostScript, PCL:** Дополнительные форматы

**Минусы:**
- ❌ **Высокая сложность:** XSL-FO синтаксис сложнее JRXML
- ❌ **Нет визуального дизайнера:** Только ручное кодирование XML
- ❌ **Меньшее сообщество:** Менее популярен чем JasperReports
- ❌ **Графики сложны:** Требуется ручная генерация SVG
- ❌ **Excel экспорт:** Нет встроенной поддержки

---

## Решение

**Выбран вариант 1: JasperReports** как основной движок генерации отчётов для проекта FEMSQ.

---

## Обоснование

### Критерии выбора (взвешенная оценка)

| Критерий | Вес | JasperReports | Thymeleaf+OpenPDF | Apache FOP |
|----------|-----|---------------|-------------------|------------|
| Функциональность | 25% | 10/10 | 6/10 | 8/10 |
| Простота разработки | 20% | 8/10 | 9/10 | 4/10 |
| Визуальный дизайнер | 15% | 10/10 | 0/10 | 0/10 |
| Поддержка форматов | 15% | 10/10 | 6/10 | 7/10 |
| Размер зависимостей | 10% | 6/10 | 10/10 | 8/10 |
| Сообщество/документация | 10% | 10/10 | 8/10 | 6/10 |
| Производительность | 5% | 7/10 | 8/10 | 8/10 |
| **Итоговая оценка** | **100%** | **9.0** | **6.7** | **6.2** |

### Ключевые факторы решения

1. **Мощность функционала:** Требования проекта включают сложные отчёты с подотчётами, графиками, диаграммами. JasperReports предоставляет всё это из коробки.

2. **Визуальный дизайнер:** Jaspersoft Studio значительно ускоряет разработку отчётов. Разработчик видит результат в реальном времени.

3. **Динамические шаблоны:** JRXML файлы можно размещать в файловой системе и компилировать в runtime. Это позволяет обновлять отчёты без перезапуска приложения.

4. **Баланс сложности:** Хотя JasperReports сложнее чем Thymeleaf, визуальный дизайнер компенсирует эту сложность. Apache FOP ещё сложнее без дизайнера.

5. **Поддержка форматов:** Нативный экспорт в PDF, Excel, HTML без дополнительных библиотек.

6. **Зрелость решения:** 20+ лет активной разработки, огромное сообщество, множество примеров и решений проблем.

7. **Размер приемлем:** +15 MB к JAR-файлу приемлемо для enterprise-приложения, учитывая получаемый функционал.

---

## Архитектурный подход

### Принцип развёртывания

**Разделение ответственности:**
- **JAR файл:** Содержит только библиотеки JasperReports + базовые встроенные отчёты (fallback)
- **Файловая система:** Шаблоны отчётов в директории `./reports/` (приоритет над встроенными)
- **Разработка:** Внешний инструмент Jaspersoft Studio (не встраивается в приложение)

### Структура файловой системы

```
application.jar                          # Компактный JAR (~80-100 MB)
└── resources/reports/embedded/          # Встроенные базовые отчёты (fallback)
    ├── contractor-card.jrxml
    ├── objects-list.jrxml
    └── metadata.json

Рабочая директория (runtime):
./reports/                               # Внешние отчёты (приоритет)
├── custom/                              # Пользовательские отчёты
│   ├── quarterly-report.jrxml
│   ├── quarterly-report.jasper          # Прекомпилированный (опционально)
│   └── quarterly-report.json            # Метаданные
├── templates/                           # Библиотека шаблонов организации
│   ├── annual-summary.jrxml
│   └── annual-summary.json
└── assets/                              # Ресурсы (логотипы, шрифты)
    ├── logo.png
    └── fonts/custom-font.ttf
```

### Обнаружение и загрузка отчётов

**Hot-reload механизм:**
1. При старте приложения сканируем `./reports/custom/` и `./reports/templates/`
2. Загружаем метаданные из JSON файлов
3. @Scheduled задача пересканирует директории каждую минуту
4. При обнаружении изменений обновляем кэш
5. Если внешний отчёт не найден → используем встроенный из JAR

**Преимущества:**
- ✅ Компактный JAR файл
- ✅ Обновление отчётов без перезапуска
- ✅ Независимая разработка отчётов
- ✅ Fallback на встроенные отчёты

### Метаданные отчётов

Каждый отчёт сопровождается JSON файлом с метаданными:

```json
{
  "report": {
    "id": "quarterly-report",
    "name": "Квартальный отчёт",
    "parameters": [
      {
        "name": "START_DATE",
        "type": "date",
        "label": "Дата начала",
        "required": true
      }
    ],
    "uiIntegration": {
      "contextMenus": [
        {
          "component": "ContractorCard",
          "parameterMapping": {
            "CONTRACTOR_ID": "${contractor.id}"
          }
        }
      ]
    }
  }
}
```

**Возможности:**
- Описание параметров (типы, валидация, значения по умолчанию)
- Интеграция с UI компонентами
- Категоризация и теги
- Контроль доступа

---

## Последствия

### Положительные

1. **Профессиональные возможности:** Команда получает мощный инструмент для создания сложных отчётов

2. **Быстрая разработка:** Визуальный дизайнер Jaspersoft Studio ускоряет создание отчётов

3. **Гибкость:** Отчёты можно добавлять и изменять без перекомпиляции приложения

4. **Поддержка форматов:** PDF, Excel, HTML из коробки

5. **Масштабируемость:** Поддержка подотчётов позволяет создавать отчёты любой сложности

6. **Hot-reload:** Изменения отчётов видны через минуту после обновления файла

### Отрицательные

1. **Размер артефакта:** JAR файл увеличится на ~15 MB (с 60-70 MB до 80-100 MB)

2. **Кривая обучения:** Разработчикам потребуется изучить:
   - Jaspersoft Studio
   - JRXML синтаксис
   - Концепции Bands, Parameters, Variables

3. **Дополнительный инструмент:** Необходимо устанавливать Jaspersoft Studio на машины разработчиков

4. **Производительность:** Сложные отчёты могут генерироваться 5-10 секунд (митигация: кэширование, фоновая генерация)

5. **Версионирование:** Изменения в структуре БД могут сломать существующие отчёты (митигация: версионирование шаблонов в Git, тестирование)

### Нейтральные

1. **Отдельный workflow:** Разработка отчётов становится отдельным процессом от разработки кода

2. **Документация:** Требуется создать руководство по разработке отчётов для команды

3. **Поддержка:** Необходимо обеспечить базу знаний по частым проблемам JasperReports

---

## Альтернативные сценарии

### Если JasperReports не подойдёт

**Сценарий 1:** Производительность неприемлема
- **Решение:** Предкомпиляция JRXML → JASPER на этапе CI/CD
- **Решение:** Фоновая генерация с уведомлениями

**Сценарий 2:** Сложность освоения слишком высока
- **Решение:** Создать библиотеку готовых шаблонов
- **Решение:** Видео-туториалы для команды
- **Fallback:** Рассмотреть Thymeleaf+OpenPDF для простых табличных отчётов

**Сценарий 3:** Размер JAR критичен
- **Решение:** Выделить отчёты в отдельный микросервис
- **Решение:** Использовать JasperReports Server (отдельное развёртывание)

---

## Связанные решения

- **ADR 001:** Выбор технологического стека (Spring Boot + Vue.js)
- **ADR 002:** Архитектура базы данных (MS SQL Server)
- **Будущее ADR:** Микросервисная архитектура (если потребуется)

---

## Ссылки

### Документация
- [JasperReports Documentation](https://community.jaspersoft.com/documentation)
- [Jaspersoft Studio User Guide](https://community.jaspersoft.com/wiki/jaspersoft-studio-user-guide)
- [JasperReports Library API](https://jasperreports.sourceforge.net/api/)

### Примеры
- [JasperReports Samples](https://github.com/TIBCOSoftware/jasperreports-samples)
- [Spring Boot + JasperReports](https://github.com/TIBCOSoftware/jrs-rest-java-client)

### Лицензия
- [LGPL v3 License](https://www.gnu.org/licenses/lgpl-3.0.en.html)

---

**Дата утверждения:** 2025-11-21  
**Утверждено:** Александр  
**Следующий пересмотр:** 2026-02-21 (через 3 месяца после начала использования)
